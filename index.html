<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Producción v5.1</title>
    
    <script src="https://cdn.tailwindcss.com?_VERSION=3.4.1"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* Clases de Badges (definidas en app.js) */
        .badge { @apply px-2 py-0.5 rounded-full text-xs font-medium; }
        .badge-art { @apply bg-blue-100 text-blue-800; }
        .badge-entry { @apply bg-gray-100 text-gray-800; }
        .badge-printing { @apply bg-indigo-100 text-indigo-800; }
        .badge-press { @apply bg-purple-100 text-purple-800; }
        .badge-cut { @apply bg-pink-100 text-pink-800; }
        .badge-sew { @apply bg-cyan-100 text-cyan-800; }
        .badge-packing { @apply bg-teal-100 text-teal-800; }
        .badge-shipping { @apply bg-green-100 text-green-800; }
        .badge-default { @apply bg-gray-100 text-gray-700; }
        
        /* Badges de Estado (definidos en app.js) */
        .badge-bandeja { @apply bg-amber-100 text-amber-800; }
        .badge-produccion { @apply bg-purple-100 text-purple-800; }
        .badge-auditoria { @apply bg-blue-100 text-blue-800; }
        .badge-completada { @apply bg-green-100 text-green-800; }
        
        /* Estilos de Modales */
        .modal, .full-modal-view {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }
        .modal.active, .full-modal-view.active { display: flex; }
        .modal-content {
            @apply bg-gray-100 rounded-lg shadow-xl w-full;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .full-modal-view .modal-content {
            max-width: 95vw;
            width: 95vw;
            height: 95vh;
            max-height: 95vh;
        }
        .modal-body { overflow-y: auto; }
        body.modal-open { overflow: hidden; }

        /* Estilos de Tabla */
        .table-cell { @apply px-4 py-3 text-sm text-gray-700 whitespace-nowrap; }
        .table-header { @apply px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider; }
        tr.selected-row { @apply bg-blue-100; }

        /* Overlay de Carga */
        .loading-overlay {
            position: fixed;
            z-index: 100;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        .loading-overlay p { @apply text-lg font-medium text-gray-800 mt-4; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Botón de Paginación */
        .pagination-btn { @apply mx-1 px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50; }
        .pagination-btn.active { @apply bg-blue-500 text-white border-blue-500; }
        .pagination-btn.disabled { @apply opacity-50 cursor-not-allowed; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="customAlert" style="display: none;" class="fixed top-5 right-5 z-[101] max-w-md shadow-lg"></div>


    <section id="loginSection" class="flex items-center justify-center min-h-screen">
        <div class="p-8 bg-white rounded-lg shadow-md text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Panel de Producción</h1>
            <button id="loginButton" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12	s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20	s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#e53935" d="M6.306,14.691l6.012,4.631C12.63,15.141,12.962,12.99,13.656,11l-5.657-5.657C6.801,6.669,6,8.258,6,10	C6,11.956,6.195,13.805,6.306,14.691z"/><path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-4.79C29.211,35.091,26.715,36,24,36	c-5.202,0-9.619-3.317-11.283-7.946l-6.012,4.631C8.718,38.632,15.81,44,24,44z"/><path fill="#1565c0" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571	c0.001-0.001,0.002-0.001,0.003-0.002l6.19,4.79c-3.51,3.226-8.243,5.192-13.409,5.192c-8.19,0-15.282-5.368-18.194-12.831	l6.012-4.631C9.619,20.317,14.002,24,20,24c2.671,0,5.127-0.912,7.039-2.498l5.657,5.657C34.046,29.947,29.268,32,24,32	c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4	C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Iniciar sesión con Google
            </button>
        </div>
    </section>

    <section id="uploadSection" class="min-h-screen p-8" style="display: none;">
        <div class="max-w-7xl mx-auto py-4 flex justify-between items-center">
            <h2 class="text-2xl font-semibold text-gray-800">Panel de Producción</h2>
            <div>
                <span id="userName" class="mr-4 font-medium text-gray-700"></span>
                <button id="logoutButton" class="text-sm font-medium text-blue-600 hover:text-blue-800">Cerrar sesión</button>
            </div>
        </div>
        <div class="flex items-center justify-center mt-10">
            <div class="w-full max-w-lg">
                <div id="dropZone" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h.586a1 1 0 01.707.293l.828.828A1 1 0 009.828 4H14.172a1 1 0 00.707-.293l.828-.828A1 1 0 0116.414 3H17a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Haz clic para subir</span> o arrastra y suelta</p>
                        <p class="text-xs text-gray-500">Solo archivos .XLSX o .XLS</p>
                    </div>
                    <input id="fileInput" type="file" class="hidden" accept=".xlsx, .xls">
                </div>
                <p id="fileName" class="mt-2 text-sm text-gray-600 font-medium"></p>
            </div>
        </div>
    </section>

    <main id="dashboard" class="p-4 md:p-8" style="display: none;">
        
        <nav class="flex flex-wrap justify-between items-center pb-4 mb-4 border-b border-gray-300">
            <div class="flex items-center">
                <h1 class="text-3xl font-bold text-gray-900">Panel de Producción</h1>
                <span id="dbStatus" class="ml-3 font-medium text-yellow-600">● Conectando...</span>
            </div>
            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                <button onclick="openCompareModal()" class="text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-md shadow-sm">Comparar</button>
                <button onclick="openDesignerManager()" class="text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 px-3 py-2 rounded-md shadow-sm">Administrar Diseñadores</button>
                <span id="userName" class="hidden md:inline-block ml-4 font-medium text-gray-700"></span>
                <button id="logoutButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 px-3 py-2">Cerrar sesión</button>
            </div>
        </nav>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Total Órdenes</h3>
                <p id="summaryTotal" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Total P_Art</h3>
                <p id="summaryPArt" class="mt-1 text-3xl font-semibold text-blue-600">0</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-amber-500 truncate">En Bandeja</h3>
                <p id="summaryBandeja" class="mt-1 text-3xl font-semibold text-amber-600">0</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-purple-500 truncate">En Producción</h3>
                <p id="summaryProduccion" class="mt-1 text-3xl font-semibold text-purple-600">0</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-blue-500 truncate">En Auditoría</h3>
                <p id="summaryAuditoria" class="mt-1 text-3xl font-semibold text-blue-500">0</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-medium text-red-500 truncate">Atrasadas</h3>
                <p id="summaryAtrasadas" class="mt-1 text-3xl font-semibold text-red-600">0</p>
            </div>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-6">

            <div class="flex-grow w-full lg:w-3/4">

                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div class="col-span-1 md:col-span-3 lg:col-span-2">
                            <label for="searchInput" class="block text-sm font-medium text-gray-700">Buscar (Código, Cliente, Estilo)</label>
                            <input type="text" id="searchInput" placeholder="Escribe para buscar..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="clientFilter" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <select id="clientFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="styleFilter" class="block text-sm font-medium text-gray-700">Estilo</label>
                            <select id="styleFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="teamFilter" class="block text-sm font-medium text-gray-700">Team</label>
                            <select id="teamFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="departamentoFilter" class="block text-sm font-medium text-gray-700">Departamento</label>
                            <select id="departamentoFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="designerFilter" class="block text-sm font-medium text-gray-700">Diseñador</label>
                            <select id="designerFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="customStatusFilter" class="block text-sm font-medium text-gray-700">Estado P_Art</label>
                            <select id="customStatusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="">Todos</option>
                                <option value="Bandeja">Bandeja</option>
                                <option value="Producción">Producción</option>
                                <option value="Auditoría">Auditoría</option>
                                <option value="Completada">Completada</option>
                            </select>
                        </div>
                        <div>
                            <label for="dateFrom" class="block text-sm font-medium text-gray-700">Fecha Desde</label>
                            <input type="date" id="dateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="dateTo" class="block text-sm font-medium text-gray-700">Fecha Hasta</label>
                            <input type="date" id="dateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <div id="selectionBar" class="hidden fixed bottom-0 left-0 w-full bg-blue-600 text-white p-4 shadow-lg z-40 flex justify-between items-center">
                    <div>
                        <span id="selectionCount" class="font-medium">0 órdenes seleccionadas</span>
                        <button onclick="clearSelection()" class="ml-4 text-sm font-medium text-blue-100 hover:text-white">Limpiar</button>
                    </div>
                    <div>
                        <button onclick="openMultiAssignModal()" class="px-4 py-2 bg-white text-blue-600 font-medium rounded-md shadow-sm hover:bg-blue-50">Asignar en Masa</button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="table-header w-12">
                                        <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)" class="form-checkbox">
                                    </th>
                                    <th class="table-header">Fecha</th>
                                    <th class="table-header">Cliente</th>
                                    <th class="table-header">Código</th>
                                    <th class="table-header">Estilo</th>
                                    <th class="table-header">Team</th>
                                    <th class="table-header">Depto</th>
                                    <th class="table-header">Estado P_Art</th>
                                    <th class="table-header">Diseñador</th>
                                    <th class="table-header text-right">Piezas</th>
                                    <th class="table-header text-right">P. Hijas</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="11" class="text-center text-gray-500 py-10">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-4">
                    <div id="tableSummary" class="text-sm text-gray-700"></div>
                    <div id="paginationControls" class="flex"></div>
                </div>
            </div>

            <aside class="w-full lg:w-1/4">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sticky top-4">
                    <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Carga de Trabajo (P_Art)</h3>
                    <div id="metricsSidebarList" class="space-y-3 max-h-[80vh] overflow-y-auto">
                        </div>
                </div>
            </aside>

        </div>
    </main>

    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center rounded-t-lg">
                <h2 class="text-lg font-semibold text-gray-900">Detalles de la Orden</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-4 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50">
                <div class="md:col-span-2 space-y-6">
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-3">Información</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                            <div>
                                <label class="block text-gray-500">Cliente</label>
                                <strong id="detailCliente" class="block text-gray-900"></strong>
                            </div>
                            <div>
                                <label class="block text-gray-500">Código</label>
                                <strong id="detailCodigo" class="block text-gray-900"></strong>
                            </div>
                            <div>
                                <label class="block text-gray-500">Estilo</label>
                                <strong id="detailEstilo" class="block text-gray-900"></strong>
                            </div>
                            <div>
                                <label class="block text-gray-500">Departamento</label>
                                <strong id="detailDepartamento" class="block text-gray-900"></strong>
                            </div>
                            <div>
                                <label class="block text-gray-500">Fecha Despacho</label>
                                <strong id="detailFecha" class="block text-gray-900"></strong>
                            </div>
                            <div>
                                <label class="block text-gray-500">Piezas</label>
                                <strong id="detailPiezas" class="block text-gray-900"></strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-3">Asignación (P_Art)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="modalDesigner" class="block text-sm font-medium text-gray-700">Diseñador</label>
                                <select id="modalDesigner" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                            </div>
                            <div>
                                <label for="modalStatus" class="block text-sm font-medium text-gray-700">Estado</label>
                                <select id="modalStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">Sin estado</option>
                                    <option value="Bandeja">Bandeja</option>
                                    <option value="Producción">Producción</option>
                                    <option value="Auditoría">Auditoría</option>
                                    <option value="Completada">Completada</option>
                                </select>
                            </div>
                            <div>
                                <label for="modalReceivedDate" class="block text-sm font-medium text-gray-700">Recibida</label>
                                <input type="date" id="modalReceivedDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="modalNotes" class="block text-sm font-medium text-gray-700">Notas</label>
                            <textarea id="modalNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-gray-800">Órdenes Hijas (<span id="childOrderCount">0</span>)</h3>
                            <button id="addChildOrderBtn" onclick="openAddChildModal()" class="px-3 py-1 bg-blue-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-600">Agregar</button>
                        </div>
                        <div id="childOrdersList" class="space-y-2 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded">
                            </div>
                    </div>
                </div>
                
                <div class="md:col-span-1 space-y-4">
                    <h3 class="font-semibold text-gray-800">Historial de Cambios</h3>
                    <div id="modalHistory" class="space-y-3 max-h-[65vh] overflow-y-auto bg-gray-100 p-2 rounded-lg">
                        </div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-gray-200 flex justify-between rounded-b-lg">
                <button onclick="asignarmeAmi()" class="px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200">Asignarme a mí</button>
                <div>
                    <button onclick="closeModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50 mr-2">Cancelar</button>
                    <button onclick="saveAssignment()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="multiAssignModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Asignación Múltiple (<span id="multiModalCount">0</span>)</h2>
                <button onclick="closeMultiModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div id="selectedOrdersList" class="max-h-40 overflow-y-auto bg-gray-100 border p-3 rounded-md space-y-2">
                    </div>
                <p class="text-sm text-gray-600">Solo se aplicarán los campos que llenes. Deja un campo vacío para no modificarlo.</p>
                <div>
                    <label for="multiModalDesigner" class="block text-sm font-medium text-gray-700">Diseñador</label>
                    <select id="multiModalDesigner" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                </div>
                <div>
                    <label for="multiModalStatus" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="multiModalStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">-- No Cambiar --</option>
                        <option value="Bandeja">Bandeja</option>
                        <option value="Producción">Producción</option>
                        <option value="Auditoría">Auditoría</option>
                        <option value="Completada">Completada</option>
                    </select>
                </div>
                <div>
                    <label for="multiModalReceivedDate" class="block text-sm font-medium text-gray-700">Fecha Recibida</label>
                    <input type="date" id="multiModalReceivedDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="multiModalNotes" class="block text-sm font-medium text-gray-700">Notas (sobrescribirá las existentes)</label>
                    <textarea id="multiModalNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button onclick="closeMultiModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50 mr-2">Cancelar</button>
                <button onclick="saveMultiAssignment()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <div id="addChildModal" class="modal z-[51]"> <div class="modal-content max-w-md">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Agregar Orden Hija</h2>
                <button onclick="closeAddChildModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500">Orden Padre</label>
                    <p id="parentOrderInfo" class="text-gray-800 font-medium"></p>
                </div>
                <div>
                    <label for="childOrderNumber" class="block text-sm font-medium text-gray-700">Número de Hija (ej: 1, 2, A, B)</label>
                    <input type="text" id="childOrderNumber" oninput="updateChildOrderCode()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                 <div>
                    <label for="childOrderCode" class="block text-sm font-medium text-gray-700">Código Resultante</label>
                    <input type="text" id="childOrderCode" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                </div>
                <div>
                    <label for="childPieces" class="block text-sm font-medium text-gray-700">Cantidad de Piezas</label>
                    <input type="number" id="childPieces" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="childDeliveryDate" class="block text-sm font-medium text-gray-700">Fecha de Despacho (opcional)</label>
                    <input type="date" id="childDeliveryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="childNotes" class="block text-sm font-medium text-gray-700">Notas (opcional)</label>
                    <textarea id="childNotes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button onclick="closeAddChildModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50 mr-2">Cancelar</button>
                <button onclick="saveChildOrder()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700">Guardar Hija</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal z-[52]">
        <div class="modal-content max-w-sm">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900">Confirmación</h3>
                <p id="confirmModalMessage" class="mt-2 text-sm text-gray-600 whitespace-pre-wrap">¿Estás seguro?</p>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50 mr-2">Cancelar</button>
                <button id="confirmModalConfirm" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="designerManagerModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Administrar Diseñadores</h2>
                <button onclick="closeDesignerManager()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div>
                    <label for="newDesignerName" class="block text-sm font-medium text-gray-700">Nuevo Diseñador</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="newDesignerName" class="block w-full rounded-l-md border-gray-300">
                        <button onclick="addDesigner()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-r-md border border-blue-600 hover:bg-blue-700">Agregar</button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-md font-medium text-gray-800 mb-2">Lista Actual</h3>
                    <div id="designerManagerList" class="space-y-2 max-h-60 overflow-y-auto bg-gray-100 p-2 rounded">
                        </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button onclick="closeDesignerManager()" class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="compareModal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Comparar Diseñadores</h2>
                <button onclick="closeCompareModals()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="compareDesigner1" class="block text-sm font-medium text-gray-700">Diseñador 1</label>
                        <select id="compareDesigner1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                     <div>
                        <label for="compareDesigner2" class="block text-sm font-medium text-gray-700">Diseñador 2</label>
                        <select id="compareDesigner2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <button onclick="generateCompareChart()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 w-full md:w-auto">Generar</button>
                </div>
                <div id="compareChartContainer" class="mt-4" style="display: none;">
                    <div class="relative h-72">
                        <canvas id="compareChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="metricsView" class="full-modal-view">
        <div class="modal-content">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Métricas: <span id="designerMetricsName" class="text-blue-600"></span></h2>
                <button onclick="hideMetricsView()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="modal-body p-6 bg-gray-50">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-gray-500">Total Activas</h3><p id="designerStatTotal" class="text-2xl font-bold text-gray-800">0</p></div>
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-amber-500">Bandeja</h3><p id="designerStatBandeja" class="text-2xl font-bold text-amber-600">0</p></div>
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-purple-500">Producción</h3><p id="designerStatProduccion" class="text-2xl font-bold text-purple-600">0</p></div>
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-blue-500">Auditoría</h3><p id="designerStatAuditoria" class="text-2xl font-bold text-blue-500">0</p></div>
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-green-500">Completadas</h3><p id="designerStatCompletadas" class="text-2xl font-bold text-green-600">0</p></div>
                    <div class="bg-white p-3 rounded-lg border shadow-sm"><h3 class="text-sm text-gray-500">Total Piezas</h3><p id="designerStatPiezas" class="text-2xl font-bold text-gray-800">0</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-4 rounded-lg border shadow-sm lg:col-span-1"><h3 class="font-medium text-center mb-2">Estado de Carga Activa</h3><div class="relative h-64"><canvas id="designerDoughnutChart"></canvas></div></div>
                    <div class="bg-white p-4 rounded-lg border shadow-sm lg:col-span-2"><h3 class="font-medium text-center mb-2">Top 10 Clientes (Por Piezas)</h3><div class="relative h-64"><canvas id="designerBarChart"></canvas></div></div>
                </div>
                <div class="bg-white p-4 rounded-lg border shadow-sm mb-6"><h3 class="font-medium text-center mb-2">Actividad (Completadas últ. 30 días)</h3><div class="relative h-64"><canvas id="designerActivityChart"></canvas></div></div>
                
                <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="table-header">Código</th>
                                <th class="table-header">Cliente</th>
                                <th class="table-header">Estilo</th>
                                <th class="table-header">Fecha</th>
                                <th class="table-header">Estado</th>
                                <th class="table-header text-right">Piezas</th>
                            </tr>
                        </thead>
                        <tbody id="designerMetricsTableBody" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
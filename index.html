<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Arte v5.0 (Cloud)</title>
    
    <!-- LIBRER√çAS ORIGINALES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ====================================================== -->
    <!-- ===== NUEVO: SDKs de FIREBASE (Paso 2) ===== -->
    <!-- ====================================================== -->
    <!-- Usamos las versiones "compat" para que la migraci√≥n desde JS 
         tradicional sea m√°s sencilla y no requiera 'imports' -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- ====================================================== -->
    <!-- ===== NUEVO: Configuraci√≥n de FIREBASE (Paso 2) ===== -->
    <!-- ====================================================== -->
    <script>
      // Tu configuraci√≥n de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAX9jZYnVSGaXdM06I0LTBvbvDpNulMPpk",
        authDomain: "panel-arte.firebaseapp.com",
        projectId: "panel-arte",
        storageBucket: "panel-arte.firebasestorage.app",
        messagingSenderId: "236381043860",
        appId: "1:236381043860:web:f6a9c2cb211dd9161d0881"
      };

      // Inicializa Firebase
      firebase.initializeApp(firebaseConfig);
    </script>

    <!-- Configuraci√≥n de Tailwind (Original) -->
    <script>
      // Configuraci√≥n de Tailwind para usar la fuente Inter
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              // Colores personalizados para los gr√°ficos (tomados del CSS original)
              'chart-bandeja': '#F59E0B',
              'chart-produccion': '#8B5CF6',
              'chart-auditoria': '#3B82F6',
              'chart-sin-estado': '#6B7280',
            }
          },
        },
      }
    </script>
<!-- ... (Esto es la continuaci√≥n de la Parte 1) ... -->
</head>
<body class="bg-gray-100 font-sans text-gray-900">

    <!-- ====================================================== -->
    <!-- ===== NUEVO: Pantalla de Login (Paso 2) ===== -->
    <!-- ====================================================== -->
    <div id="loginSection" class="max-w-md mx-auto my-20 bg-white rounded-lg shadow-xl p-8 text-center">
        <svg class="w-16 h-16 mx-auto text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.333-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Panel de Control - Arte v5.0 (Cloud)</h1>
        <p class="text-gray-600 mb-8">Por favor, inicia sesi√≥n con tu cuenta de Google para continuar.</p>
        <button id="loginButton" class="w-full inline-flex justify-center items-center gap-3 bg-blue-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-sm cursor-pointer">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#fff" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.23l-2.7 2.7C28.77 13.93 26.48 13 24 13c-5.48 0-10.13 3.82-11.62 8.96h-0.09l-3.32-0.01L8.9 18.01C11.39 12.82 17.21 9.5 24 9.5z"></path><path fill="#fff" d="M46.16 25.13c0-1.6-0.12-3.13-0.34-4.63H24v8.69h12.44c-0.56 2.78-2.17 5.17-4.65 6.78v5.69h7.3c4.27-3.92 6.77-9.8 6.77-16.53z"></path><path fill="#fff" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.3-5.69c-2.15 1.45-4.92 2.3-8.59 2.3-6.6 0-12.23-4.43-14.26-10.42h-0.09l-7.1 0.01L2.4 30.01C5.16 38.64 13.8 44.5 24 44.5z"></path><path fill="#fff" d="M10.13 29.21c-0.6-1.8-0.94-3.7-0.94-5.71s0.34-3.91 0.94-5.71l-0.01-0.1L2.4 11.96H2.3C1.69 13.43 1.22 15.15 1.22 17c0 1.85 0.47 3.57 1.08 5.16L10.13 29.21z"></path></svg>
            Iniciar Sesi√≥n con Google
        </button>
    </div>

    <!-- ====================================================== -->
    <!-- ===== SECCI√ìN DE CARGA (Ahora oculta) (Paso 2) ===== -->
    <!-- ====================================================== -->
    <div id="uploadSection" class="max-w-3xl mx-auto my-12 bg-white rounded-lg shadow-xl p-8 text-center" style="display: none;">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Paso 2: Cargar Archivo Excel</h1>
        <p class="text-gray-600 mb-8">Sube tu archivo Excel "Working Process All" para sincronizar.</p>
        
        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 cursor-pointer bg-gray-50 hover:bg-gray-100 hover:border-blue-500 transition-colors">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Arrastra tu archivo aqu√≠</h3>
            <p class="text-sm text-gray-500 mb-4">o</p>
            <label for="fileInput">
                <span class="mt-4 inline-block bg-indigo-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm cursor-pointer">
                    Seleccionar Archivo
                </span>
            </label>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>
        
        <div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6 text-left">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">‚ú® Caracter√≠sticas v5.0 (Cloud)</h4>
            <ul class="text-sm text-gray-600 list-disc list-inside space-y-2">
                <li><span class="mr-2">‚òÅÔ∏è</span> **NUEVO: Base de Datos en la Nube (Firebase).**</li>
                <li><span class="mr-2">üë§</span> **NUEVO: Inicio de Sesi√≥n con Google.**</li>
                <li><span class="mr-2">‚ö°</span> **NUEVO: Sincronizaci√≥n de datos en tiempo real.**</li>
                <li><span class="mr-2">üôã</span> **NUEVO: Bot√≥n "Asignarme a m√≠" (Autom√°tico).**</li>
                <li><span class="mr-2">üóëÔ∏è</span> **ELIMINADO: Importar/Exportar BD (Obsoleto).**</li>
            </ul>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Zona de Migraci√≥n (Usar solo una vez)</h4>
            <p class="text-xs text-gray-400 mb-4">Si tienes un respaldo .json de la versi√≥n anterior, c√°rgalo aqu√≠ para subirlo a la nube.</p>
            
            <input type="file" id="backupInput" accept=".json" style="display: none;" onchange="procesarRespaldoAntiguo(this)">
            
            <button onclick="document.getElementById('backupInput').click()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none cursor-pointer">
                <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Subir Respaldo Antiguo (.json)
            </button>
        </div>
    </div>
        
        <!-- ====================================================== -->
        <!-- ===== CABECERA (Paso 2 - Botones Modificados) ===== -->
        <!-- ====================================================== -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Panel de Control - Arte v5.0 (Cloud)</h1>
                <p class="text-sm text-gray-500 mt-1">
    <span id="fileName"></span>

    <span id="dbStatus" class="ml-3 font-medium text-gray-500">Conectando a Firebase...</span>

    <span class="ml-3">
        Hola, <span id="userName" class="font-bold text-gray-900">Usuario</span>
    </span>

    <button id="logoutButton" class="ml-4 text-xs font-medium text-red-600 hover:text-red-800 underline cursor-pointer">
        (Cerrar Sesi√≥n)
    </button>
</p>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="openDesignerManager()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A9.065 9.065 0 0 1 12 15v2.25m0-2.25h.008c.005 0 .009 0 .013.002l.008.002c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.07.017.14.03.21.041a1.904 1.904 0 0 1 .84 1.511l.044.283.008.057c.004.03.005.059.008.087l.002.018c.002.01.003.02.005.03l.001.005c.001.002.002.004.002.006a.7.7 0 0 1-.004.01l-.004.008a.618.618 0 0 1-.005.01l-.004.008-.005.008-.004.008a.168.168 0 0 1-.005.008l-.004.008-.005.008-.004.008A.168.168 0 0 1 15 17.25m-3-3v-3.03l3.03-3.03A1.5 1.5 0 0 0 13.5 9.697V6.75a1.5 1.5 0 0 0-3 0v2.947A1.5 1.5 0 0 0 9 11.197L6 14.227v3.03M12 12.75H9M15 12.75H9" />
                    </svg>
                    Gestionar Dise√±adores
                </button>
                
                <!-- ===== BOTONES IMPORTAR/EXPORTAR ELIMINADOS (Paso 2) ===== -->
                
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="openWeeklyReportModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5M11.25 3.75h7.5m-7.5 0a1.125 1.125 0 0 1-1.125-1.125M11.25 3.75v15M18.75 3.75v15m-1.125-15a1.125 1.125 0 0 0-1.125-1.125m1.125 1.125v15m0 0a1.125 1.125 0 0 1 1.125 1.125m-1.125-1.125h-7.5" />
                    </svg>
                    Reporte Semanal
                </button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="showMetricsView()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 16.5 19.875V3.375Z" />
                    </svg>
                    M√©tricas por Dise√±ador
                </button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="showDepartmentMetrics()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
                    </svg>
                    M√©tricas del Depto.
                </button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="showWorkPlanView()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-18 0h18" />
                    </svg>
                    Plan Semanal
                </button>
                
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="resetApp()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0 0v-4.992m0 0h-4.992" />
                    </svg>
                    Sincronizar Excel
                </button>
            </div>
        </div>

        <div id="customAlert" style="display: none;"></div>
        
        <div id="summaryBox" class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-blue-600">
            <!-- El contenido se genera por JS -->
        </div>
        
        <div id="alerts">
            <!-- El contenido se genera por JS -->
        </div>
        
        <!-- ====================================================== -->
        <!-- ===== SECCI√ìN DE ESTAD√çSTICAS (Original) ===== -->
        <!-- ====================================================== -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-6">
            
            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Total en P_Art</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statTotal">0</div>
                </div>
                <div class="bg-blue-100 text-blue-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 7h14"></path></svg>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Total Cantidad</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statTotalPieces">0</div>
                </div>
                <div class="bg-purple-100 text-purple-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Atrasadas</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statLate">0</div>
                </div>
                <div class="bg-red-100 text-red-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Por Vencer</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statExpiring">0</div>
                </div>
                <div class="bg-yellow-100 text-yellow-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">A Tiempo</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statOnTime">0</div>
                </div>
                <div class="bg-green-100 text-green-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase">Esta Semana</h3>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="statThisWeek">0</div>
                </div>
                <div class="bg-orange-100 text-orange-600 rounded-full p-3 flex-shrink-0">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
            </div>
        </div>
        <!-- ... (Esto es la continuaci√≥n de la Parte 3) ... -->

        <!-- ====================================================== -->
        <!-- ===== SECCI√ìN DE REPORTES (Original) ===== -->
        <!-- ====================================================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            
            <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Clientes (√ìrdenes Activas)</h3>
                <div class="max-h-60 overflow-y-auto" id="clientReport">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>

            <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <h3 class="text-lg font-semibold text-gray-900">Carga de Trabajo por Dise√±ador</h3>
                    <span class="text-sm text-gray-500 font-medium" id="workloadTotal">0 piezas (en P_Art)</span>
                </div>
                <div id="workloadList" class="space-y-4">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- ===== SECCI√ìN DE FILTROS (Original) ===== -->
        <!-- ====================================================== -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">B√∫squeda y Filtros</h3>
            
            <div class="mb-6">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar (Ctrl+F)</label>
                <div class="relative">
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                    </div>
                    <input type="text" id="searchInput" placeholder="Buscar cliente, c√≥digo, estilo, team, departamento, dise√±ador, estado, notas..."
                           class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                
                <div class="filter-item">
                    <label for="clientFilter" class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                    <div class="relative mt-1">
                        <select id="clientFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="styleFilter" class="block text-sm font-medium text-gray-700 mb-1">Estilo:</label>
                    <div class="relative mt-1">
                        <select id="styleFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="teamFilter" class="block text-sm font-medium text-gray-700 mb-1">Team:</label>
                    <div class="relative mt-1">
                        <select id="teamFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A9.065 9.065 0 0 1 12 15v2.25m0-2.25h.008c.005 0 .009 0 .013.002l.008.002c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.07.017.14.03.21.041a1.904 1.904 0 0 1 .84 1.511l.044.283.008.057c.004.03.005.059.008.087l.002.018c.002.01.003.02.005.03l.001.005c.001.002.002.004.002.006a.7.7 0 0 1-.004.01l-.004.008a.618.618 0 0 1-.005.01l-.004.008-.005.008-.004.008a.168.168 0 0 1-.005.008l-.004.008-.005.008-.004.008A.168.168 0 0 1 15 17.25m-3-3v-3.03l3.03-3.03A1.5 1.5 0 0 0 13.5 9.697V6.75a1.5 1.5 0 0 0-3 0v2.947A1.5 1.5 0 0 0 9 11.197L6 14.227v3.03M12 12.75H9M15 12.75H9" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="departamentoFilter" class="block text-sm font-medium text-gray-700 mb-1">Departamento:</label>
                    <div class="relative mt-1">
                        <select id="departamentoFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21v-4.5m0 4.5h-3.75m3.75 0H21M3.75 16.5v-4.5m0 4.5h-3.75m3.75 0H21M3.75 12v-4.5m0 4.5h-3.75m3.75 0H21M3.75 7.5V3m0 4.5h-3.75M3.75 3h16.5M3.75 3v4.5" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="designerFilter" class="block text-sm font-medium text-gray-700 mb-1">Dise√±ador:</label>
                    <div class="relative mt-1">
                        <select id="designerFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="customStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Estado:</label>
                    <div class="relative mt-1">
                        <select id="customStatusFilter" class="w-full block pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer appearance-none"></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="filter-item">
                    <label for="dateFrom" class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde:</label>
                    <input type="date" id="dateFrom" class="w-full mt-1 block px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="filter-item">
                    <label for="dateTo" class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta:</label>
                    <input type="date" id="dateTo" class="w-full mt-1 block px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="filter-item flex items-end">
                    <button class="w-full font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-red-600 border border-red-300 hover:bg-red-50 flex items-center justify-center gap-2" onclick="clearAllFilters()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" />
                        </svg>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
        <div class="filters bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="filter-group mb-4">
                <label class="block text-base font-semibold text-gray-800 mb-2">Estado de Entrega (Solo P_Art):</label>
                <div class="flex items-center rounded-lg shadow-sm border border-gray-300 overflow-hidden" id="statusFilters">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>
            <div class="filter-group">
                <label class="block text-base font-semibold text-gray-800 mb-2">Fecha (Solo P_Art):</label>
                <div class="flex items-center rounded-lg shadow-sm border border-gray-300 overflow-hidden" id="dateFilters">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>
        </div>
        <!-- ... (Esto es la continuaci√≥n de la Parte 4) ... -->

        <!-- ====================================================== -->
        <!-- ===== TABLA PRINCIPAL (Original) ===== -->
        <!-- ====================================================== -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="table-container overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 w-12">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" aria-label="Seleccionar todas las √≥rdenes en esta p√°gina"
                                       class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-indigo-600 cursor-pointer">
                            </th>
                            <th onclick="sortTable('status')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Estado <span id="sort-status"></span>
                            </th>
                            <th onclick="sortTable('date')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Fecha <span id="sort-date"></span>
                            </th>
                            <th onclick="sortTable('cliente')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Cliente <span id="sort-cliente"></span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider select-none">
                                C√≥digo
                            </th>
                            <th onclick="sortTable('estilo')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Estilo <span id="sort-estilo"></span>
                            </th>
                            <th onclick="sortTable('teamName')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Team <span id="sort-teamName"></span>
                            </th>
                            <th onclick="sortTable('departamento')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Departamento <span id="sort-departamento"></span>
                            </th>
                            <th onclick="sortTable('designer')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Dise√±ador <span id="sort-designer"></span>
                            </th>
                            <th onclick="sortTable('customStatus')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Estado Orden <span id="sort-customStatus"></span>
                            </th>
                            <th onclick="sortTable('receivedDate')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Fecha Recibida <span id="sort-receivedDate"></span>
                            </th>
                            <th onclick="sortTable('cantidad')" class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider cursor-pointer select-none">
                                Cantidad <span id="sort-cantidad"></span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider select-none">
                                Notas
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-indigo-500 uppercase tracking-wider select-none">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- El contenido se genera por JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- ===== PAGINACI√ìN (Original) ===== -->
        <!-- ====================================================== -->
        <div class="pagination-container bg-white rounded-lg shadow-lg p-4 flex flex-wrap items-center justify-between gap-4">
            <div class_alias="pagination-rows-select text-sm text-gray-600">
                <label for="rowsPerPage">Filas por p√°gina: </label>
                <select id="rowsPerPage" onchange="changeRowsPerPage()"
                        class="ml-2 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm bg-white cursor-pointer">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                </select>
            </div>
            <div class_alias="pagination-info text-sm text-gray-600 text-center">
                <span id="resultCount">0</span> de <span id="totalCount">0</span> √≥rdenes | 
                <strong><span id="resultPieces">0</span> piezas</strong>
                (P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>)
            </div>
            <div class="pagination-controls flex items-center justify-center gap-1" id="paginationControls">
                <!-- El contenido se genera por JS -->
            </div>
        </div>
        
    </div> <!-- Fin de #dashboard -->

    <!-- ====================================================== -->
    <!-- ===== VISTAS OCULTAS (M√©tricas, Depto, Plan) (Original) ===== -->
    <!-- ====================================================== -->
    <div id="designerMetricsView" class="p-4 md:p-6" style="display: none;">
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 16.5 19.875V3.375Z" />
                    </svg>
                    M√©tricas por Dise√±ador
                </h1>
                <p class="text-sm text-gray-500 mt-1 pl-10">M√©tricas de rendimiento y carga de trabajo activa (Solo P_Art)</p>
            </div>
            <div class="header-buttons">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="hideMetricsView()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    &laquo; Volver al Panel Principal
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
            
            <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6 max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Seleccionar Dise√±ador</h3>
                <div id="metricsSidebarList" class="space-y-2">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>

            <div id="metricsDetail" class="lg:col-span-3 bg-white rounded-lg shadow-lg p-6 md:p-8 max-h-[80vh] overflow-y-auto">
                <p class="text-gray-500 text-center py-12">
                    ‚Üê Selecciona un dise√±ador de la lista para ver sus estad√≠sticas.
                </p>
                <!-- El contenido se genera por JS -->
            </div>

        </div>
    </div>
    
    <div id="departmentMetricsView" class="p-4 md:p-6" style="display: none;">
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
                    </svg>
                    M√©tricas del Departamento
                </h1>
                <p class="text-sm text-gray-500 mt-1 pl-10">Visi√≥n general del rendimiento y la carga de trabajo en P_Art</p>
            </div>
            <div class="header-buttons">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="hideDepartmentMetrics()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    &laquo; Volver al Panel Principal
                </button>
            </div>
        </div>

        <div id="departmentMetricsContent" class="space-y-6">
            <div id="deptSpinnerContainer" class="text-center py-20">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mx-auto"></div>
                <p class="text-gray-600 mt-4">Calculando m√©tricas del departamento...</p>
            </div>
        </div>

    </div>
    
    <!-- VISTA DEL PLAN DE TRABAJO (Agregada en Parte 2) -->
    <div id="workPlanView" class="p-4 md:p-6" style="display: none;">
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-18 0h18" />
                    </svg>
                    Plan de Trabajo Semanal (Arte)
                </h1>
                <p class="text-sm text-gray-500 mt-1 pl-10">Planifica y prioriza la carga de trabajo semanal.</p>
            </div>
            <div class="header-buttons">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="hideWorkPlanView()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    Volver al Panel Principal
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-wrap gap-4 mb-4 items-end">
                <div class="filter-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Semana:</label>
                    <input type="week" id="view-workPlanWeekSelector" onchange="generateWorkPlan()" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer">
                </div>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-red-600 text-white hover:bg-red-700 flex items-center gap-2" onclick="loadUrgentOrdersToPlan()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
                    </svg>
                    Cargar Urgentes Asignadas
                </button>
                <div class="flex-grow text-right">
                    <span id="view-workPlanSummary" class="text-sm font-medium text-gray-600"></span>
                </div>
            </div>
            
            <div id="view-workPlanContent" class="space-y-6 mt-6">
                <div class="spinner-container" id="view-workPlanSpinner" style="display: none;">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto my-8"></div>
                    <p class="text-center text-gray-600">Cargando plan...</p>
                </div>
                <!-- El contenido se genera por JS -->
            </div>
        </div>
    </div>
    
    <!-- ====================================================== -->
    <!-- ===== BARRA MULTI-SELECT (Original) ===== -->
    <!-- ====================================================== -->
    <div id="multiSelectBar" class="multi-select-bar fixed bottom-6 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-2xl p-4 flex items-center gap-4 z-50 transition-all duration-300 transform translate-y-20 opacity-0">
        <span class="selected-count font-semibold text-blue-600"><span id="selectedCount">0</span> √≥rdenes seleccionadas</span>
        
        <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="openMultiAssignModal()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            Asignar M√∫ltiples
        </button>
        
        <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-green-600 text-white hover:bg-green-700 flex items-center gap-2" onclick="addSelectedToWorkPlan()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Agregar al Plan
        </button>
        
        <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="clearSelection()">Cancelar</button>
    </div>
    <!-- ... (Esto es la continuaci√≥n de la Parte 5) ... -->

    <!-- ====================================================== -->
    <!-- ===== MODAL: ASIGNAR ORDEN (Paso 2 - Bot√≥n A√±adido) ===== -->
    <!-- ====================================================== -->
    <div id="assignModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                    Editar Orden
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeModal()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">Cliente</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailCliente">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">C√≥digo</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailCodigo">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">Estilo</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailEstilo">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">Departamento</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailDepartamento">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">Fecha Despacho</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailFecha">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label text-xs font-medium text-gray-500 uppercase">Cantidad</div>
                        <div class="detail-value text-base font-semibold text-gray-900" id="detailPiezas">-</div>
                    </div>
                </div>
                
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dise√±ador (Asignaci√≥n Manual):</label>
                    <select id="modalDesigner" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white disabled:bg-gray-100 disabled:text-gray-500"></select>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado de la Orden:</label>
                    <select id="modalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white disabled:bg-gray-100 disabled:text-gray-500">
                        <option value="">Sin estado</option>
                        <option value="Bandeja">Bandeja</option>
                        <option value="Producci√≥n">Producci√≥n</option>
                        <option value="Auditor√≠a">Auditor√≠a</option>
                        <option value="Completada">Completada</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Recibida:</label>
                    <input type="date" id="modalReceivedDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:text-gray-500">
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notas:</label>
                    <textarea id="modalNotes" placeholder="Agrega notas u observaciones..." class="w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Historial de Cambios:</label>
                    <div id="modalHistory" class="max-h-48 overflow-y-auto space-y-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- El contenido se genera por JS -->
                    </div>
                </div>

                <div class="modal-field pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                            </svg>
                            √ìrdenes Hijas (<span id="childOrderCount">0</span>):
                        </label>
                        <button id="addChildOrderBtn" class="font-medium py-1 px-3 rounded-lg text-xs transition-colors shadow-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-1" onclick="openAddChildModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Agregar Hija
                        </button>
                    </div>
                    <div id="childOrdersList" class="max-h-56 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                        <!-- El contenido se genera por JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeModal()">Cancelar</button>
                
                <!-- ===== NUEVO BOT√ìN (Paso 2) ===== -->
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-green-600 text-white hover:bg-green-700 flex items-center gap-2" onclick="asignarmeAmi()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                    Asignarme a m√≠
                </button>

                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="saveAssignment()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                    </svg>
                    Guardar Cambios (Ctrl+S)
                </button>
            </div>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- ===== MODALES (Originales) - Multi-asignar, Hija, Reporte, Dise√±ador, Confirmar, Comparar ===== -->
    <!-- ====================================================== -->
    <div id="multiAssignModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Asignar M√∫ltiples √ìrdenes
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeMultiModal()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">√ìrdenes Seleccionadas (<span id="multiModalCount">0</span>):</label>
                    <div id="selectedOrdersList" class="selected-orders-list p-3 bg-gray-50 rounded-lg border border-gray-200 max-h-40 overflow-y-auto">
                        <!-- El contenido se genera por JS -->
                    </div>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dise√±ador:</label>
                    <select id="multiModalDesigner" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"></select>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado de la Orden:</label>
                    <select id="multiModalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="">Sin estado</option>
                        <option value="Bandeja">Bandeja</option>
                        <option value="Producci√≥n">Producci√≥n</option>
                        <option value="Auditor√≠a">Auditor√≠a</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Recibida:</label>
                    <input type="date" id="multiModalReceivedDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notas (se aplicar√° a todas):</label>
                    <textarea id="multiModalNotes" placeholder="Agrega notas u observaciones..." class="w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeMultiModal()">Cancelar</button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="saveMultiAssignment()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                    </svg>
                    Guardar Todo
                </button>
            </div>
        </div>
    </div>
    
    <div id="addChildModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-green-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Agregar Orden Hija
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeAddChildModal()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <div class="p-3 bg-gray-100 rounded-lg border border-gray-200">
                    <p class="text-xs font-medium text-gray-500"><strong>Orden Padre:</strong></p>
                    <p class="text-sm font-semibold text-gray-800" id="parentOrderInfo"></p>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Orden Hija: <span class="text-red-500">*</span></label>
                    <div class="flex gap-2 items-center">
                        <input type="text" id="childOrderCode" readonly class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 text-gray-500">
                        <input type="number" id="childOrderNumber" min="1" placeholder="#" class="w-20 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="updateChildOrderCode()">
                    </div>
                    <small class="text-xs text-gray-500">Ejemplo: LGS21723-A-1, LGS21723-A-2...</small>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad de Piezas: <span class="text-red-500">*</span></label>
                    <input type="number" id="childPieces" min="1" placeholder="Ej: 150" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Despacho:</label>
                    <input type="date" id="childDeliveryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <small class="text-xs text-gray-500">Si no se especifica, heredar√° la fecha de la orden padre</small>
                </div>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notas (Opcional):</label>
                    <textarea id="childNotes" placeholder="Notas espec√≠ficas para esta orden hija..." class="w-full min-h-[80px] px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md">
                    <p class="text-sm font-semibold text-blue-800 mb-1 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                        </svg>
                        <strong>Informaci√≥n Heredada:</strong>
                    </p>
                    <ul class="text-xs text-blue-700 list-disc list-inside space-y-1 mt-2">
                        <li>Cliente, Team y Dise√±ador se heredan autom√°ticamente</li>
                        <li>Las piezas de las hijas cuentan por separado en estad√≠sticas</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeAddChildModal()">Cancelar</button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2" onclick="saveChildOrder()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Crear Orden Hija
                </button>
            </div>
        </div>
    </div>
    <!-- ... (Esto es la continuaci√≥n de la Parte 6) ... -->

    <div id="weeklyReportModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5M11.25 3.75h7.5m-7.5 0a1.125 1.125 0 0 1-1.125-1.125M11.25 3.75v15M18.75 3.75v15m-1.125-15a1.125 1.125 0 0 0-1.125-1.125m1.125 1.125v15m0 0a1.125 1.125 0 0 1 1.125 1.125m-1.125-1.125h-7.5" />
                    </svg>
                    Reporte Semanal de √ìrdenes
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeWeeklyReportModal()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 flex-grow overflow-y-auto">
                <div class="filter-group mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Semana:</label>
                    <input type="week" id="weekSelector" onchange="generateWeeklyReport()" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer">
                </div>
                <div id="weeklyReportContent">
                    <div class="spinner-container" id="weeklyReportSpinner" style="display: none;">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto my-8"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeWeeklyReportModal()">Cerrar</button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-green-600 text-white hover:bg-green-700 flex items-center gap-2" onclick="exportWeeklyReportAsPDF()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>
    
    <div id="designerManagerModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A9.065 9.065 0 0 1 12 15v2.25m0-2.25h.008c.005 0 .009 0 .013.002l.008.002c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.005.002.009.003.014.004l.008.003c.07.017.14.03.21.041a1.904 1.904 0 0 1 .84 1.511l.044.283.008.057c.004.03.005.059.008.087l.002.018c.002.01.003.02.005.03l.001.005c.001.002.002.004.002.006a.7.7 0 0 1-.004.01l-.004.008a.618.618 0 0 1-.005.01l-.004.008-.005.008-.004.008a.168.168 0 0 1-.005.008l-.004.008-.005.008-.004.008A.168.168 0 0 1 15 17.25m-3-3v-3.03l3.03-3.03A1.5 1.5 0 0 0 13.5 9.697V6.75a1.5 1.5 0 0 0-3 0v2.947A1.5 1.5 0 0 0 9 11.197L6 14.227v3.03M12 12.75H9M15 12.75H9" />
                    </svg>
                    Gestionar Dise√±adores
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeDesignerManager()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6">
                <div class="modal-field mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lista de Dise√±adores Activos (desde Firebase):</label>
                    <div id="designerManagerList" class="designer-list max-h-60 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                        <!-- El contenido se genera por JS -->
                    </div>
                </div>
                <div class="add-designer-form modal-field pt-4 border-t border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agregar Nuevo Dise√±ador:</label>
                    <div class="flex gap-2">
                        <input type="text" id="newDesignerName" placeholder="Nombre del nuevo dise√±ador" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-green-600 text-white hover:bg-green-700 flex items-center gap-2" onclick="addDesigner()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeDesignerManager()">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 id="confirmModalTitle" class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-500">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.008v.008H12v-.008Z" />
                    </svg>
                    Confirmar Acci√≥n
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeConfirmModal()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6">
                <p id="confirmModalMessage" class="text-gray-700 whitespace-pre-wrap leading-relaxed">¬øEst√°s seguro?</p>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button id="confirmModalCancel" class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeConfirmModal()">Cancelar</button>
                <button id="confirmModalConfirm" class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-red-600 text-white hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="selectCompareModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    Comparar con...
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeCompareModals()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <p class="text-sm text-gray-600">
                    Comparando a <strong id="compareDesigner1Name" class="text-blue-600"></strong> con:
                </p>
                <div class="modal-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selecciona el segundo dise√±ador:</label>
                    <select id="compareDesignerSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"></select>
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeCompareModals()">Cancelar</button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700" onclick="startComparison()">Iniciar Comparaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="compareModal" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95 transition-all duration-200">
            <div class="modal-header flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    Comparativa de Dise√±adores
                </h2>
                <button class="close-modal text-gray-400 hover:text-gray-600" onclick="closeCompareModals()" aria-label="Cerrar modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body p-6 space-y-4 overflow-y-auto">
                <div id="compareChartContainer" class="h-64 mb-4">
                    <canvas id="compareChartCanvas"></canvas>
                </div>
                <div id="compareTableContainer" class="overflow-x-auto rounded-lg border border-gray-200">
                    <!-- El contenido se genera por JS -->
                </div>
            </div>
            <div class="modal-footer flex gap-2 justify-end p-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="closeCompareModals()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- ===== ESTILOS CSS (Original) ===== -->
    <!-- ====================================================== -->
    <style>
        /* Este bloque <style> es necesario para las clases que el JS 
          a√±ade/quita din√°micamente, como .active o .modal-open.
          Tambi√©n se usa para el resaltado de filas de la tabla.
        */
        
        /* Control de Modales */
        body.modal-open {
            overflow: hidden;
        }
        .modal {
            display: flex;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        /* Barra de Selecci√≥n M√∫ltiple */
        .multi-select-bar.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Resaltado de Filas de la Tabla (usando variables de Tailwind) */
        tr.very-late {
            background-color: theme('colors.red.50');
            border-left: 4px solid theme('colors.red.500');
        }
        tr.late {
            background-color: theme('colors.red.50');
        }
        tr.expiring {
            background-color: theme('colors.yellow.50');
        }
        tbody tr:hover {
            background-color: theme('colors.gray.100');
        }
        
        /* Botones de Paginaci√≥n */
        .pagination-controls button {
            background-color: theme('colors.white');
            border: 1px solid theme('colors.gray.300');
            color: theme('colors.gray.700');
            padding: 6px 12px;
            margin: 0 2px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: theme('colors.gray.100');
        }
        .pagination-controls button:disabled {
            background-color: theme('colors.gray.50');
            color: theme('colors.gray.400');
            cursor: not-allowed;
        }
        .pagination-controls button.active {
            background-color: theme('colors.blue.600');
            color: theme('colors.white');
            border-color: theme('colors.blue.600');
        }
        
        /* Botones de Filtro (Sidebar de M√©tricas) */
        .filter-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            border: 1px solid theme('colors.gray.200');
            background: theme('colors.white');
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.875rem;
            color: theme('colors.gray.800');
        }
        .filter-btn:hover {
            background: theme('colors.gray.100');
            border-color: theme('colors.gray.300');
        }
        .filter-btn.active {
            background: theme('colors.blue.600');
            color: theme('colors.white');
            border-color: theme('colors.blue.600');
        }
        /* Estilo para el span (badge) dentro del bot√≥n activo */
        .filter-btn.active span {
            background-color: theme('colors.blue.500');
            color: theme('colors.white');
        }

        /* Tabla de Comparaci√≥n (Fase 3) */
        #compareTableContainer table {
            min-width: 0;
        }
        #compareTableContainer th {
            background: theme('colors.gray.50');
            color: theme('colors.gray.900');
            text-transform: none;
            font-size: 0.9em;
            padding: 12px;
        }
        #compareTableContainer td {
            font-size: 0.9em;
            text-align: center;
            padding: 12px;
        }
        #compareTableContainer td:first-child {
            font-weight: 600;
            color: theme('colors.gray.900');
            text-align: left;
        }
        #compareTableContainer .value-a {
            background: theme('colors.blue.50');
            font-weight: 600;
        }
        #compareTableContainer .value-b {
            background: theme('colors.yellow.50');
            font-weight: 600;
        }

        /* Estilos del Spinner de Carga (Overlay) */
        .spinner {
            border: 4px solid theme('colors.gray.200');
            border-top: 4px solid theme('colors.blue.600');
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }
        .loading-overlay .spinner {
            border-color: rgba(255,255,255,0.3);
            border-top-color: white;
            width: 60px;
            height: 60px;
        }
        .loading-overlay p {
            color: white;
            font-size: 1.1em;
            margin-top: 16px;
        }
    /* Reducir tama√±o base de fuentes y espaciados */
    html {
        font-size: 13.2px; /* Base m√°s peque√±a (era 12px, ahora +10%) */
    }

    /* Ajustar padding y m√°rgenes globales */
    .p-4 { padding: 0.825rem !important; }
    .p-6 { padding: 1.2375rem !important; }
    .p-8 { padding: 1.65rem !important; }
    .mb-4 { margin-bottom: 0.825rem !important; }
    .mb-6 { margin-bottom: 1.2375rem !important; }
    .gap-4 { gap: 0.825rem !important; }
    .gap-6 { gap: 1.2375rem !important; }

    /* Reducir tama√±o de textos */
    .text-2xl { font-size: 1.2375rem !important; }
    .text-lg { font-size: 1.03125rem !important; }
    .text-base { font-size: 0.89375rem !important; }
    .text-sm { font-size: 0.75625rem !important; }
    .text-xs { font-size: 0.6875rem !important; }

    /* Reducir altura de elementos interactivos */
    input, select, textarea, button {
        font-size: 0.825rem !important;
        padding: 0.4125rem 0.825rem !important;
    }

    /* Reducir tama√±o de tarjetas de estad√≠sticas */
    .grid > div {
        padding: 1.1rem !important;
    }

    /* Reducir altura de filas de tabla */
    table td, table th {
        padding: 0.55rem 1.1rem !important;
        font-size: 0.825rem !important;
    }
    </style>
    <!-- ... (Esto es la continuaci√≥n de la Parte 7) ... -->

    <!-- ====================================================== -->
    <!-- ===== JAVASCRIPT PRINCIPAL (Refactorizado para Firebase) ===== -->
    <!-- ====================================================== -->
    <script>
        // ======================================================
        // ===== VARIABLES GLOBALES (Paso 1: Refactorizaci√≥n) =====
        // ======================================================
        
        // --- Variables de Estado de la App ---
        let allOrders = []; // Almacenar√° la fusi√≥n de Excel + Firebase
        let selectedOrders = new Set();
        let currentFilter = 'all';
        let currentDateFilter = 'all';
        let currentSearch = '';
        let currentClientFilter = '';
        let currentStyleFilter = '';
        let currentTeamFilter = '';
        let currentDepartamentoFilter = '';
        let currentDesignerFilter = '';
        let currentCustomStatusFilter = '';
        let currentDateFrom = '';
        let currentDateTo = '';
        let sortConfig = { key: 'date', direction: 'asc' };
        let currentEditingOrderId = null;
        let isExcelLoaded = false; // Controla si el Excel ya se carg√≥

        // --- Variables de Paginaci√≥n ---
        let currentPage = 1;
        let rowsPerPage = 50;
        let paginatedOrders = [];
        
        // --- Variables de Firebase (NUEVO) ---
        let usuarioActual = null; // ¬°Clave para saber QUI√âN usa la app!
        const db_firestore = firebase.firestore(); // Conexi√≥n a la base de datos
        
        // --- Mapas de Datos de Firebase (Cach√© en tiempo real) (NUEVO) ---
        let firebaseAssignmentsMap = new Map();
        let firebaseHistoryMap = new Map();
        let firebaseChildOrdersMap = new Map();
        let firebaseDesignersMap = new Map(); // Se usar√° para 'designerList'
        let firebaseWeeklyPlanMap = new Map();
        
        // --- Variables de Lista y Estado ---
        let designerList = []; // Ahora se llenar√° desde firebaseDesignersMap
        const CUSTOM_STATUS_OPTIONS = ['Bandeja', 'Producci√≥n', 'Auditor√≠a', 'Completada'];
        let needsRecalculation = true; 

        // --- Instancias de Gr√°ficos (Original) ---
        let designerDoughnutChart = null;
        let designerBarChart = null;
        let designerActivityChart = null; 
        let currentDesignerTableFilter = { search: '', cliente: '', estado: '', fechaDesde: '', fechaHasta: '' };
        let compareChart = null;
        let deptLoadPieChart = null;
        let deptLoadBarChart = null;
        let deptProductivityChart = null;
        let currentWorkPlanWeek = '';

        
        // ======================================================
        // ===== FUNCIONES DE INICIALIZACI√ìN (Paso 2: Firebase) =====
        // ======================================================
        
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM cargado. Inicializando App v5.0 (Firebase)...');
            
            // --- Listeners de Autenticaci√≥n (NUEVO) ---
            document.getElementById('loginButton').onclick = iniciarLoginConGoogle;
            document.getElementById('logoutButton').onclick = iniciarLogout;

            // --- Listener de Autenticaci√≥n Principal (NUEVO) ---
            firebase.auth().onAuthStateChanged((user) => {
                const loginSection = document.getElementById('loginSection');
                const uploadSection = document.getElementById('uploadSection');
                const dashboard = document.getElementById('dashboard');

                if (user) {
                    // Usuario ha iniciado sesi√≥n
                    usuarioActual = user;
                    console.log("Usuario conectado:", usuarioActual.displayName);
                    document.getElementById('userName').textContent = usuarioActual.displayName;
                    
                    loginSection.style.display = 'none';
                    if (!isExcelLoaded) {
                        uploadSection.style.display = 'block'; // Mostrar carga de Excel
                    } else {
                        dashboard.style.display = 'block'; // O mostrar dashboard si ya carg√≥
                    }
                    
                    // Conectar a los datos de Firebase en tiempo real
                    conectarDatosDeFirebase();

                } else {
                    // Usuario ha cerrado sesi√≥n
                    usuarioActual = null;
                    isExcelLoaded = false;
                    allOrders = []; // Limpiar datos
                    console.log("Usuario desconectado.");

                    loginSection.style.display = 'block';
                    uploadSection.style.display = 'none';
                    dashboard.style.display = 'none';
                    
                    // Aqu√≠ deber√≠as desconectar los listeners de onSnapshot si existen
                    // (Por simplicidad, omitido, pero en producci√≥n se deben desconectar)
                }
            });

            // --- Listeners de UI (Originales) ---
            document.getElementById('searchInput').addEventListener('input', debounce((e) => { 
                currentSearch = e.target.value; 
                currentPage = 1; 
                updateTable(); 
            }, 300)); 
            
            document.getElementById('clientFilter').onchange = (e) => { currentClientFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('styleFilter').onchange = (e) => { currentStyleFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('teamFilter').onchange = (e) => { currentTeamFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('departamentoFilter').onchange = (e) => { currentDepartamentoFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('designerFilter').onchange = (e) => { currentDesignerFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('customStatusFilter').onchange = (e) => { currentCustomStatusFilter = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('dateFrom').onchange = (e) => { currentDateFrom = e.target.value; currentPage = 1; updateTable(); };
            document.getElementById('dateTo').onchange = (e) => { currentDateTo = e.target.value; currentPage = 1; updateTable(); };

            // --- Listeners de UI (Modificados) ---
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            ['dragenter','dragover','dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, preventDefaults, false));
            dropZone.addEventListener('dragenter', () => dropZone.classList.add('border-blue-500', 'bg-gray-100'), false);
            dropZone.addEventListener('dragover', () => dropZone.classList.add('border-blue-500', 'bg-gray-100'), false);
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500', 'bg-gray-100'), false);
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('border-blue-500', 'bg-gray-100');
                handleDrop(e);
            }, false);
            
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            // --- Listeners de Delegaci√≥n (Originales) ---
            document.getElementById('designerManagerList').addEventListener('click', function(e) {
                const deleteButton = e.target.closest('.btn-delete-designer');
                if (deleteButton) {
                    const name = deleteButton.dataset.name;
                    const docId = deleteButton.dataset.id; // NUEVO: Usar ID de Firestore
                    if (name && docId) {
                        deleteDesigner(docId, name);
                    }
                }
            });
            document.getElementById('metricsSidebarList').addEventListener('click', function(e) {
                const metricsButton = e.target.closest('.filter-btn'); 
                if (metricsButton) {
                    const name = metricsButton.dataset.designer;
                    if (name) {
                        generateDesignerMetrics(name);
                    }
                }
            });
            document.getElementById('childOrdersList').addEventListener('click', function(e) {
                 const deleteButton = e.target.closest('.btn-delete-child');
                 if(deleteButton) {
                    e.stopPropagation(); 
                    const childId = deleteButton.dataset.childId;
                    const childCode = deleteButton.dataset.childCode;
                    if (childId && childCode) {
                        deleteChildOrder(childId, childCode);
                    }
                 }
            });
            document.getElementById('view-workPlanContent').addEventListener('click', function(e) {
                 const removeButton = e.target.closest('.btn-remove-from-plan');
                 if(removeButton) {
                    e.stopPropagation();
                    const planEntryId = removeButton.dataset.planEntryId;
                    const orderCode = removeButton.dataset.orderCode;
                    if (planEntryId) {
                        removeOrderFromPlan(planEntryId, orderCode);
                    }
                 }
            });

            // --- Listeners de Atajos (Originales) ---
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeMultiModal();
                    closeWeeklyReportModal();
                    hideWorkPlanView();
                    closeDesignerManager();
                    hideMetricsView(); 
                    hideDepartmentMetrics();
                    closeConfirmModal(); 
                    closeCompareModals(); 
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const assignModal = document.getElementById('assignModal');
                    if (assignModal.classList.contains('active')) {
                        saveAssignment();
                    }
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    if (document.getElementById('dashboard').style.display === 'block') {
                        document.getElementById('searchInput').focus();
                    }
                }
                const targetNode = e.target.nodeName.toLowerCase();
                if (targetNode !== 'input' && targetNode !== 'textarea' && targetNode !== 'select') {
                    if (document.getElementById('dashboard').style.display === 'block') {
                        if (e.key === 'ArrowLeft') { e.preventDefault(); changePage(currentPage - 1); }
                        if (e.key === 'ArrowRight') { e.preventDefault(); changePage(currentPage + 1); }
                    }
                }
            });

            // No llamamos a initDatabase(), Firebase se inicializa solo.
            console.log("App lista. Esperando inicio de sesi√≥n.");
        });

        // ======================================================
        // ===== FUNCIONES DE FIREBASE (Paso 3: N√∫cleo) =====
        // ======================================================

        /**
         * (NUEVO) Inicia el proceso de login con Google
         */
        function iniciarLoginConGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).catch((error) => {
                console.error("Error de autenticaci√≥n:", error);
                showCustomAlert(`Error de autenticaci√≥n: ${error.message}`, 'error');
            });
        }

        /**
         * (NUEVO) Cierra la sesi√≥n del usuario
         */
        function iniciarLogout() {
            firebase.auth().signOut();
        }

        /**
         * (NUEVO) Se conecta a Firestore y escucha cambios en TODAS las colecciones.
         * Esta es la funci√≥n m√°s importante de la app.
         */
        function conectarDatosDeFirebase() {
            if (!usuarioActual) return;
            
            const dbStatus = document.getElementById('dbStatus');
            dbStatus.textContent = '‚óè Conectando a Firebase...';
            dbStatus.className = "ml-3 font-medium text-yellow-600";
            
            // --- 1. Sincronizar Asignaciones ---
            db_firestore.collection('assignments').onSnapshot((snapshot) => {
                firebaseAssignmentsMap.clear();
                snapshot.forEach((doc) => {
                    firebaseAssignmentsMap.set(doc.id, doc.data());
                });
                console.log(`Sincronizadas ${firebaseAssignmentsMap.size} asignaciones.`);
                if(isExcelLoaded) mergeYActualizar(); // Refrescar si el Excel ya est√° cargado
                
                dbStatus.textContent = '‚óè Conectado (Tiempo Real)';
                dbStatus.className = "ml-3 font-medium text-green-600";

            }, (error) => {
                console.error("Error de Firestore (assignments):", error);
                dbStatus.textContent = '‚óè Error de Conexi√≥n';
                dbStatus.className = "ml-3 font-medium text-red-600";
            });

            // --- 2. Sincronizar Historial ---
            db_firestore.collection('history').onSnapshot((snapshot) => {
                firebaseHistoryMap.clear();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const orderId = data.orderId;
                    if (!firebaseHistoryMap.has(orderId)) {
                        firebaseHistoryMap.set(orderId, []);
                    }
                    firebaseHistoryMap.get(orderId).push(data);
                });
                console.log(`Sincronizados ${firebaseHistoryMap.size} historiales de √≥rdenes.`);
            }, (error) => console.error("Error de Firestore (history):", error));

            // --- 3. Sincronizar √ìrdenes Hijas ---
            db_firestore.collection('childOrders').onSnapshot((snapshot) => {
                firebaseChildOrdersMap.clear();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const parentId = data.parentOrderId;
                    if (!firebaseChildOrdersMap.has(parentId)) {
                        firebaseChildOrdersMap.set(parentId, []);
                    }
                    firebaseChildOrdersMap.get(parentId).push(data);
                });
                console.log(`Sincronizadas ${firebaseChildOrdersMap.size} √≥rdenes con hijas.`);
                needsRecalculation = true;
                if(isExcelLoaded) mergeYActualizar();
            }, (error) => console.error("Error de Firestore (childOrders):", error));
            
            // --- 4. Sincronizar Dise√±adores ---
            db_firestore.collection('designers').orderBy('name').onSnapshot((snapshot) => {
                firebaseDesignersMap.clear();
                let newDesignerList = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseDesignersMap.set(doc.id, data); // Guardamos ID y data
                    newDesignerList.push(data.name);
                });
                designerList = newDesignerList; // Actualizar lista global
                console.log(`Sincronizados ${designerList.length} dise√±adores.`);
                
                // Actualizar todos los <select> en la UI
                updateAllDesignerDropdowns();
                populateDesignerManagerModal();
                if(isExcelLoaded) generateWorkloadReport();

            }, (error) => console.error("Error de Firestore (designers):", error));

            // --- 5. Sincronizar Plan Semanal ---
            db_firestore.collection('weeklyPlan').onSnapshot((snapshot) => {
                firebaseWeeklyPlanMap.clear();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const weekId = data.weekIdentifier;
                    if (!firebaseWeeklyPlanMap.has(weekId)) {
                        firebaseWeeklyPlanMap.set(weekId, []);
                    }
                    firebaseWeeklyPlanMap.get(weekId).push(data);
                });
                console.log(`Sincronizados ${firebaseWeeklyPlanMap.size} planes semanales.`);
                // Refrescar el plan si est√° abierto
                if (document.getElementById('workPlanView').style.display === 'block') {
                    generateWorkPlan();
                }
            }, (error) => console.error("Error de Firestore (weeklyPlan):", error));
        }

        /**
         * (NUEVO) Combina los datos del Excel (allOrders) con los datos de Firebase
         * y actualiza el dashboard.
         */
        function mergeYActualizar() {
            if (!isExcelLoaded) return; // No hacer nada si el Excel no est√° cargado
            
            console.log("Fusionando Excel con datos de Firebase...");
            
            // Recalcular piezas hijas (usa el mapa de Firebase)
            recalculateChildPieces(); 

            // Recorrer allOrders (del Excel) y fusionar con datos de Firebase
            for (let i = 0; i < allOrders.length; i++) {
                const order = allOrders[i];
                const orderId = order.orderId;
                
                // Obtener datos de Firebase
                const fbData = firebaseAssignmentsMap.get(orderId);
                
                if (fbData) {
                    // Fusionar datos
                    order.designer = fbData.designer || '';
                    order.customStatus = fbData.customStatus || '';
                    order.receivedDate = fbData.receivedDate || '';
                    order.notes = fbData.notes || '';
                    order.completedDate = fbData.completedDate || null;
                } else {
                    // Si no existe en Firebase, asegurar que est√© limpio
                    order.designer = '';
                    order.customStatus = '';
                    order.receivedDate = '';
                    order.notes = '';
                    order.completedDate = null;
                }

                // L√≥gica de completado autom√°tico (igual que antes)
                if (fbData && 
                    (fbData.customStatus === 'Bandeja' || fbData.customStatus === 'Producci√≥n' || fbData.customStatus === 'Auditor√≠a') &&
                    order.departamento !== 'P_Art' && 
                    order.departamento !== 'Sin Departamento') 
                {
                    order.customStatus = 'Completada';
                    const newCompletedDate = new Date().toISOString();
                    order.completedDate = newCompletedDate;
                    
                    // Auto-actualizar en Firebase
                    const changes = [`Estado autom√°tico: ${fbData.customStatus} ‚Üí Completada (movido a ${order.departamento})`];
                    saveAssignmentToDB_Firestore(orderId, 
                        { customStatus: 'Completada', completedDate: newCompletedDate }, 
                        changes
                    );
                }
            }
            
            // Actualizar todo el Dashboard
            updateDashboard();
        }

        // ======================================================
        // ===== FUNCIONES CRUD DE FIREBASE (Paso 4: CRUD) =====
        // ======================================================

        /**
         * (Refactorizado) Guarda cambios en Firestore y registra el historial.
         * Esta funci√≥n REEMPLAZA a saveAssignmentToDB y saveToHistory.
         */
        async function saveAssignmentToDB_Firestore(orderId, dataToSave, historyChanges = []) {
            if (!usuarioActual) throw new Error("No est√°s autenticado.");
            
            const assignmentRef = db_firestore.collection('assignments').doc(orderId);
            const batch = db_firestore.batch();

            // 1. A√±adir 'lastModified' y asegurar que 'designer' est√© definido
            dataToSave.lastModified = new Date().toISOString();
            if (dataToSave.designer === undefined) dataToSave.designer = '';
            
            // 2. Guardar/Actualizar la asignaci√≥n
            batch.set(assignmentRef, dataToSave, { merge: true });

            // 3. Guardar el historial
            if (historyChanges.length > 0) {
                const user = usuarioActual.displayName || usuarioActual.email;
                for (const change of historyChanges) {
                    const historyRef = db_firestore.collection('history').doc(); // ID autom√°tico
                    batch.set(historyRef, {
                        orderId: orderId,
                        change: change,
                        user: user,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            // Ejecuta todas las operaciones
            return await batch.commit();
        }

        /**
         * (Refactorizado) Guarda una orden hija en Firestore
         */
        async function saveChildOrderToDB(childOrder) {
            const childRef = db_firestore.collection('childOrders').doc(childOrder.childOrderId);
            return await childRef.set(childOrder);
        }

        /**
         * (Refactorizado) Elimina una orden hija de Firestore
         */
        async function deleteChildOrderFromDB(childOrderId) {
            const childRef = db_firestore.collection('childOrders').doc(childOrderId);
            return await childRef.delete();
        }

        /**
         * (Refactorizado) Agrega un dise√±ador a Firestore
         */
        async function addDesigner() {
            const input = document.getElementById('newDesignerName');
            const name = input.value.trim();
            if (!name) return;

            if (designerList.map(d => d.toLowerCase()).includes(name.toLowerCase())) {
                showCustomAlert(`El dise√±ador "${name}" ya existe.`, 'error');
                return;
            }

            try {
                // A√±adir a la colecci√≥n 'designers'
                await db_firestore.collection('designers').add({ name: name });
                
                // onSnapshot se encargar√° de actualizar la UI
                input.value = '';
                showCustomAlert(`Dise√±ador "${name}" agregado.`, 'success');

            } catch (error) {
                console.error('Error en addDesigner:', error);
                showCustomAlert(`Error al agregar: ${error.message}`, 'error');
            }
        }

        /**
         * (Refactorizado) Elimina un dise√±ador de Firestore
         */
        async function deleteDesigner(docId, name) {
            const assignedOrders = allOrders.filter(o => o.designer === name && o.departamento === 'P_Art');
            
            let message = `¬øEst√°s seguro de eliminar a "${name}" de la lista?`;
            if (assignedOrders.length > 0) {
                message = `¬øEst√°s seguro de eliminar a "${name}"? \n\n‚ö†Ô∏è ADVERTENCIA: Este dise√±ador tiene ${assignedOrders.length} orden(es) activa(s) en P_Art. Si contin√∫as, estas √≥rdenes quedar√°n "Sin asignar" en Firebase.`;
            }

            showConfirmModal(message, async () => {
                try {
                    // 1. Eliminar de la colecci√≥n 'designers'
                    await db_firestore.collection('designers').doc(docId).delete();
                    
                    // 2. Desasignar √≥rdenes en Firebase
                    const batch = db_firestore.batch();
                    const ordersToUpdate = firebaseAssignmentsMap.forEach((data, orderId) => {
                        if (data.designer === name) {
                            const docRef = db_firestore.collection('assignments').doc(orderId);
                            batch.update(docRef, { designer: '' });
                        }
                    });
                    await batch.commit();
                    
                    // onSnapshot se encargar√° de actualizar la UI
                    showCustomAlert(`Dise√±ador "${name}" eliminado. ${assignedOrders.length} √≥rdenes fueron desasignadas.`, 'success');

                } catch (error) {
                    console.error('Error en deleteDesigner:', error);
                    showCustomAlert(`Error: ${error.message}`, 'error');
                }
            });
        }
        
        /**
         * (Refactorizado) Agrega una orden al plan semanal en Firestore
         */
        async function addOrderToWorkPlanDB(order, weekIdentifier) {
            const planEntryId = `${order.orderId}_${weekIdentifier}`;
            const planRef = db_firestore.collection('weeklyPlan').doc(planEntryId);

            const doc = await planRef.get();
            if (doc.exists) {
                console.log(`Orden ${order.codigoContrato} ya est√° en el plan ${weekIdentifier}`);
                return false; // Ya exist√≠a
            }

            const planEntry = {
                planEntryId: planEntryId,
                orderId: order.orderId,
                weekIdentifier: weekIdentifier,
                designer: order.designer,
                planStatus: 'Pendiente', 
                addedAt: new Date().toISOString(),
                cliente: order.cliente,
                codigoContrato: order.codigoContrato,
                estilo: order.estilo,
                fechaDespacho: order.fechaDespacho,
                cantidad: order.cantidad,
                childPieces: order.childPieces,
                isLate: order.isLate,
                isAboutToExpire: order.isAboutToExpire
            };
            
            await planRef.set(planEntry);
            return true; // Agregada
        }

        /**
         * (Refactorizado) Obtiene el plan semanal desde el Mapa de Firebase
         */
        async function getWorkPlanForWeek(weekIdentifier) {
            // Lee del mapa que se actualiza en tiempo real
            return firebaseWeeklyPlanMap.get(weekIdentifier) || [];
        }

        /**
         * (Refactorizado) Elimina una orden del plan semanal en Firestore
         */
        async function removeOrderFromWorkPlanDB(planEntryId) {
            const planRef = db_firestore.collection('weeklyPlan').doc(planEntryId);
            return await planRef.delete();
        }

        // ======================================================
        // ===== FUNCIONES B√ÅSICAS (Originales y Auxiliares) =====
        // ======================================================
        
        function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
        
        function escapeHTML(str) {
            if (str === null || typeof str === 'undefined') return '';
            return String(str)
                 .replace(/&/g, '&amp;')
                 .replace(/</g, '&lt;')
                 .replace(/>/g, '&gt;')
                 .replace(/"/g, '&quot;')
                 .replace(/'/g, '&#39;');
        }

        function showCustomAlert(message, type = 'info') {
            const alertDiv = document.getElementById('customAlert');
            let alertClass = 'bg-blue-100 border-blue-500 text-blue-800'; // info
            if (type === 'error') alertClass = 'bg-red-100 border-red-500 text-red-800';
            if (type === 'success') alertClass = 'bg-green-100 border-green-500 text-green-800';
            
            alertDiv.className = `p-4 mb-4 rounded-lg border-l-4 ${alertClass}`;
            alertDiv.innerHTML = `<strong class="font-semibold">${escapeHTML(message)}</strong>`;
            alertDiv.style.display = 'block';
            
            const duration = (type === 'error') ? 10000 : 5000;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, duration);
        }

        let confirmCallback = null;
        function showConfirmModal(message, onConfirmCallback) {
            document.getElementById('confirmModalMessage').textContent = message;
            confirmCallback = onConfirmCallback;
            document.getElementById('confirmModal').classList.add('active');
            document.body.classList.add('modal-open');
            
            const confirmBtn = document.getElementById('confirmModalConfirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirmModal();
            }, { once: true });
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            confirmCallback = null;
        }

        function showLoading(message = 'Cargando...') {
            if (document.getElementById('loadingOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay'; 
            overlay.innerHTML = `
                <div class="spinner"></div>
                <p>${escapeHTML(message)}</p> 
            `;
            document.body.appendChild(overlay);
        }
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // ======================================================
        // ===== L√ìGICA DE MANEJO DE EXCEL (Refactorizado) =====
        // ======================================================

        function handleDrop(e){
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        function handleFileSelect(e){
            const files = e.target.files;
            handleFiles(files);
        }
        function handleFiles(files){
            if (!files || files.length === 0) return;
            const file = files[0];
            document.getElementById('fileName').textContent = file.name;
            processFile(file);
        }

        /**
         * (Refactorizado) Procesa el Excel y lo fusiona con datos de Firebase
         */
        async function processFile(file) {
            showLoading('Procesando archivo Excel...');
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames.find(n => /working\s*pro[c]{1,2}ess\s*all/i.test(n));

                if (!sheetName) {
                    showCustomAlert('No se encontr√≥ la pesta√±a "Working Process All".', 'error');
                    document.getElementById('fileInput').value = ''; 
                    document.getElementById('fileName').textContent = '';
                    hideLoading();
                    return;
                }
                
                const worksheet = workbook.Sheets[sheetName];
                const arr = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                let headerIndex = -1;
                for (let i = 0; i < Math.min(arr.length, 12); i++) {
                    const row = arr[i].map(c => String(c).toLowerCase());
                    if (row.some(c => c.includes('fecha')) && row.some(c => c.includes('cliente'))) {
                        headerIndex = i;
                        break;
                    }
                }
                if (headerIndex === -1) {
                     showCustomAlert('No se pudo detectar la fila de encabezados.', 'error');
                    hideLoading();
                    return;
                }
                
                const headers = arr[headerIndex].map(h => String(h).trim().replace(/,/g, '').toLowerCase());
                const rows = arr.slice(headerIndex + 1);

                const colIndices = {
                    fecha: headers.findIndex(h => h.includes('fecha')),
                    cliente: headers.findIndex(h => h.includes('cliente')),
                    codigo: headers.findIndex(h => h.includes('codigo') || h.includes('contrato')),
                    estilo: headers.findIndex(h => h.includes('estilo')),
                    team: headers.findIndex(h => h.includes('team')),
                };

                const departmentPatterns = [
                    { pattern: /p[_\s]*order[_\s]*entry/i, name: 'P_Order_Entry' },
                    { pattern: /p[_\s]*art/i, name: 'P_Art' },
                    { pattern: /p[_\s]*printing/i, name: 'P_Printing' },
                    { pattern: /p[_\s]*press/i, name: 'P_Press' },
                    { pattern: /p[_\s]*cut/i, name: 'P_Cut' },
                    { pattern: /p[_\s]*r[_\s]*to[_\s]*sew/i, name: 'P_R_to_Sew' },
                    { pattern: /p[_\s]*sew/i, name: 'P_Sew' },
                    { pattern: /sum[_\s]*of[_\s]*twill/i, name: 'Sum of TWILL' },
                    { pattern: /p[_\s]*packing/i, name: 'P_Packing' },
                    { pattern: /p[_\s]*shipping/i, name: 'P_Shipping' }
                ];

                const departmentIndices = [];
                headers.forEach((header, index) => {
                    const matched = departmentPatterns.find(dept => dept.pattern.test(header));
                    if (matched) {
                        departmentIndices.push({ index: index, name: matched.name });
                    }
                });
                
                let processedOrders = []; // Usar un array temporal
                let currentDate = null;
                let currentClient = "";
                let currentContrato = "";
                let currentStyle = "";
                let currentTeam = "";
                
                for (const row of rows) {
                    if (!row || row.length === 0 || row.every(c => c === "" || c === null)) continue;
                    const lowerRow = row.slice(0, 4).map(c => String(c).toLowerCase());
                    if (lowerRow.some(c => c.includes('total') || c.includes('subtotal') || c.includes('grand'))) continue;

                    if (colIndices.fecha >= 0 && row[colIndices.fecha] !== "" && row[colIndices.fecha] !== null) {
                        const rawFecha = row[colIndices.fecha];
                        let deliveryDate = null;
                        if (typeof rawFecha === 'number') {
                            deliveryDate = new Date((rawFecha - 25569) * 86400 * 1000);
                        } else {
                            const d = new Date(rawFecha);
                            if (!isNaN(d)) deliveryDate = d;
                        }
                        if (deliveryDate && !isNaN(deliveryDate)) {
                            deliveryDate = new Date(Date.UTC(deliveryDate.getFullYear(), deliveryDate.getMonth(), deliveryDate.getDate()));
                        }
                        if (deliveryDate && !isNaN(deliveryDate)) {
                            currentDate = deliveryDate;
                        }
                    }
                    if (colIndices.cliente >= 0 && row[colIndices.cliente]) currentClient = String(row[colIndices.cliente]).trim();
                    if (colIndices.codigo >= 0 && row[colIndices.codigo]) currentContrato = String(row[colIndices.codigo]).trim();
                    if (colIndices.estilo >= 0 && row[colIndices.estilo]) currentStyle = String(row[colIndices.estilo]).trim();
                    if (colIndices.team >= 0 && row[colIndices.team]) currentTeam = String(row[colIndices.team]).trim();

                    if (!currentClient || !currentContrato) continue;

                    let orderCantidad = 0;
                    let orderDepartamento = "";
                    for (let i = departmentIndices.length - 1; i >= 0; i--) {
                        const col = departmentIndices[i];
                        const rawValue = row[col.index];
                        if (rawValue !== "" && rawValue !== null) {
                            const n = Number(String(rawValue).replace(/,|\s/g, ''));
                            if (!isNaN(n) && n > 0) {
                                orderCantidad = n;
                                orderDepartamento = col.name;
                                break; 
                            }
                        }
                    }
                    
                    if (orderCantidad <= 0) {
                        orderCantidad = 0;
                        orderDepartamento = "Sin Departamento";
                    }

                    const fechaDespacho = currentDate ? new Date(currentDate) : null;
                    const orderId = `${currentClient}_${currentContrato}_${fechaDespacho ? fechaDespacho.getTime() : 'nodate'}_${currentStyle}`;

                    const today = new Date(); today.setHours(0,0,0,0);
                    let daysLate = 0;
                    const isLate = fechaDespacho && fechaDespacho < today;
                    if (isLate) {
                        const diffTime = today.getTime() - fechaDespacho.getTime();
                        daysLate = Math.ceil(diffTime / (1000*60*60*24));
                    }
                    const isVeryLate = daysLate > 7;
                    const isAboutToExpire = fechaDespacho && !isLate && ((fechaDespacho.getTime() - today.getTime()) / (1000*60*60*24)) <= 2;
                    
                    // --- (NUEVO) Fusi√≥n con datos de Firebase ---
                    const fbData = firebaseAssignmentsMap.get(orderId);
                    let currentStatus = fbData ? fbData.customStatus : '';
                    let currentCompletedDate = fbData ? fbData.completedDate : null;

                    // L√≥gica de completado autom√°tico
                    if (fbData && 
                        (fbData.customStatus === 'Bandeja' || fbData.customStatus === 'Producci√≥n' || fbData.customStatus === 'Auditor√≠a') &&
                        orderDepartamento !== 'P_Art' && 
                        orderDepartamento !== 'Sin Departamento') 
                    {
                        currentStatus = 'Completada';
                        currentCompletedDate = new Date().toISOString();
                        
                        // Auto-actualizar en Firebase
                        const changes = [`Estado autom√°tico: ${fbData.customStatus} ‚Üí Completada (movido a ${orderDepartamento})`];
                        saveAssignmentToDB_Firestore(orderId, 
                            { customStatus: 'Completada', completedDate: currentCompletedDate }, 
                            changes
                        );
                    }

                    const order = {
                        orderId,
                        fechaDespacho,
                        cliente: currentClient,
                        codigoContrato: currentContrato,
                        estilo: currentStyle,
                        teamName: currentTeam,
                        departamento: orderDepartamento,
                        cantidad: orderCantidad, 
                        childPieces: 0, // Se calcular√° despu√©s
                        isLate,
                        daysLate,
                        isVeryLate,
                        isAboutToExpire,
                        // Datos de Firebase
                        designer: fbData ? fbData.designer : '',
                        customStatus: currentStatus,
                        receivedDate: fbData ? fbData.receivedDate : '', 
                        notes: fbData ? fbData.notes : '',
                        completedDate: currentCompletedDate
                    };

                    processedOrders.push(order);
                }

                // Asignar al array global
                allOrders = processedOrders;
                isExcelLoaded = true; // Marcar que el Excel ya se carg√≥
                console.log(`‚úÖ √ìrdenes procesadas del Excel: ${allOrders.length}`);

                needsRecalculation = true; 
                recalculateChildPieces(); // Construye el cach√© de hijas
                
                await updateDashboard();
                generateSummary();

                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                showCustomAlert('Error al procesar el archivo: ' + (error.message || error), 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // ======================================================
        // ===== L√ìGICA DE √ìRDENES HIJAS (Refactorizado) =====
        // ======================================================

        /**
         * (Refactorizado) Lee del mapa de Firebase
         */
        async function recalculateChildPieces() {
            if (!needsRecalculation) return;
            
            let tempChildPiecesCache = new Map();
            
            // firebaseChildOrdersMap (key: parentId, value: [child, child])
            firebaseChildOrdersMap.forEach((childList, parentId) => {
                const totalPieces = childList.reduce((sum, child) => sum + (child.cantidad || 0), 0);
                tempChildPiecesCache.set(parentId, totalPieces);
            });
            
            // Asigna los valores cacheados a allOrders
            for (const order of allOrders) {
                order.childPieces = tempChildPiecesCache.get(order.orderId) || 0;
            }
            
            needsRecalculation = false;
            console.log('Cach√© de piezas hijas reconstruido desde Firebase.');
        }

        async function saveChildOrder() {
            try {
                if (!currentEditingOrderId) return;
                
                const childNumber = document.getElementById('childOrderNumber').value;
                const childPieces = parseInt(document.getElementById('childPieces').value);
                const childDeliveryDate = document.getElementById('childDeliveryDate').value;
                const childNotes = document.getElementById('childNotes').value;
                
                if (!childNumber || childNumber < 1) {
                    showCustomAlert('Por favor ingresa un n√∫mero para la orden hija', 'error');
                    return;
                }
                if (!childPieces || childPieces < 1) {
                    showCustomAlert('Por favor ingresa la cantidad de piezas', 'error');
                    return;
                }
                
                const parentOrder = allOrders.find(o => o.orderId === currentEditingOrderId);
                if (!parentOrder) return;
                
                const childCode = `${parentOrder.codigoContrato}-${childNumber}`;
                
                // Verificar si ya existe en el mapa de Firebase
                const existingChildren = firebaseChildOrdersMap.get(parentOrder.orderId) || [];
                if (existingChildren.some(child => child.childCode === childCode)) {
                    showCustomAlert(`Ya existe una orden hija con el c√≥digo ${childCode}`, 'error');
                    return;
                }
                
                const deliveryDate = childDeliveryDate 
                    ? new Date(childDeliveryDate + 'T00:00:00Z') 
                    : (parentOrder.fechaDespacho ? new Date(parentOrder.fechaDespacho) : new Date());

                const childOrder = {
                    childOrderId: `${parentOrder.orderId}_child_${Date.now()}`, // ID √∫nico para Firestore
                    parentOrderId: parentOrder.orderId,
                    childCode: childCode,
                    cliente: parentOrder.cliente,
                    estilo: parentOrder.estilo,
                    teamName: parentOrder.teamName,
                    designer: parentOrder.designer,
                    customStatus: parentOrder.customStatus,
                    fechaDespacho: deliveryDate,
                    cantidad: childPieces,
                    notes: childNotes,
                    createdAt: new Date().toISOString()
                };
                
                // Guardar en Firestore
                await saveChildOrderToDB(childOrder);
                // Guardar historial en Firestore
                await saveAssignmentToDB_Firestore(parentOrder.orderId, {}, [`Orden hija creada: ${childCode} (${childPieces} piezas)`]);

                // onSnapshot se encargar√° de actualizar los mapas y la UI
                closeAddChildModal();
                showCustomAlert(`Orden hija ${childCode} creada exitosamente`, 'success');
                // No es necesario llamar a updateDashboard(), onSnapshot lo har√°.
                
            } catch (error) {
                console.error('Error en saveChildOrder:', error);
                showCustomAlert(`Error al guardar orden hija: ${error.message}`, 'error');
            }
        }
        
        async function deleteChildOrder(childOrderId, childCode) {
            showConfirmModal(`¬øEst√°s seguro de eliminar la orden hija ${childCode}?`, async () => {
                try {
                    // 1. Eliminar de Firestore
                    await deleteChildOrderFromDB(childOrderId);
                    
                    // 2. Guardar historial
                    await saveAssignmentToDB_Firestore(currentEditingOrderId, {}, [`Orden hija eliminada: ${childCode}`]);
                    
                    // onSnapshot se encargar√° de actualizar todo
                    
                } catch (e) {
                    console.error('Error en deleteChildOrder:', e);
                    showCustomAlert(e.message, 'error');
                }
            });
        }
        
        /**
         * (Refactorizado) Carga √≥rdenes hijas desde el Mapa de Firebase
         */
        async function loadChildOrders() {
            try {
                if (!currentEditingOrderId) return;
                
                const parentOrder = allOrders.find(o => o.orderId === currentEditingOrderId);
                // Leer del mapa de Firebase
                const childOrders = firebaseChildOrdersMap.get(currentEditingOrderId) || [];
                
                const childOrdersList = document.getElementById('childOrdersList');
                const childOrderCount = document.getElementById('childOrderCount');
                
                childOrderCount.textContent = childOrders.length;
                
                if (childOrders.length === 0) {
                    childOrdersList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No hay √≥rdenes hijas</p>';
                    return;
                }
                
                childOrdersList.innerHTML = childOrders.map(child => {
                    const deliveryDate = child.fechaDespacho ? new Date(child.fechaDespacho) : null;
                    const today = new Date(); today.setHours(0,0,0,0);
                    const isLate = deliveryDate && deliveryDate < today;
                    
                    const statusBadge = isLate 
                        ? '<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded-full text-xs font-medium ml-2">Atrasada</span>' 
                        : '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium ml-2">A Tiempo</span>';
                    
                    const safeChildCode = escapeHTML(child.childCode);
                    const safeChildOrderId = escapeHTML(child.childOrderId); // Usar el ID de Firestore
                    const safeNotes = child.notes ? `<div class="mt-1"><strong class="text-gray-600">Notas:</strong> ${escapeHTML(child.notes)}</div>` : '';

                    return `
                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <strong class="text-blue-600 font-semibold">${safeChildCode}</strong>
                                    ${statusBadge}
                                </div>
                                <button class="btn-delete-child font-medium py-1 px-2 rounded-lg text-xs transition-colors bg-red-100 text-red-700 hover:bg-red-200" 
                                        data-child-id="${safeChildOrderId}" 
                                        data-child-code="${safeChildCode}"
                                        ${parentOrder.departamento !== 'P_Art' ? 'disabled' : ''} 
                                        aria-label="Eliminar orden hija ${safeChildCode}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                      <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.518.149.022a.75.75 0 1 0 .23-1.482A41.03 41.03 0 0 0 14 4.193v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75a1.25 1.25 0 0 0-1.25-1.25h-2.5A1.25 1.25 0 0 0 7.5 3.75v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 space-y-1">
                                <div><strong class="text-gray-600">Piezas:</strong> ${child.cantidad.toLocaleString()}</div>
                                <div><strong class="text-gray-600">Fecha:</strong> ${deliveryDate ? formatDate(deliveryDate) : '-'}</div>
                                ${safeNotes}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error en loadChildOrders:', error);
                showCustomAlert(`Error al cargar √≥rdenes hijas: ${error.message}`, 'error');
            }
        }

        function openAddChildModal() {
            if (!currentEditingOrderId) return;
            const parentOrder = allOrders.find(o => o.orderId === currentEditingOrderId);
            if (!parentOrder) return;
            
            document.getElementById('parentOrderInfo').textContent = 
                `${parentOrder.codigoContrato} - ${parentOrder.cliente} - ${parentOrder.estilo}`;
            document.getElementById('childOrderNumber').value = '';
            document.getElementById('childOrderCode').value = '';
            document.getElementById('childPieces').value = '';
            document.getElementById('childDeliveryDate').value = '';
            document.getElementById('childNotes').value = '';
            
            document.getElementById('addChildModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        function closeAddChildModal() {
            document.getElementById('addChildModal').classList.remove('active');
        }
        function updateChildOrderCode() {
            if (!currentEditingOrderId) return;
            const parentOrder = allOrders.find(o => o.orderId === currentEditingOrderId);
            if (!parentOrder) {
                console.error('No se encontr√≥ la orden padre');
                return;
            }
            const childNumber = document.getElementById('childOrderNumber').value;
            const childCodeInput = document.getElementById('childOrderCode');
            
            if (childNumber) {
                childCodeInput.value = `${parentOrder.codigoContrato}-${childNumber}`;
            } else {
                childCodeInput.value = '';
            }
        }
        
        // ======================================================
        // ===== L√ìGICA DE MODALES (Refactorizado) =====
        // ======================================================

        /**
         * (Refactorizado) Abre el modal principal, leyendo de `allOrders` y mapas de Firebase
         */
        window.openAssignModal = async function(orderId) {
            try {
                currentEditingOrderId = orderId;
                const order = allOrders.find(o => o.orderId === orderId);
                if (!order) return;
                
                document.getElementById('detailCliente').textContent = order.cliente || '-';
                document.getElementById('detailCodigo').textContent = order.codigoContrato || '-';
                document.getElementById('detailEstilo').textContent = order.estilo || '-';
                document.getElementById('detailDepartamento').textContent = order.departamento || '-';
                document.getElementById('detailFecha').textContent = formatDate(order.fechaDespacho);
                document.getElementById('detailPiezas').textContent = (order.cantidad || 0).toLocaleString();
                
                // Leer datos de Firebase (fusionados en 'order' al cargar Excel)
                document.getElementById('modalDesigner').value = order.designer || '';
                document.getElementById('modalStatus').value = order.customStatus || '';
                document.getElementById('modalReceivedDate').value = order.receivedDate || '';
                document.getElementById('modalNotes').value = order.notes || '';
                
                // Leer historial del mapa de Firebase
                const history = firebaseHistoryMap.get(orderId) || [];
                
                const isPArt = order.departamento === 'P_Art';
                document.getElementById('modalDesigner').disabled = !isPArt;
                document.getElementById('modalStatus').disabled = !isPArt;
                document.getElementById('modalReceivedDate').disabled = !isPArt;
                document.getElementById('addChildOrderBtn').disabled = !isPArt;
                document.getElementById('modalNotes').disabled = false; 

                const historyDiv = document.getElementById('modalHistory');
                if (history && history.length > 0) {
                    historyDiv.innerHTML = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(item => `
                        <div class="history-item p-2 bg-white rounded border border-gray-200">
                            <div class="history-date text-xs text-gray-500 mb-1">
                                ${new Date(item.timestamp).toLocaleString('es-ES')}
                                <strong class="text-gray-700 ml-2">${escapeHTML(item.user || 'Sistema')}</strong>
                            </div>
                            <div class="history-change text-sm text-gray-800">${escapeHTML(item.change)}</div>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Sin historial</p>';
                }
                
                await loadChildOrders(); // Carga hijas desde el mapa de Firebase
                
                document.getElementById('assignModal').classList.add('active');
                document.body.classList.add('modal-open');
            } catch (error) {
                console.error('Error en openAssignModal:', error);
                showCustomAlert(`Error al abrir el modal: ${error.message}`, 'error');
            }
        }
        
        window.closeModal = function() {
            document.getElementById('assignModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            currentEditingOrderId = null;
        }

        /**
         * (NUEVO) Funci√≥n para el bot√≥n "Asignarme a m√≠"
         */
        async function asignarmeAmi() {
            if (!usuarioActual) {
                showCustomAlert("Error: No se pudo identificar al usuario. Vuelve a iniciar sesi√≥n.", "error");
                return;
            }
            if (!currentEditingOrderId) return;
            
            const nombreUsuario = usuarioActual.displayName;
            const order = allOrders.find(o => o.orderId === currentEditingOrderId);
            if (!order) return;

            // Datos actuales (del mapa de Firebase, via allOrders)
            const oldDesigner = order.designer;
            const oldStatus = order.customStatus;

            // No hacer nada si ya est√° asignado a este usuario
            if (oldDesigner === nombreUsuario) {
                showCustomAlert(`Esta orden ya est√° asignada a ti.`, "info");
                return;
            }

            // Establecer estado a 'Bandeja' si no tiene estado
            const newStatus = (oldStatus === '' || !oldStatus) ? 'Bandeja' : oldStatus;

            const dataToSave = {
                designer: nombreUsuario,
                customStatus: newStatus
            };
            
            const changes = [];
            changes.push(`Dise√±ador: ${oldDesigner || 'Sin asignar'} ‚Üí ${nombreUsuario}`);
            if (newStatus !== oldStatus) {
                changes.push(`Estado: ${oldStatus || 'Sin estado'} ‚Üí ${newStatus}`);
            }

            try {
                await saveAssignmentToDB_Firestore(currentEditingOrderId, dataToSave, changes);
                showCustomAlert(`Orden asignada a ${nombreUsuario}`, "success");
                closeModal();
                // onSnapshot se encargar√° de actualizar la UI
                
            } catch (error) {
                console.error("Error en asignarmeAmi:", error);
                showCustomAlert(`Error al asignar: ${error.message}`, "error");
            }
        }

        /**
         * (Refactorizado) Funci√≥n para el bot√≥n "Guardar Cambios" (Manual)
         */
        window.saveAssignment = async function() {
            if (!currentEditingOrderId) return;
            
            try {
                const order = allOrders.find(o => o.orderId === currentEditingOrderId);
                if (!order) return;

                // Datos actuales (del mapa de Firebase, via allOrders)
                const oldAssignment = {
                    designer: order.designer,
                    customStatus: order.customStatus,
                    receivedDate: order.receivedDate,
                    notes: order.notes,
                    completedDate: order.completedDate
                };
                
                // Nuevos datos del modal
                const newDesigner = document.getElementById('modalDesigner').value;
                const newStatus = document.getElementById('modalStatus').value;
                const newReceivedDate = document.getElementById('modalReceivedDate').value;
                const newNotes = document.getElementById('modalNotes').value;
                
                const isPArt = order.departamento === 'P_Art';
                const changes = [];
                let dataToSave = {};

                if (isPArt) {
                    if (oldAssignment.designer !== newDesigner) {
                        changes.push(`Dise√±ador: ${oldAssignment.designer || 'Sin asignar'} ‚Üí ${newDesigner || 'Sin asignar'}`);
                        dataToSave.designer = newDesigner;
                    }
                    if (oldAssignment.customStatus !== newStatus) {
                        changes.push(`Estado: ${oldAssignment.customStatus || 'Sin estado'} ‚Üí ${newStatus || 'Sin estado'}`);
                        dataToSave.customStatus = newStatus;
                        
                        if (newStatus === 'Completada' && oldAssignment.customStatus !== 'Completada') {
                            dataToSave.completedDate = new Date().toISOString();
                            changes.push(`Completada el: ${new Date().toLocaleDateString('es-ES')}`);
                        } else if (newStatus !== 'Completada' && oldAssignment.customStatus === 'Completada') {
                            dataToSave.completedDate = null; 
                            changes.push(`Revertida de 'Completada'`);
                        }
                    }
                    if (oldAssignment.receivedDate !== newReceivedDate) {
                        if (newReceivedDate) {
                            const formattedDate = new Date(newReceivedDate + 'T00:00:00Z').toLocaleDateString('es-ES');
                            const oldDateFormatted = oldAssignment.receivedDate ? new Date(oldAssignment.receivedDate + 'T00:00:00Z').toLocaleDateString('es-ES') : 'Sin fecha';
                            changes.push(`Fecha Recibida: ${oldDateFormatted} ‚Üí ${formattedDate}`);
                            dataToSave.receivedDate = newReceivedDate;
                        }
                    }
                }
                
                if (oldAssignment.notes !== newNotes) {
                    changes.push(`Nota actualizada: "${newNotes}"`);
                    dataToSave.notes = newNotes;
                }
                
                if (changes.length > 0) {
                    await saveAssignmentToDB_Firestore(currentEditingOrderId, dataToSave, changes);
                    showCustomAlert('Cambios guardados en la nube', 'success');
                } else {
                    showCustomAlert('No se detectaron cambios', 'info');
                }
                
                closeModal();
                // onSnapshot se encargar√° de actualizar la UI
                
            } catch (error) {
                console.error('Error en saveAssignment:', error);
                showCustomAlert(`Error al guardar: ${error.message}`, 'error');
            }
        }
        
        // --- Modales de Multi-Asignaci√≥n (Refactorizado) ---
        
        function openMultiAssignModal() {
            if (selectedOrders.size === 0) return;
            
            let allInPArt = true;
            const selectedOrdersList = document.getElementById('selectedOrdersList');
            let listHTML = '';
            
            for (const orderId of selectedOrders) {
                const order = allOrders.find(o => o.orderId === orderId);
                if (order) {
                    if(order.departamento !== 'P_Art') {
                        allInPArt = false;
                        break;
                    }
                    listHTML += `<div class="selected-order-item py-2 border-b border-gray-200 last:border-b-0 text-sm text-gray-800">
                        <strong class="font-medium text-gray-900">${escapeHTML(order.codigoContrato)}</strong> - ${escapeHTML(order.cliente)} - ${escapeHTML(order.estilo)}
                    </div>`;
                }
            }

            if (!allInPArt) {
                showCustomAlert("Error: Solo puedes asignar en masa √≥rdenes que est√°n en P_Art.", 'error');
                clearSelection();
                return;
            }
            
            document.getElementById('multiModalCount').textContent = selectedOrders.size;
            selectedOrdersList.innerHTML = listHTML;
            document.getElementById('multiModalDesigner').innerHTML = '<option value="">Sin asignar</option>' + designerList.map(name => `<option value="${escapeHTML(name)}">${escapeHTML(name)}</option>`).join('');
            document.getElementById('multiModalDesigner').value = '';
            document.getElementById('multiModalStatus').value = '';
            document.getElementById('multiModalReceivedDate').value = '';
            document.getElementById('multiModalNotes').value = '';
            
            document.getElementById('multiAssignModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function closeMultiModal() {
            document.getElementById('multiAssignModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        /**
         * (Refactorizado) Guarda m√∫ltiples asignaciones usando un Batch de Firestore
         */
        async function saveMultiAssignment() {
            if (selectedOrders.size === 0) return;
            
            try {
                const newDesigner = document.getElementById('multiModalDesigner').value;
                const newStatus = document.getElementById('multiModalStatus').value;
                const newReceivedDate = document.getElementById('multiModalReceivedDate').value;
                const newNotes = document.getElementById('multiModalNotes').value;
                
                let changesCount = 0;
                
                // ¬°Usar un Batch de Firestore para una sola operaci√≥n!
                const batch = db_firestore.batch();
                const user = usuarioActual.displayName || usuarioActual.email;
                
                for (const orderId of selectedOrders) {
                    const order = allOrders.find(o => o.orderId === orderId);
                    if (!order || order.departamento !== 'P_Art') continue; 
                    
                    const oldAssignment = firebaseAssignmentsMap.get(orderId) || {};
                    const changes = [];
                    let dataToSave = {};

                    if (newDesigner) {
                        if (oldAssignment.designer !== newDesigner) {
                            changes.push(`Dise√±ador: ${oldAssignment.designer || 'Sin asignar'} ‚Üí ${newDesigner}`);
                            dataToSave.designer = newDesigner;
                        }
                    }
                    if (newStatus) {
                        if (oldAssignment.customStatus !== newStatus) {
                            changes.push(`Estado: ${oldAssignment.customStatus || 'Sin estado'} ‚Üí ${newStatus}`);
                            dataToSave.customStatus = newStatus;
                            
                            if (newStatus === 'Completada' && oldAssignment.customStatus !== 'Completada') {
                                dataToSave.completedDate = new Date().toISOString();
                                changes.push(`Completada el: ${new Date().toLocaleDateString('es-ES')}`);
                            } else if (newStatus !== 'Completada') {
                                dataToSave.completedDate = null; 
                            }
                        }
                    }
                    if (newReceivedDate) {
                         if (oldAssignment.receivedDate !== newReceivedDate) {
                            const formattedDate = new Date(newReceivedDate + 'T00:00:00Z').toLocaleDateString('es-ES');
                            const oldDateFormatted = oldAssignment.receivedDate ? new Date(oldAssignment.receivedDate + 'T00:00:00Z').toLocaleDateString('es-ES') : 'Sin fecha';
                            changes.push(`Fecha Recibida: ${oldDateFormatted} ‚Üí ${formattedDate}`);
                            dataToSave.receivedDate = newReceivedDate;
                        }
                    }
                    if (newNotes) {
                        if (oldAssignment.notes !== newNotes) {
                            changes.push(`Nota actualizada: "${newNotes}"`);
                            dataToSave.notes = newNotes;
                        }
                    }
                    
                    if (changes.length > 0) {
                        dataToSave.lastModified = new Date().toISOString();
                        const assignmentRef = db_firestore.collection('assignments').doc(orderId);
                        batch.set(assignmentRef, dataToSave, { merge: true });
                        
                        // Guardar historial para cada una
                        const historyRef = db_firestore.collection('history').doc();
                        batch.set(historyRef, {
                            orderId: orderId,
                            change: `Asignaci√≥n m√∫ltiple: ${changes.join(', ')}`,
                            user: user,
                            timestamp: new Date().toISOString()
                        });
                        
                        changesCount++;
                    }
                }
                
                // Enviar todo el lote a Firestore
                await batch.commit();
                
                closeMultiModal();
                clearSelection();
                // onSnapshot se encargar√° de actualizar la UI
                
                showCustomAlert(`Se han actualizado ${changesCount} de ${selectedOrders.size} √≥rdenes en la nube.`, 'success');
            } catch (error) {
                console.error('Error en saveMultiAssignment:', error);
                showCustomAlert(`Error al guardar: ${error.message}`, 'error');
            }
        }
        
        // ======================================================
        // ===== L√ìGICA DE UI (Refactorizada y Original) =====
        // ======================================================

        function updateAllDesignerDropdowns() {
            // 'designerList' ahora se actualiza desde onSnapshot
            const optionsHTML = '<option value="">Todos</option>' + designerList.map(name => `<option value="${escapeHTML(name)}">${escapeHTML(name)}</option>`).join('');
            const modalOptionsHTML = '<option value="">Sin asignar</option>' + designerList.map(name => `<option value="${escapeHTML(name)}">${escapeHTML(name)}</option>`).join('');

            document.getElementById('designerFilter').innerHTML = optionsHTML;
            document.getElementById('modalDesigner').innerHTML = modalOptionsHTML;
            document.getElementById('multiModalDesigner').innerHTML = modalOptionsHTML;
            
            document.getElementById('designerFilter').value = currentDesignerFilter;
        }

        function populateDesignerManagerModal() {
            // 'firebaseDesignersMap' se actualiza desde onSnapshot
            const listDiv = document.getElementById('designerManagerList');
            listDiv.innerHTML = '';
            
            if (firebaseDesignersMap.size === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center">No hay dise√±adores en Firebase</p>';
                return;
            }

            firebaseDesignersMap.forEach((data, docId) => {
                const safeName = escapeHTML(data.name);
                listDiv.innerHTML += `
                    <div class="designer-item flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg">
                        <span class="designer-item-name font-medium text-gray-800">${safeName}</span>
                        <button class="btn-delete-designer font-medium py-1 px-3 rounded-lg text-xs transition-colors shadow-sm bg-red-100 text-red-700 hover:bg-red-200 flex items-center gap-1" 
                                data-name="${safeName}"
                                data-id="${escapeHTML(docId)}"> <!-- (NUEVO) A√±adir ID de doc -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                              <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.518.149.022a.75.75 0 1 0 .23-1.482A41.03 41.03 0 0 0 14 4.193v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75a1.25 1.25 0 0 0-1.25-1.25h-2.5A1.25 1.25 0 0 0 7.5 3.75v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                            </svg>
                            Eliminar
                        </button>
                    </div>
                `;
            });
        }
        
        function openDesignerManager() {
            populateDesignerManagerModal(); // Se llena desde el mapa de Firebase
            document.getElementById('designerManagerModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        function closeDesignerManager() {
            document.getElementById('designerManagerModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        // --- L√≥gica de Selecci√≥n M√∫ltiple (Original) ---
        function toggleOrderSelection(orderId) {
            if (selectedOrders.has(orderId)) {
                selectedOrders.delete(orderId);
            } else {
                selectedOrders.add(orderId);
            }
            updateMultiSelectBar();
            updateCheckboxes();
        }
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const ordersOnPage = paginatedOrders
                .filter(o => o.departamento === 'P_Art')
                .map(o => o.orderId);
            
            if (selectAllCheckbox.checked) {
                ordersOnPage.forEach(id => selectedOrders.add(id));
            } else {
                ordersOnPage.forEach(id => selectedOrders.delete(id));
            }
            updateMultiSelectBar();
            updateCheckboxes();
        }
        function clearSelection() {
            selectedOrders.clear();
            updateMultiSelectBar();
            updateCheckboxes();
        }
        function updateMultiSelectBar() {
            const bar = document.getElementById('multiSelectBar');
            const count = document.getElementById('selectedCount');
            if (selectedOrders.size > 0) {
                bar.classList.add('active'); 
                count.textContent = selectedOrders.size;
            } else {
                bar.classList.remove('active');
            }
        }
        function updateCheckboxes() {
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach((checkbox) => {
                const orderId = checkbox.dataset.orderId;
                if (orderId) {
                    checkbox.checked = selectedOrders.has(orderId);
                }
            });
            const selectAllCheckbox = document.getElementById('selectAll');
            const pArtOrdersOnPage = paginatedOrders.filter(o => o.departamento === 'P_Art');
            const allOnPageSelected = pArtOrdersOnPage.length > 0 && pArtOrdersOnPage.every(order => selectedOrders.has(order.orderId));
            selectAllCheckbox.checked = allOnPageSelected;
        }
        
        // --- L√≥gica de Plan Semanal (Refactorizado) ---
        async function addSelectedToWorkPlan() {
            if (selectedOrders.size === 0) {
                showCustomAlert('No hay √≥rdenes seleccionadas', 'error');
                return;
            }
            const weekIdentifier = getWeekIdentifier(new Date());
            let addedCount = 0;
            let skippedCount = 0;
            let errorMsg = '';
            for (const orderId of selectedOrders) {
                const order = allOrders.find(o => o.orderId === orderId);
                if (!order || order.departamento !== 'P_Art') {
                    errorMsg = 'Solo se pueden agregar √≥rdenes de P_Art al plan.';
                    skippedCount++;
                    continue;
                }
                if (!order.designer) {
                    errorMsg = 'Solo se pueden agregar √≥rdenes ASIGNADAS al plan.';
                    skippedCount++;
                    continue;
                }
                try {
                    // Llama a la funci√≥n de Firestore
                    const added = await addOrderToWorkPlanDB(order, weekIdentifier);
                    if (added) {
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } catch (e) {
                    console.error('Error agregando al plan:', e);
                    showCustomAlert(`Error al guardar en DB: ${e.message}`, 'error');
                    return; 
                }
            }
            let successMsg = `Se agregaron ${addedCount} √≥rdenes al plan de esta semana (${weekIdentifier}).`;
            if (skippedCount > 0) {
                successMsg += ` Se omitieron ${skippedCount} (probablemente ya estaban en el plan).`;
            }
            if (errorMsg && addedCount === 0) {
                showCustomAlert(errorMsg, 'error');
            } else {
                showCustomAlert(successMsg, 'success');
            }
            clearSelection();
            // onSnapshot se encargar√° de actualizar
        }

        // --- L√≥gica de Paginaci√≥n (Original) ---
        function setupPagination(filteredOrders) {
            const totalItems = filteredOrders.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            if (currentPage > totalPages) { currentPage = totalPages; }
            if (currentPage < 1) { currentPage = 1; }
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            paginatedOrders = filteredOrders.slice(start, end);
            document.getElementById('currentPage').textContent = totalPages === 0 ? 0 : currentPage;
            document.getElementById('totalPages').textContent = totalPages || 1;
            renderPaginationControls(totalPages);
        }
        function renderPaginationControls(totalPages) {
            const controlsDiv = document.getElementById('paginationControls');
            controlsDiv.innerHTML = '';
            controlsDiv.innerHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            if (startPage > 1) {
                controlsDiv.innerHTML += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    controlsDiv.innerHTML += `<button disabled>...</button>`;
                }
            }
            for (let i = startPage; i <= endPage; i++) {
                controlsDiv.innerHTML += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    controlsDiv.innerHTML += `<button disabled>...</button>`;
                }
                controlsDiv.innerHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            controlsDiv.innerHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>Siguiente &raquo;</button>`;
        }
        window.changePage = function(page) {
            const totalPages = Math.ceil(getFilteredOrders(false).length / rowsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateTable();
        }
        window.changeRowsPerPage = function() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value, 10);
            currentPage = 1; 
            updateTable();
        }

        // --- L√≥gica de UI y Actualizaci√≥n (Original, pero datos vienen de `allOrders` fusionado) ---
        function populateFilterDropdowns() {
            const clients = [...new Set(allOrders.map(o => o.cliente))].filter(Boolean).sort();
            const styles = [...new Set(allOrders.map(o => o.estilo))].filter(Boolean).sort();
            const teams = [...new Set(allOrders.map(o => o.teamName))].filter(Boolean).sort();
            const departamentos = [...new Set(allOrders.map(o => o.departamento))].filter(Boolean).sort();
            const designers = designerList; // Ya viene de Firebase
            const statuses = [...new Set(allOrders.map(o => o.customStatus))].filter(Boolean).sort();
            CUSTOM_STATUS_OPTIONS.forEach(opt => {
                if (!statuses.includes(opt)) statuses.push(opt);
            });
            populateSelect('clientFilter', clients, currentClientFilter);
            populateSelect('styleFilter', styles, currentStyleFilter);
            populateSelect('teamFilter', teams, currentTeamFilter);
            populateSelect('departamentoFilter', departamentos, currentDepartamentoFilter);
            populateSelect('designerFilter', designers, currentDesignerFilter);
            populateSelect('customStatusFilter', statuses, currentCustomStatusFilter);
            updateAllDesignerDropdowns(); // Asegurar que todo est√© sincronizado
        }
        function populateSelect(elementId, options, selectedValue) {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="">Todos</option>';
            options.forEach(option => {
                const safeOption = escapeHTML(option);
                select.innerHTML += `<option value="${safeOption}">${safeOption}</option>`;
            });
            select.value = selectedValue;
        }
        
        async function generateSummary() {
            const artOrders = allOrders.filter(o => o.departamento === 'P_Art');
            const stats = calculateStats(artOrders);
            const summaryBox = document.getElementById('summaryBox');
            let summaryText = `Resumen: Tienes ${stats.total} √≥rdenes activas en P_Art con ${stats.totalPieces.toLocaleString()} piezas totales (incluyendo hijas).`;
            if (stats.veryLate > 0) { summaryText += ` ${stats.veryLate} √≥rdenes est√°n muy atrasadas (m√°s de 7 d√≠as).`; }
            if (stats.aboutToExpire > 0) { summaryText += ` ${stats.aboutToExpire} √≥rdenes vencen en 1-2 d√≠as.`; }
            if (stats.thisWeek > 0) { summaryText += ` Tienes ${stats.thisWeek} √≥rdenes para esta semana.`; }
            if (stats.late === 0 && stats.aboutToExpire === 0) { summaryText += ` No tienes √≥rdenes atrasadas en P_Art.`; }
            summaryBox.innerHTML = `<h3 class="text-lg font-semibold text-gray-900 mb-2">Estado Actual (P_Art)</h3><p class="text-gray-700 leading-relaxed">${escapeHTML(summaryText)}</p>`;
        }
        
        function generateReports() {
            const clientCounts = {};
            allOrders.filter(o => o.cantidad > 0).forEach(o => {
                if (o.cliente) {
                    clientCounts[o.cliente] = (clientCounts[o.cliente] || 0) + 1;
                }
            });
            const sortedClients = Object.entries(clientCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const clientReport = document.getElementById('clientReport');
            clientReport.innerHTML = sortedClients.map(([client, count]) => 
                `<div class="report-item flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0 text-sm">
                    <span class="text-gray-700">${escapeHTML(client)}</span>
                    <strong class="font-medium text-gray-900">${count}</strong>
                </div>`
            ).join('') || '<div class="report-item text-gray-500 text-center py-4">No hay datos</div>';
            generateWorkloadReport();
        }
        
        function generateWorkloadReport() {
            const designerStats = {};
            designerList.forEach(designer => {
                designerStats[designer] = { orders: 0, pieces: 0 };
            });
            let totalPiecesInPArt = 0;
            allOrders.forEach(order => {
                if (order.departamento === 'P_Art' && order.designer && designerStats.hasOwnProperty(order.designer)) {
                    designerStats[order.designer].orders++;
                    const totalOrderPieces = (order.cantidad || 0) + (order.childPieces || 0);
                    designerStats[order.designer].pieces += totalOrderPieces;
                    if (order.designer !== 'Magdali Fernadez') { 
                        totalPiecesInPArt += totalOrderPieces;
                    }
                }
            });
            document.getElementById('workloadTotal').textContent = 
                `${totalPiecesInPArt.toLocaleString()} piezas (en P_Art, sin Magdali F.)`;
            const workloadList = document.getElementById('workloadList');
            let html = '';
            designerList.forEach(designer => {
                const stats = designerStats[designer];
                const percentage = totalPiecesInPArt > 0 && designer !== 'Magdali Fernadez'
                    ? ((stats.pieces / totalPiecesInPArt) * 100).toFixed(1)
                    : 0;
                const displayPercentage = designer === 'Magdali Fernadez' ? '-' : `${percentage}%`;
                html += `
                    <div class="workload-item">
                        <div class="workload-header flex justify-between items-center mb-1.5">
                            <span class="designer-name font-semibold text-gray-800">${escapeHTML(designer)}</span>
                            <span class="workload-stats text-xs text-gray-500">
                                ${stats.orders} √≥rdenes | ${stats.pieces.toLocaleString()} pzs | ${displayPercentage}
                            </span>
                        </div>
                        <div class="progress-bar w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="progress-fill h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-300" style="width: ${designer === 'Magdali Fernadez' ? 0 : percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            workloadList.innerHTML = html;
        }
        
        function clearAllFilters() {
            currentClientFilter = '';
            currentStyleFilter = '';
            currentTeamFilter = '';
            currentDepartamentoFilter = '';
            currentDesignerFilter = '';
            currentCustomStatusFilter = '';
            currentDateFrom = '';
            currentDateTo = '';
            currentSearch = '';
            currentFilter = 'all';
            currentDateFilter = 'all';
            document.getElementById('clientFilter').value = '';
            document.getElementById('styleFilter').value = '';
            document.getElementById('teamFilter').value = '';
            document.getElementById('departamentoFilter').value = '';
            document.getElementById('designerFilter').value = '';
            document.getElementById('customStatusFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('searchInput').value = '';
            currentPage = 1; 
            updateDashboard();
        }

        /**
         * (Refactorizado) Esta funci√≥n ahora solo actualiza la UI.
         * La fusi√≥n de datos ocurre en `mergeYActualizar`.
         */
        async function updateDashboard() {
            if (!isExcelLoaded) return; // No hacer nada si el Excel no est√° cargado
            
            if (needsRecalculation) {
                recalculateChildPieces(); // Sincr√≥nico, lee del mapa
            }
            
            const artOrders = allOrders.filter(o => o.departamento === 'P_Art');
            const stats = calculateStats(artOrders);
            
            updateStats(stats);
            updateAlerts(stats);
            updateFilters(stats);
            
            generateReports();
            populateFilterDropdowns();
            updateTable(); 
            updateAllDesignerDropdowns(); 
        }

        function calculateStats(ordersToStat) {
            const total = ordersToStat.length;
            const late = ordersToStat.filter(o => o.isLate).length;
            const veryLate = ordersToStat.filter(o => o.isVeryLate).length;
            const aboutToExpire = ordersToStat.filter(o => o.isAboutToExpire).length;
            const onTime = ordersToStat.filter(o => !o.isLate && !o.isAboutToExpire).length;
            let totalPieces = ordersToStat.reduce((sum, order) => {
                return sum + (order.cantidad || 0) + (order.childPieces || 0);
            }, 0);
            const today = new Date(); today.setHours(0,0,0,0);
            const thisWeekEnd = new Date(today); 
            thisWeekEnd.setDate(today.getDate()+7);
            const thisWeek = ordersToStat.filter(o => o.fechaDespacho && o.fechaDespacho >= today && o.fechaDespacho <= thisWeekEnd).length;
            return { total, late, veryLate, aboutToExpire, onTime, thisWeek, totalPieces };
        }
        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statTotalPieces').textContent = (stats.totalPieces || 0).toLocaleString();
            document.getElementById('statLate').textContent = stats.late;
            document.getElementById('statExpiring').textContent = stats.aboutToExpire;
            document.getElementById('statOnTime').textContent = stats.onTime;
            document.getElementById('statThisWeek').textContent = stats.thisWeek;
        }
        
        function updateAlerts(stats) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            const baseClasses = "p-4 mb-4 rounded-lg border-l-4 cursor-pointer transition-colors";
            const hoverDanger = "hover:bg-red-200";
            const hoverWarning = "hover:bg-yellow-200";
            const hoverInfo = "hover:bg-blue-200";
            if (stats.veryLate > 0) {
                alertsDiv.innerHTML += `<div class="alert ${baseClasses} bg-red-100 border-red-500 text-red-800 ${hoverDanger}" onclick="setFilter('veryLate')" title="Haz clic para ver estas √≥rdenes"><strong class="font-semibold">URGENTE (P_Art):</strong> ${stats.veryLate} √≥rdenes con m√°s de 7 d√≠as de atraso</div>`;
            }
            if (stats.aboutToExpire > 0) {
                alertsDiv.innerHTML += `<div class="alert ${baseClasses} bg-yellow-100 border-yellow-500 text-yellow-800 ${hoverWarning}" onclick="setFilter('aboutToExpire')" title="Haz clic para ver estas √≥rdenes"><strong class="font-semibold">ATENCI√ìN (P_Art):</strong> ${stats.aboutToExpire} √≥rdenes vencen en 1-2 d√≠as</div>`;
            }
            if (stats.thisWeek > 0 && stats.late === 0) {
                alertsDiv.innerHTML += `<div class="alert ${baseClasses} bg-blue-100 border-blue-500 text-blue-800 ${hoverInfo}" onclick="setDateFilter('thisWeek')" title="Haz clic para ver estas √≥rdenes"><strong class="font-semibold">Esta Semana (P_Art):</strong> ${stats.thisWeek} √≥rdenes deben despacharse en 7 d√≠as</div>`;
            }
            if (stats.late === 0 && stats.aboutToExpire === 0) {
                alertsDiv.innerHTML += `<div class="alert ${baseClasses} bg-green-100 border-green-500 text-green-800 !cursor-default"><strong class="font-semibold">Perfecto:</strong> No tienes √≥rdenes atrasadas ni por vencer en P_Art</div>`;
            }
        }
        
        function updateFilters(stats) {
            const statusFilters = document.getElementById('statusFilters');
            const btnBase = "flex-1 font-medium py-2 px-3 text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50";
            const btnInactive = "bg-white text-gray-700 hover:bg-gray-100 border-l border-gray-300 first:border-l-0";
            const btnActive = "bg-blue-600 text-white shadow-inner";
           statusFilters.innerHTML = `
                <button class="${btnBase} ${currentFilter==='all'?btnActive:btnInactive}" onclick="setFilter('all')">Todas (${stats.total})</button>
                <button class="${btnBase} ${currentFilter==='late'?btnActive:btnInactive}" onclick="setFilter('late')">Atrasadas (${stats.late})</button>
                <button class="${btnBase} ${currentFilter==='veryLate'?btnActive:btnInactive}" onclick="setFilter('veryLate')">Muy Atrasadas (${stats.veryLate})</button>
                <button class="${btnBase} ${currentFilter==='aboutToExpire'?btnActive:btnInactive}" onclick="setFilter('aboutToExpire')">Por Vencer (${stats.aboutToExpire})</button>
                <button class="${btnBase} ${currentFilter==='onTime'?btnActive:btnInactive}" onclick="setFilter('onTime')">A Tiempo (${stats.onTime})</button>
            `;
            const dateFilters = document.getElementById('dateFilters');
            dateFilters.innerHTML = `
                <button class="${btnBase} ${currentDateFilter==='all'?btnActive:btnInactive}" onclick="setDateFilter('all')">Todas</button>
                <button class="${btnBase} ${currentDateFilter==='thisWeek'?btnActive:btnInactive}" onclick="setDateFilter('thisWeek')">Esta Semana</button>
                <button class="${btnBase} ${currentDateFilter==='thisMonth'?btnActive:btnInactive}" onclick="setDateFilter('thisMonth')">Este Mes</button>
                <button class="${btnBase} ${currentDateFilter==='nextWeek'?btnActive:btnInactive}" onclick="setDateFilter('nextWeek')">Pr√≥xima Semana</button>
            `;
        }
        
        async function updateTable() {
            const partFilters = document.querySelectorAll('.filters');
            if (currentDepartamentoFilter && currentDepartamentoFilter !== 'P_Art') {
                partFilters.forEach(f => f.style.display = 'none');
            } else {
                partFilters.forEach(f => f.style.display = 'block');
            }

            const filtered = getFilteredOrders(false); 
            const tableBody = document.getElementById('tableBody');
            
            const filteredPieces = filtered.reduce((sum, order) => {
                return sum + (order.cantidad || 0) + (order.childPieces || 0);
            }, 0);
            
            setupPagination(filtered); 
            
            if (paginatedOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="14" class="px-6 py-12 text-center text-gray-500">No hay √≥rdenes que coincidan</td></tr>';
            } else {
                let tableRowsHTML = '';
                for (const order of paginatedOrders) {
                    const hasNotes = order.notes && order.notes.trim().length > 0;
                    const receivedDateFormatted = order.receivedDate ? new Date(order.receivedDate + 'T00:00:00Z').toLocaleDateString('es-ES') : '-';
                    const hasChildren = order.childPieces > 0;
                    const safeCliente = escapeHTML(order.cliente);
                    const safeCodigo = escapeHTML(order.codigoContrato);
                    const safeEstilo = escapeHTML(order.estilo);
                    const safeTeam = escapeHTML(order.teamName);
                    const safeDepartamento = escapeHTML(order.departamento);
                    const safeDesigner = escapeHTML(order.designer);

                    tableRowsHTML += `
                    <tr class="cursor-pointer ${order.isVeryLate?'very-late':order.isLate?'late':order.isAboutToExpire?'expiring':''}" onclick="openAssignModal('${order.orderId}')">
                        <td class="px-6 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                            ${order.departamento === 'P_Art' ? 
                            `<input type="checkbox" data-order-id="${order.orderId}" onchange="toggleOrderSelection('${order.orderId}')" aria-label="Seleccionar orden ${safeCodigo}"
                                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">` :
                            ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(order)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(order.fechaDespacho)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${safeCliente}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${safeCodigo}
                            ${hasChildren ? `<br><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-medium mt-1 inline-block flex items-center gap-1 w-fit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                                </svg>
                                con hijas
                            </span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeEstilo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${safeTeam}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${safeDepartamento ? `<span class="bg-gray-100 text-gray-800 px-2.5 py-0.5 rounded-full text-xs font-medium">${safeDepartamento}</span>` : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${safeDesigner ? `<span class="bg-blue-100 text-blue-800 px-2.5 py-0.5 rounded-full text-xs font-medium">${safeDesigner}</span>` : '<span class="text-gray-400 text-sm italic">Sin asignar</span>'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getCustomStatusBadge(order.customStatus)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${receivedDateFormatted}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-bold">${order.cantidad.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hasNotes ? `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
                            </svg>
                            ` : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                            <button class="font-medium py-1 px-3 rounded-lg text-xs transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700" onclick="openAssignModal('${order.orderId}')">Ver</button>
                        </td>
                    </tr>
                    `;
                }
                tableBody.innerHTML = tableRowsHTML;
            }

            const selectAllCheckbox = document.getElementById('selectAll');
            const hasPArtOnPage = paginatedOrders.some(o => o.departamento === 'P_Art');
            selectAllCheckbox.disabled = !hasPArtOnPage;
            if (!hasPArtOnPage) {
                selectAllCheckbox.checked = false;
            }
            
            document.getElementById('resultCount').textContent = filtered.length;
            document.getElementById('totalCount').textContent = allOrders.length;
            document.getElementById('resultPieces').textContent = filteredPieces.toLocaleString();
            
            updateCheckboxes();
        }
        
        function getCustomStatusBadge(status) {
            const base = "px-2.5 py-0.5 rounded-full text-xs font-medium";
            if (!status) return `<span class="text-gray-400 text-sm italic">Sin estado</span>`;
            const safeStatus = escapeHTML(status);
            if (status === 'Completada') return `<span class="${base} bg-gray-100 text-gray-800 border border-gray-300">${safeStatus}</span>`;
            if (status === 'Bandeja') return `<span class="${base} bg-yellow-100 text-yellow-800">${safeStatus}</span>`;
            if (status === 'Producci√≥n') return `<span class="${base} bg-purple-100 text-purple-800">${safeStatus}</span>`;
            if (status === 'Auditor√≠a') return `<span class="${base} bg-cyan-100 text-cyan-800">${safeStatus}</span>`;
            return `<span class_alias="${base} bg-gray-100 text-gray-800">${safeStatus}</span>`;
        }
        
        function getStatusBadge(order) {
            const base = "px-2.5 py-0.5 rounded-full text-xs font-medium inline-block";
            if (order.isVeryLate) return `<span class="${base} bg-red-100 text-red-800">MUY ATRASADA</span><br><small class="text-red-600 text-xs mt-1 block">${order.daysLate}d</small>`;
            if (order.isLate) return `<span class="${base} bg-red-100 text-red-800">Atrasada</span><br><small class="text-red-500 text-xs mt-1 block">${order.daysLate}d</small>`;
            if (order.isAboutToExpire) return `<span class="${base} bg-yellow-100 text-yellow-800">Por Vencer</span>`;
            return `<span class="${base} bg-green-100 text-green-800">A Tiempo</span>`;
        }
        
        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric', timeZone: 'UTC' });
        }
        
        function getWeekIdentifier(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return `${date.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
        }

        // --- L√≥gica de Filtros (Original) ---
        function applySearchFilter(orders, searchText, searchFields = null) {
            if (!searchText || searchText.trim() === '') return orders;
            const s = searchText.toLowerCase().trim();
            const defaultFields = ['cliente', 'codigoContrato', 'estilo', 'teamName', 'departamento', 'designer', 'customStatus', 'notes'];
            const fields = searchFields || defaultFields;
            return orders.filter(order =>
                 fields.some(field =>
                    (order[field] || '').toString().toLowerCase().includes(s)
                )
            );
        }
        function applyMultipleFilters(orders, filters) {
            let result = [...orders];
            if (filters.cliente) result = result.filter(o => o.cliente === filters.cliente);
            if (filters.estilo) result = result.filter(o => o.estilo === filters.estilo);
            if (filters.teamName) result = result.filter(o => o.teamName === filters.teamName);
            if (filters.departamento) result = result.filter(o => o.departamento === filters.departamento);
            if (filters.designer) result = result.filter(o => o.designer === filters.designer);
            if (filters.customStatus) result = result.filter(o => o.customStatus === filters.customStatus);
            if (filters.dateFrom) {
                const fromDate = new Date(filters.dateFrom + 'T00:00:00Z');
                result = result.filter(o => o.fechaDespacho && o.fechaDespacho >= fromDate);
            }
            if (filters.dateTo) {
                const toDate = new Date(filters.dateTo + 'T23:59:59Z');
                result = result.filter(o => o.fechaDespacho && o.fechaDespacho <= toDate);
            }
            return result;
        }
        
        function getFilteredOrders(applyPagination = true) {
            let filtered = [...allOrders];
            filtered = applySearchFilter(filtered, currentSearch);
            filtered = applyMultipleFilters(filtered, {
                cliente: currentClientFilter,
                estilo: currentStyleFilter,
                teamName: currentTeamFilter,
                departamento: currentDepartamentoFilter,
                designer: currentDesignerFilter,
                customStatus: currentCustomStatusFilter,
                dateFrom: currentDateFrom,
                dateTo: currentDateTo
            });
            const artOrders = filtered.filter(o => o.departamento === 'P_Art');
            const otherOrders = filtered.filter(o => o.departamento !== 'P_Art');
            let filteredArtOrders = artOrders;
            if (currentFilter === 'late') filteredArtOrders = artOrders.filter(o => o.isLate);
            if (currentFilter === 'veryLate') filteredArtOrders = artOrders.filter(o => o.isVeryLate);
            if (currentFilter === 'aboutToExpire') filteredArtOrders = artOrders.filter(o => o.isAboutToExpire);
            if (currentFilter === 'onTime') filteredArtOrders = artOrders.filter(o => !o.isLate && !o.isAboutToExpire);
            const today = new Date(); today.setHours(0,0,0,0);
            if (currentDateFilter === 'thisWeek') {
                const weekEnd = new Date(today); 
                weekEnd.setDate(today.getDate()+7);
                filteredArtOrders = filteredArtOrders.filter(o => o.fechaDespacho && o.fechaDespacho >= today && o.fechaDespacho <= weekEnd);
            } else if (currentDateFilter === 'thisMonth') {
                const monthEnd = new Date(today.getFullYear(), today.getMonth()+1, 0);
                filteredArtOrders = filteredArtOrders.filter(o => o.fechaDespacho && o.fechaDespacho >= today && o.fechaDespacho <= monthEnd);
            } else if (currentDateFilter === 'nextWeek') {
                const nextWeekStart = new Date(today);
                nextWeekStart.setDate(today.getDate() + 7);
                const nextWeekEnd = new Date(today);
                nextWeekEnd.setDate(today.getDate() + 14);
                filteredArtOrders = filteredArtOrders.filter(o => o.fechaDespacho && o.fechaDespacho >= nextWeekStart && o.fechaDespacho <= nextWeekEnd);
            }
            if (currentFilter !== 'all' || currentDateFilter !== 'all' || currentDepartamentoFilter === 'P_Art') {
                filtered = filteredArtOrders;
            } 
            else if (currentDepartamentoFilter && currentDepartamentoFilter !== 'P_Art') {
                filtered = otherOrders;
            }
            else {
                filtered = [...filteredArtOrders, ...otherOrders];
            }
            if (sortConfig.key) {
                filtered.sort((a,b) => {
                    let aVal,bVal;
                    switch (sortConfig.key) {
                        case 'date': aVal = a.fechaDespacho? a.fechaDespacho.getTime():0; bVal = b.fechaDespacho? b.fechaDespacho.getTime():0; break;
                        case 'cliente': aVal = a.cliente; bVal = a.cliente; break;
                        case 'estilo': aVal = a.estilo; bVal = a.estilo; break;
                        case 'teamName': aVal = a.teamName; bVal = a.teamName; break;
                        case 'departamento': aVal = a.departamento; bVal = a.departamento; break;
                        case 'designer': aVal = a.designer || ''; bVal = b.designer || ''; break;
                        case 'customStatus': aVal = a.customStatus || ''; bVal = b.customStatus || ''; break;
                        case 'receivedDate': aVal = a.receivedDate ? new Date(a.receivedDate + 'T00:00:00Z').getTime() : 0; bVal = b.receivedDate ? new Date(b.receivedDate + 'T00:00:00Z').getTime() : 0; break;
                        case 'cantidad': aVal = a.cantidad; bVal = a.cantidad; break;
                        case 'status': aVal = a.isVeryLate?4: a.isLate?3: a.isAboutToExpire?2:1; bVal = b.isVeryLate?4: b.isLate?3: b.isAboutToExpire?2:1; break;
                    }
                    if (aVal < bVal) return sortConfig.direction==='asc' ? -1:1;
                    if (aVal > bVal) return sortConfig.direction==='asc' ? 1:-1;
                    return 0;
                });
            }
            if (applyPagination) {
                return paginatedOrders;
            } else {
                return filtered;
            }
        }
        function setFilter(f) { 
            currentFilter = f;
            currentDateFilter = 'all'; 
            currentPage = 1; 
            updateDashboard(); 
        }
        function setDateFilter(f) { 
            currentDateFilter = f;
            currentFilter = 'all'; 
            currentPage = 1; 
            updateDashboard(); 
        }
        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction==='asc' ? 'desc':'asc';
            } else { 
                sortConfig.key = key; 
                sortConfig.direction='asc'; 
            }
            document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent='');
            const indicator = document.getElementById(`sort-${key}`);
            if (indicator) indicator.textContent = sortConfig.direction==='asc' ? '‚Üë':'‚Üì';
            currentPage = 1; 
            updateTable();
        }

        // --- L√≥gica de Reportes y Exportaci√≥n (Original) ---
        // 'resetApp' ahora solo borra el Excel, no la conexi√≥n
        function resetApp() {
            showConfirmModal("¬øEst√°s seguro de que quieres subir un nuevo archivo de Excel? Los datos de la nube permanecer√°n, pero la lista se refrescar√°.", () => {
                allOrders = [];
                isExcelLoaded = false;
                selectedOrders.clear();
                currentFilter = 'all';
                currentDateFilter = 'all';
                currentSearch = '';
                currentClientFilter = '';
                currentStyleFilter = '';
                currentTeamFilter = '';
                currentDepartamentoFilter = '';
                currentDesignerFilter = '';
                currentCustomStatusFilter = '';
                currentDateFrom = '';
                currentDateTo = '';
                sortConfig = { key: 'date', direction: 'asc' };
                currentPage = 1;
                childPiecesCache.clear();
                needsRecalculation = true;
                
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('designerMetricsView').style.display = 'none';
                document.getElementById('departmentMetricsView').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('workPlanView').style.display = 'none';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').textContent = '';
                updateMultiSelectBar();
            }); 
        }

        let debounceTimer;
        function debounce(func, delay) {
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            }
        }
        
        // --- L√≥gica de Reporte Semanal (Original, ahora lee de 'allOrders' fusionado) ---
        function openWeeklyReportModal() {
            document.getElementById('weeklyReportModal').classList.add('active');
            document.body.classList.add('modal-open');
            const today = new Date();
            const weekIdentifier = getWeekIdentifier(today);
            document.getElementById('weekSelector').value = weekIdentifier;
            generateWeeklyReport();
        }
        function closeWeeklyReportModal() {
            document.getElementById('weeklyReportModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        function getWeekDateRange(year, week) {
            const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const day = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 1 - day); // Lunes
            const startDate = new Date(d);
            const endDate = new Date(d);
            endDate.setUTCDate(endDate.getUTCDate() + 6); // Domingo
            return { startDate, endDate };
        }
        
        function generateWeeklyReport() {
            const spinner = document.getElementById('weeklyReportSpinner');
            const contentDiv = document.getElementById('weeklyReportContent');
            spinner.style.display = 'block'; 
            contentDiv.innerHTML = ''; 

            setTimeout(() => {
                try {
                    const weekValue = document.getElementById('weekSelector').value;
                    if (!weekValue) {
                        contentDiv.innerHTML = '<p>Por favor, selecciona una semana.</p>';
                        spinner.style.display = 'none';
                        return;
                    }
                    
                    const [year, week] = weekValue.split('-W').map(Number);
                    const { startDate, endDate } = getWeekDateRange(year, week);
                    endDate.setUTCHours(23, 59, 59, 999);

                    // Usa 'allOrders' (fusionado) y filtra por 'receivedDate' (de Firebase)
                    const filteredOrders = allOrders.filter(order => {
                        if (!order.receivedDate) return false;
                        const receivedDate = new Date(order.receivedDate + 'T00:00:00Z');
                        return receivedDate >= startDate && receivedDate <= endDate;
                    });

                    let reportHTML = `
                        <h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">Reporte para la semana del ${startDate.toLocaleDateString('es-ES', { timeZone: 'UTC' })} al ${endDate.toLocaleDateString('es-ES', { timeZone: 'UTC' })}</h4>
                        <div class="table-container rounded-lg border border-gray-200 overflow-hidden mt-4 max-h-96 overflow-y-auto">
                            <table id="weeklyReportTable" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Recibida</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dise√±ador</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                    `;

                    if (filteredOrders.length > 0) {
                        filteredOrders.sort((a,b) => new Date(a.receivedDate) - new Date(b.receivedDate));
                        let totalPieces = 0;
                        filteredOrders.forEach(order => {
                            const orderTotalPieces = (order.cantidad || 0) + (order.childPieces || 0);
                            totalPieces += orderTotalPieces;
                            reportHTML += `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${new Date(order.receivedDate + 'T00:00:00Z').toLocaleDateString('es-ES', { timeZone: 'UTC' })}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-medium">${escapeHTML(order.cliente)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(order.codigoContrato)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(order.designer) || 'Sin asignar'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(order.customStatus) || 'Sin estado'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-semibold">${orderTotalPieces.toLocaleString()}</td>
                                </tr>
                            `;
                        });
                        reportHTML += `
                            <tr class="font-bold bg-gray-50">
                                <td colspan="5" class="px-4 py-3 text-right text-sm text-gray-800">Total de Piezas (con hijas):</td>
                                <td class="px-4 py-3 text-left text-sm text-gray-900">${totalPieces.toLocaleString()}</td>
                            </tr>
                        `;
                    } else {
                        reportHTML += '<tr><td colspan="6" class="text-center text-gray-500 py-12">No hay √≥rdenes recibidas en esta semana.</td></tr>';
                    }
                    reportHTML += `</tbody></table></div>`;
                    spinner.style.display = 'none';
                    contentDiv.innerHTML = reportHTML;
                } catch (error) {
                    console.error("Error generando reporte semanal:", error);
                    showCustomAlert(`Error en reporte: ${error.message}`, 'error');
                    spinner.style.display = 'none';
                    contentDiv.innerHTML = '<p class="text-red-600">Error al generar el reporte.</p>';
                }
            }, 50);
        }
        
        function exportWeeklyReportAsPDF() {
            try {
                const table = document.getElementById('weeklyReportTable');
                if (!table || table.rows.length <= 1 || table.querySelector('td[colspan="6"]')) {
                    showCustomAlert('No hay datos para exportar.', 'error');
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const weekValue = document.getElementById('weekSelector').value;
                const [year, week] = weekValue.split('-W').map(Number);
                const { startDate, endDate } = getWeekDateRange(year, week);
                doc.text(`Reporte Semanal de √ìrdenes`, 14, 16);
                doc.setFontSize(10);
                doc.text(`Semana: ${startDate.toLocaleDateString('es-ES', { timeZone: 'UTC' })} - ${endDate.toLocaleDateString('es-ES', { timeZone: 'UTC' })}`, 14, 22);
                doc.autoTable({
                    html: '#weeklyReportTable',
                    startY: 28,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] }, 
                });
                doc.save(`Reporte_Semanal_${year}_W${week}.pdf`);
            } catch (error) {
                console.error("Error exportando PDF semanal:", error);
                showCustomAlert(`Error al exportar PDF: ${error.message}`, 'error');
            }
        }
        
        // --- L√≥gica de Plan Semanal (Refactorizado) ---
        function showWorkPlanView() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('designerMetricsView').style.display = 'none';
            document.getElementById('departmentMetricsView').style.display = 'none';
            document.getElementById('workPlanView').style.display = 'block';
            document.getElementById('multiSelectBar').classList.remove('active');
            const today = new Date();
            const weekIdentifier = getWeekIdentifier(today);
            document.getElementById('view-workPlanWeekSelector').value = weekIdentifier;
            currentWorkPlanWeek = weekIdentifier;
            generateWorkPlan();
        }
        function hideWorkPlanView() {
            document.getElementById('workPlanView').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }
        
        async function loadUrgentOrdersToPlan() {
            const weekIdentifier = document.getElementById('view-workPlanWeekSelector').value;
            if (!weekIdentifier) {
                showCustomAlert('Por favor, selecciona una semana primero.', 'error');
                return;
            }
            const spinner = document.getElementById('view-workPlanSpinner');
            spinner.style.display = 'block';
            
            const urgentAssignedOrders = allOrders.filter(o =>
                o.departamento === 'P_Art' &&
                (o.isLate || o.isAboutToExpire) &&
                o.designer && o.designer !== ''
            );
            
            if (urgentAssignedOrders.length === 0) {
                showCustomAlert('No se encontraron √≥rdenes urgentes y asignadas para cargar.', 'info');
                spinner.style.display = 'none';
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            for (const order of urgentAssignedOrders) {
                try {
                    // Llama a la funci√≥n de Firestore
                    const added = await addOrderToWorkPlanDB(order, weekIdentifier);
                    if (added) {
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } catch (e) {
                    console.error('Error al cargar urgentes:', e);
                    showCustomAlert(`Error al guardar: ${e.message}`, 'error');
                    spinner.style.display = 'none';
                    return;
                }
            }
            showCustomAlert(`Se cargaron ${addedCount} √≥rdenes urgentes. Se omitieron ${skippedCount} (ya estaban en el plan).`, 'success');
            // onSnapshot refrescar√° la vista
        }

        async function removeOrderFromPlan(planEntryId, orderCode) {
            showConfirmModal(`¬øEst√°s seguro de que quieres quitar la orden ${orderCode} de este plan semanal?`, async () => {
                try {
                    // Llama a la funci√≥n de Firestore
                    await removeOrderFromWorkPlanDB(planEntryId);
                    showCustomAlert(`Orden ${orderCode} eliminada del plan.`, 'success');
                    // onSnapshot refrescar√° la vista
                } catch (e) {
                    console.error('Error al eliminar del plan:', e);
                    showCustomAlert(`Error al eliminar: ${e.message}`, 'error');
                }
            });
        }

        async function generateWorkPlan() {
            const spinner = document.getElementById('view-workPlanSpinner');
            const contentDiv = document.getElementById('view-workPlanContent');
            const summarySpan = document.getElementById('view-workPlanSummary');
            spinner.style.display = 'block';
            contentDiv.innerHTML = '';
            summarySpan.textContent = '';
            
            currentWorkPlanWeek = document.getElementById('view-workPlanWeekSelector').value;
            if (!currentWorkPlanWeek) {
                spinner.style.display = 'none';
                contentDiv.innerHTML = '<p class="text-center text-gray-500">Por favor, selecciona una semana.</p>';
                return;
            }

            try {
                // Lee del mapa de Firebase
                let planOrders = await getWorkPlanForWeek(currentWorkPlanWeek);
                
                if (planOrders.length === 0) {
                    spinner.style.display = 'none';
                    contentDiv.innerHTML = '<p class="text-center text-gray-500 py-12">No hay √≥rdenes en el plan para esta semana.</p>';
                    return;
                }
                
                const planByDesigner = {};
                designerList.forEach(designer => {
                    const designerOrders = planOrders.filter(p => p.designer === designer);
                    if (designerOrders.length > 0) {
                        planByDesigner[designer] = designerOrders;
                    }
                });
                
                const orphanOrders = planOrders.filter(p => !p.designer || !designerList.includes(p.designer));
                if (orphanOrders.length > 0) {
                    planByDesigner['Sin Asignar (o Desconocido)'] = orphanOrders;
                }
                
                let totalPlanPieces = 0;
                let reportHTML = '';
                
                for (const designerName of Object.keys(planByDesigner)) {
                    const designerOrders = planByDesigner[designerName];
                    designerOrders.sort((a, b) => {
                        if (a.isLate && !b.isLate) return -1;
                        if (!a.isLate && b.isLate) return 1;
                        if (a.isAboutToExpire && !b.isAboutToExpire) return -1;
                        if (!a.isAboutToExpire && b.isAboutToExpire) return 1;
                        return (new Date(a.fechaDespacho) || 0) - (new Date(b.fechaDespacho) || 0);
                    });
                    
                    const designerPieces = designerOrders.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                    totalPlanPieces += designerPieces;

                    reportHTML += `
                        <div class="designer-plan-section mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-gray-800">${escapeHTML(designerName)}</h3>
                                <span class="text-sm font-semibold text-blue-600">${designerOrders.length} √≥rdenes | ${designerPieces.toLocaleString()} piezas</span>
                            </div>
                            <div class="table-container rounded-lg border border-gray-200 overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Piezas</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100">`;
                    
                    designerOrders.forEach(order => {
                        const totalPieces = (order.cantidad || 0) + (order.childPieces || 0);
                        const today = new Date(); today.setHours(0,0,0,0);
                        const fechaDespacho = order.fechaDespacho ? new Date(order.fechaDespacho) : null;
                        const isLate = fechaDespacho && fechaDespacho < today;
                        const isAboutToExpire = fechaDespacho && !isLate && ((fechaDespacho.getTime() - today.getTime()) / (1000*60*60*24)) <= 2;
                        let statusBadge = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">A Tiempo</span>`;
                        if (isLate) {
                            statusBadge = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Atrasada</span>`;
                        } else if (isAboutToExpire) {
                            statusBadge = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Por Vencer</span>`;
                        }
                        reportHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 whitespace-nowrap">${statusBadge}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800">${formatDate(fechaDespacho)}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 font-medium">${escapeHTML(order.cliente)}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${escapeHTML(order.codigoContrato)}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-blue-600 font-bold">${totalPieces.toLocaleString()}</td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <button class="btn-remove-from-plan font-medium py-1 px-2 rounded-lg text-xs transition-colors bg-red-100 text-red-700 hover:bg-red-200 flex items-center gap-1"
                                            data-plan-entry-id="${escapeHTML(order.planEntryId)}"
                                            data-order-code="${escapeHTML(order.codigoContrato)}"
                                            title="Quitar del plan">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                          <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.518.149.022a.75.75 0 1 0 .23-1.482A41.03 41.03 0 0 0 14 4.193v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75a1.25 1.25 0 0 0-1.25-1.25h-2.5A1.25 1.25 0 0 0 7.5 3.75v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                        </svg>
                                        Quitar
                                    </button>
                                </td>
                            </tr>`;
                    });
                    reportHTML += `</tbody></table></div></div>`;
                }
                spinner.style.display = 'none';
                contentDiv.innerHTML = reportHTML;
                summarySpan.textContent = `Total en el Plan: ${planOrders.length} √≥rdenes | ${totalPlanPieces.toLocaleString()} piezas`;

            } catch (error) {
                console.error("Error generando plan de trabajo:", error);
                showCustomAlert(`Error al cargar el plan: ${error.message}`, 'error');
                spinner.style.display = 'none';
                contentDiv.innerHTML = '<p class="text-red-600 text-center py-12">Error al cargar el plan.</p>';
            }
        }
        
        // --- L√≥gica de M√©tricas (Original, ahora lee de 'allOrders' fusionado) ---
        function showDepartmentMetrics() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('designerMetricsView').style.display = 'none';
            document.getElementById('workPlanView').style.display = 'none';
            document.getElementById('departmentMetricsView').style.display = 'block';
            document.getElementById('multiSelectBar').classList.remove('active');
            document.getElementById('departmentMetricsContent').innerHTML = `
                <div id="deptSpinnerContainer" class="text-center py-20">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Calculando m√©tricas del departamento...</p>
                </div>
            `;
            setTimeout(generateDepartmentMetrics, 50);
        }
        function hideDepartmentMetrics() {
            document.getElementById('departmentMetricsView').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            if (deptLoadPieChart) { deptLoadPieChart.destroy(); deptLoadPieChart = null; }
            if (deptLoadBarChart) { deptLoadBarChart.destroy(); deptLoadBarChart = null; }
            if (deptProductivityChart) { deptProductivityChart.destroy(); deptProductivityChart = null; }
        }
        async function generateDepartmentMetrics() {
            try {
                const contentDiv = document.getElementById('departmentMetricsContent');
                const pArtActiveOrders = allOrders.filter(o => 
                    o.departamento === 'P_Art' && 
                    o.designer && 
                    o.designer !== '' &&
                    o.designer !== 'Magdali Fernadez' &&
                    o.customStatus !== 'Completada'
                );
                const allAssignedPArtOrders = allOrders.filter(o => 
                    o.departamento === 'P_Art' &&
                    o.designer && 
                    o.designer !== ''
                );
                const criticalOrders = allOrders.filter(o => 
                    o.departamento === 'P_Art' &&
                    (!o.designer || o.designer === '') &&
                    o.isLate
                );
                const totalActiveOrders = pArtActiveOrders.length;
                const totalActivePieces = pArtActiveOrders.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                const avgPiecesPerOrder = totalActiveOrders > 0 ? (totalActivePieces / totalActiveOrders) : 0;
                const lateOrders = pArtActiveOrders.filter(o => o.isLate).length;
                const lateOrdersPercent = totalActiveOrders > 0 ? (lateOrders / totalActiveOrders) * 100 : 0;
                const completedOrders = allAssignedPArtOrders.filter(o => o.customStatus === 'Completada');
                const completedOnTime = completedOrders.filter(o => !o.isLate).length;
                const complianceRate = completedOrders.length > 0 ? (completedOnTime / completedOrders.length) * 100 : 0;
                let totalEstimatedCapacity = 0;
                let totalCurrentPieces = 0;
                for (const designerName of designerList) {
                    if (designerName === 'Magdali Fernadez') continue;
                    const designerAllOrders = allAssignedPArtOrders.filter(o => o.designer === designerName);
                    const designerActiveOrders = pArtActiveOrders.filter(o => o.designer === designerName);
                    const last30Days = new Date(); last30Days.setDate(last30Days.getDate() - 30);
                    const completadasRecientes = designerAllOrders.filter(o => o.customStatus === 'Completada' && o.completedDate && new Date(o.completedDate) >= last30Days);
                    const piezasCompletadasRecientes = completadasRecientes.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                    const weeklyCapacityPieces = (piezasCompletadasRecientes / 4.2857); 
                    const estimatedCapacity = weeklyCapacityPieces > 0 ? weeklyCapacityPieces : 100;
                    totalEstimatedCapacity += estimatedCapacity;
                    const currentActivePieces = designerActiveOrders.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                    totalCurrentPieces += currentActivePieces;
                }
                const totalCapacityUsed = totalEstimatedCapacity > 0 ? (totalCurrentPieces / totalEstimatedCapacity) * 100 : 0;
                const designerLoad = {};
                designerList.forEach(name => {
                    if (name !== 'Magdali Fernadez') {
                        designerLoad[name] = { pieces: 0, orders: 0 };
                    }
                });
                pArtActiveOrders.forEach(o => {
                    if (designerLoad[o.designer]) {
                        designerLoad[o.designer].pieces += (o.cantidad || 0) + (o.childPieces || 0);
                        designerLoad[o.designer].orders += 1;
                    }
                });
                const sortedByPieces = Object.entries(designerLoad).sort((a, b) => b[1].pieces - a[1].pieces);
                const [maxLoadDesigner, maxLoadStats] = sortedByPieces[0] || ['N/A', { pieces: 0 }];
                const [minLoadDesigner, minLoadStats] = sortedByPieces[sortedByPieces.length - 1] || ['N/A', { pieces: 0 }];
                const allPieces = Object.values(designerLoad).map(d => d.pieces);
                const avgPieces = totalActivePieces / allPieces.length;
                const variance = allPieces.reduce((sum, pieces) => sum + Math.pow(pieces - avgPieces, 2), 0) / allPieces.length;
                const stdDeviation = Math.sqrt(variance);
                const stdDevPercent = (avgPieces > 0) ? (stdDeviation / avgPieces) * 100 : 0;
                const today = new Date();
                const startOfThisWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
                startOfThisWeek.setHours(0,0,0,0);
                const startOfLastWeek = new Date(startOfThisWeek);
                startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);
                const completedThisWeek = completedOrders.filter(o => o.completedDate && new Date(o.completedDate) >= startOfThisWeek).length;
                const last30Days = new Date(); last30Days.setDate(last30Days.getDate() - 30);
                const completedLast30Days = completedOrders.filter(o => o.completedDate && new Date(o.completedDate) >= last30Days).length;
                const teamThroughput = (completedLast30Days / 4.2857).toFixed(1);
                const completadasConTiempo = completedOrders.filter(o => o.receivedDate && o.completedDate);
                let avgCompletionSpeed = 0;
                if (completadasConTiempo.length > 0) {
                    const totalDays = completadasConTiempo.reduce((sum, o) => {
                        try {
                            const start = new Date(o.receivedDate + 'T00:00:00Z');
                            const end = new Date(o.completedDate);
                            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                            return sum + Math.max(0, diffDays);
                        } catch(e) { return sum; }
                    }, 0);
                    avgCompletionSpeed = totalDays / completadasConTiempo.length;
                }
                const clientLoad = {};
                const styleLoad = {};
                pArtActiveOrders.forEach(o => {
                    const totalOrderPieces = (o.cantidad || 0) + (o.childPieces || 0);
                    clientLoad[o.cliente] = (clientLoad[o.cliente] || 0) + totalOrderPieces;
                    styleLoad[o.estilo] = (styleLoad[o.estilo] || 0) + totalOrderPieces;
                });
                const top3Clients = Object.entries(clientLoad).sort((a,b) => b[1] - a[1]).slice(0, 3);
                const top5Styles = Object.entries(styleLoad).sort((a,b) => b[1] - a[1]).slice(0, 5);
                const receivedThisWeek = allAssignedPArtOrders.filter(o => o.receivedDate && new Date(o.receivedDate + 'T00:00:00Z') >= startOfThisWeek).length;
                const receivedLastWeek = allAssignedPArtOrders.filter(o => o.receivedDate && new Date(o.receivedDate + 'T00:00:00Z') >= startOfLastWeek && new Date(o.receivedDate + 'T00:00:00Z') < startOfThisWeek).length;
                let trendArrow = '‚Üí';
                let trendClass = 'text-gray-500';
                if (receivedThisWeek > receivedLastWeek) { trendArrow = '‚Üë'; trendClass = 'text-green-600'; }
                if (receivedThisWeek < receivedLastWeek) { trendArrow = '‚Üì'; trendClass = 'text-red-600'; }
                let complianceClass = 'text-green-600';
                if (complianceRate < 90) complianceClass = 'text-yellow-600';
                if (complianceRate < 70) complianceClass = 'text-red-600';
                let capacityClass = 'text-green-600';
                if (totalCapacityUsed > 100) capacityClass = 'text-red-600';
                else if (totalCapacityUsed > 80) capacityClass = 'text-yellow-600';
                let balanceClass = 'text-green-600';
                if (stdDevPercent > 30) balanceClass = 'text-yellow-600';
                if (stdDevPercent > 50) balanceClass = 'text-red-600';
                contentDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Secci√≥n 1: Resumen del Departamento (P_Art Activo)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">√ìrdenes Activas (Asignadas)</div><div class="text-3xl font-bold text-gray-900">${totalActiveOrders}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Piezas Activas (Asignadas)</div><div class="text-3xl font-bold text-gray-900">${totalActivePieces.toLocaleString()}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Promedio Piezas / Orden</div><div class="text-3xl font-bold text-gray-900">${avgPiecesPerOrder.toFixed(1)}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">√ìrdenes Atrasadas</div><div class="text-3xl font-bold ${lateOrdersPercent > 10 ? 'text-red-600' : 'text-gray-900'}">${lateOrders} <span class="text-xl font-medium text-gray-500">(${lateOrdersPercent.toFixed(1)}%)</span></div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Tasa de Cumplimiento (Hist.)</div><div class="text-3xl font-bold ${complianceClass}">${complianceRate.toFixed(1)}%</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Capacidad Utilizada (Estimada)</div><div class="text-3xl font-bold ${capacityClass}">${totalCapacityUsed.toFixed(0)}%</div></div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Secci√≥n 2: Distribuci√≥n de Carga Activa</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Dise√±ador con Mayor Carga</div><div class="text-2xl font-bold text-gray-900 truncate" title="${escapeHTML(maxLoadDesigner)}">${escapeHTML(maxLoadDesigner)}</div><div class="text-sm text-gray-500 mt-1">${maxLoadStats.pieces.toLocaleString()} piezas</div></div>
                            <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Dise√±ador con Menor Carga</div><div class="text-2xl font-bold text-gray-900 truncate" title="${escapeHTML(minLoadDesigner)}">${escapeHTML(minLoadDesigner)}</div><div class="text-sm text-gray-500 mt-1">${minLoadStats.pieces.toLocaleString()} piezas</div></div>
                            <div class="md:col-span-2 bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Balance de Carga (Desv. Est.)</div><div class="text-2xl font-bold ${balanceClass}">${stdDevPercent.toFixed(1)}%</div><div class="text-sm text-gray-500 mt-1">Un ${stdDevPercent > 30 ? 'alto' : 'bajo'} % indica carga desbalanceada</div></div>
                        </div>
                        <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-4 border border-gray-200 min-h-[300px]"><canvas id="deptLoadPieChartCanvas"></canvas></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-200 mb-6 min-h-[350px]"><canvas id="deptLoadBarChartCanvas"></canvas></div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Secci√≥n 3: Productividad del Equipo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Completadas esta Semana</div><div class="text-3xl font-bold text-gray-900">${completedThisWeek}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Throughput (√ìrdenes/Semana)</div><div class="text-3xl font-bold text-gray-900">${teamThroughput}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Velocidad Promedio (Hist.)</div><div class="text-3xl font-bold text-gray-900">${avgCompletionSpeed.toFixed(1)} <span class="text-2xl font-medium text-gray-500">d√≠as</span></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-200"><h4 class="text-base font-semibold text-gray-900 mb-3">Top 3 Clientes (Carga Activa)</h4><div class="space-y-2 max-h-40 overflow-y-auto">${top3Clients.length > 0 ? top3Clients.map(([client, pieces]) => `<div class="report-item flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0 text-sm"><span class="text-gray-700 font-medium">${escapeHTML(client)}</span><strong class="font-semibold text-gray-900">${pieces.toLocaleString()} pzs</strong></div>`).join('') : '<p class="text-gray-500 text-center py-4">No hay datos</p>'}</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-200"><h4 class="text-base font-semibold text-gray-900 mb-3">Top 5 Estilos (Carga Activa)</h4><div class="space-y-2 max-h-40 overflow-y-auto">${top5Styles.length > 0 ? top5Styles.map(([style, pieces]) => `<div class="report-item flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0 text-sm"><span class="text-gray-700 font-medium">${escapeHTML(style)}</span><strong class="font-semibold text-gray-900">${pieces.toLocaleString()} pzs</strong></div>`).join('') : '<p class="text-gray-500 text-center py-4">No hay datos</p>'}</div></div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Secci√≥n 4: Alertas y Tendencias</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg shadow-lg"><h4 class="text-base font-semibold text-red-800 mb-3">√ìrdenes Cr√≠ticas (Atrasadas y Sin Asignar)</h4><div class="text-3xl font-bold text-red-600 mb-3">${criticalOrders.length} <span class="text-2xl font-medium">√≥rdenes</span></div><button class="${criticalOrders.length === 0 ? 'hidden' : ''} font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-red-600 text-white hover:bg-red-700" onclick="goToCriticalOrders()">Ver √ìrdenes Cr√≠ticas</button></div>
                        <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-200"><h4 class="text-base font-semibold text-gray-900 mb-3">Tendencia Semanal (Nuevas Recibidas)</h4><div class="text-3xl font-bold text-gray-900 flex items-center gap-3">${receivedThisWeek} <span class="text-3xl font-bold ${trendClass}">${trendArrow}</span></div><div class="text-sm text-gray-500 mt-1">${receivedLastWeek} √≥rdenes la semana pasada</div></div>
                    </div>
                `;
                initDepartmentCharts(designerLoad, completedOrders);
            } catch (error) {
                console.error("Error generando m√©tricas del departamento:", error);
                document.getElementById('departmentMetricsContent').innerHTML = `<p class="text-red-600 text-center py-12">Error al generar las m√©tricas: ${error.message}</p>`;
            }
        }
        function initDepartmentCharts(designerLoad, completedOrders) {
            if (deptLoadPieChart) { deptLoadPieChart.destroy(); }
            if (deptLoadBarChart) { deptLoadBarChart.destroy(); }
            if (deptProductivityChart) { deptProductivityChart.destroy(); }
            const getTailwindColor = (name, fallback) => {
                try {
                    if (name.includes('.')) {
                        const parts = name.split('.'); let color = tailwind.config.theme.colors;
                        for (const part of parts) { color = color[part]; } return color || fallback;
                    }
                    if (tailwind.config.theme.extend.colors[name]) { return tailwind.config.theme.extend.colors[name] || fallback; }
                    if (tailwind.config.theme.colors[name]) { return tailwind.config.theme.colors[name] || fallback; }
                    return fallback;
                } catch (e) { return fallback; }
            };
            const colorBorder = getTailwindColor('white', '#FFFFFF');
            const colorText = getTailwindColor('gray.500', '#6B7280');
            const colorTextTitle = getTailwindColor('gray.800', '#1F2937');
            const colorIndigo = getTailwindColor('indigo.600', '#4F46E5');
            const chartColors = ['#3B82F6', '#8B5CF6', '#F59E0B', '#10B981', '#EF4444', '#6366F1', '#EC4899', '#F97316', '#06B6D4', '#D946EF', '#6B7280', '#22C55E'];
            const pieCtx = document.getElementById('deptLoadPieChartCanvas')?.getContext('2d');
            const sortedByPieces = Object.entries(designerLoad).sort((a, b) => b[1].pieces - a[1].pieces);
            const pieLabels = sortedByPieces.map(d => d[0]);
            const pieData = sortedByPieces.map(d => d[1].pieces);
            const totalPieces = pieData.reduce((a, b) => a + b, 0);
            if (pieCtx) {
                deptLoadPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: { labels: pieLabels, datasets: [{ label: 'Piezas Activas', data: pieData, backgroundColor: chartColors, borderColor: colorBorder, borderWidth: 2 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Distribuci√≥n de Piezas Activas', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle },
                            tooltip: { callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw || 0; const percentage = totalPieces > 0 ? ((value / totalPieces) * 100).toFixed(1) : 0; return `${label}: ${value.toLocaleString()} pzs (${percentage}%)`; } } }
                        }
                    }
                });
            }
            const barCtx = document.getElementById('deptLoadBarChartCanvas')?.getContext('2d');
            const barLabels = Object.keys(designerLoad).sort((a, b) => designerLoad[b].pieces - designerLoad[a].pieces);
            if (barCtx) {
                deptLoadBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: barLabels,
                        datasets: [
                            { label: 'Piezas', data: barLabels.map(name => designerLoad[name].pieces), backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1, yAxisID: 'yPieces' },
                            { label: '√ìrdenes', data: barLabels.map(name => designerLoad[name].orders), backgroundColor: 'rgba(245, 158, 11, 0.7)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 1, yAxisID: 'yOrders' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Carga de Trabajo Activa por Dise√±ador (Piezas y √ìrdenes)', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle },
                            legend: { position: 'bottom', labels: { font: { family: 'Inter' }, color: colorText } }
                        },
                        scales: {
                            x: { ticks: { color: colorText, font: { family: 'Inter', size: 10 } } },
                            yPieces: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Total Piezas', font: { size: 10, family: 'Inter' }, color: colorText }, ticks: { color: colorIndigo } },
                            yOrders: { type: 'linear', position: 'right', beginAtZero: true, title: { display: true, text: 'Total √ìrdenes', font: { size: 10, family: 'Inter' }, color: colorText }, ticks: { color: getTailwindColor('chart-bandeja', '#F59E0B') }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
        }
        function goToCriticalOrders() {
            hideDepartmentMetrics();
            clearAllFilters();
            currentDepartamentoFilter = 'P_Art';
            currentDesignerFilter = ''; 
            currentFilter = 'late'; 
            document.getElementById('departamentoFilter').value = 'P_Art';
            document.getElementById('designerFilter').value = '';
            updateDashboard();
            showCustomAlert('Mostrando √≥rdenes cr√≠ticas: P_Art, Sin Asignar y Atrasadas', 'info');
        }

        // --- L√≥gica de M√©tricas de Dise√±ador (Original, pero lee de 'allOrders' fusionado) ---
        function showMetricsView() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('departmentMetricsView').style.display = 'none';
            document.getElementById('designerMetricsView').style.display = 'block';
            document.getElementById('workPlanView').style.display = 'none';
            populateMetricsSidebar();
            document.getElementById('metricsDetail').innerHTML = `<p class="text-gray-500 text-center py-12">‚Üê Selecciona un dise√±ador de la lista para ver sus estad√≠sticas.</p>`;
            document.getElementById('multiSelectBar').classList.remove('active'); 
        }
        function hideMetricsView() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('designerMetricsView').style.display = 'none';
            document.getElementById('departmentMetricsView').style.display = 'none';
            destroyDesignerCharts();
            closeCompareModals(); 
        }
        function populateMetricsSidebar() {
            const listDiv = document.getElementById('metricsSidebarList');
            listDiv.innerHTML = ''; 
            const pArtOrders = allOrders.filter(o => o.departamento === 'P_Art');
            const unassignedCount = pArtOrders.filter(o => !o.designer).length;
            let html = '';
            const badgeClasses = "bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs font-medium";
            if (unassignedCount > 0) {
                 html += `<button class="filter-btn" id="btn-metric-Sin-asignar" data-designer="Sin asignar">
                            Sin asignar <span class="${badgeClasses}">${unassignedCount}</span>
                         </button>`;
            }
            designerList.forEach(name => {
                const count = pArtOrders.filter(o => o.designer === name).length;
                if (count > 0) {
                    const safeName = escapeHTML(name);
                    const btnId = `btn-metric-${name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `<button class="filter-btn" id="${btnId}" data-designer="${safeName}">
                                ${safeName} <span class="${badgeClasses}">${count}</span>
                             </button>`;
                }
            });
            listDiv.innerHTML = html;
        }
        function destroyDesignerCharts() {
            if (designerDoughnutChart) { designerDoughnutChart.destroy(); designerDoughnutChart = null; }
            if (designerBarChart) { designerBarChart.destroy(); designerBarChart = null; }
            if (designerActivityChart) { designerActivityChart.destroy(); designerActivityChart = null; }
        }
        async function generateDesignerMetrics(designerName) {
            showLoading('Generando m√©tricas...');
            try {
                const contentDiv = document.getElementById('metricsDetail');
                contentDiv.innerHTML = '<div class="spinner-container"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto my-12"></div></div><p style="text-align: center;">Cargando m√©tricas...</p>';
                destroyDesignerCharts();
                currentDesignerTableFilter = { search: '', cliente: '', estado: '', fechaDesde: '', fechaHasta: '' };
                document.querySelectorAll('#metricsSidebarList .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const btnId = `btn-metric-${designerName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const activeBtn = document.getElementById(btnId);
                if (activeBtn) activeBtn.classList.add('active');
                const pArtOrders = allOrders.filter(o => o.departamento === 'P_Art');
                const isUnassigned = designerName === 'Sin asignar';
                const designerOrders = pArtOrders.filter(o => {
                    const matchesDesigner = isUnassigned ? (o.designer === '' || !o.designer) : (o.designer === designerName);
                    return matchesDesigner && o.customStatus !== 'Completada';
                });
                const allDesignerOrders = allOrders.filter(o => isUnassigned ? !o.designer : o.designer === designerName);
                if (allDesignerOrders.length === 0) {
                    contentDiv.innerHTML = '<p class="text-gray-500 text-center py-12">Este dise√±ador no tiene √≥rdenes asignadas.</p>';
                    hideLoading();
                    return;
                }
                const completadas = allDesignerOrders.filter(o => o.customStatus === 'Completada');
                const completadasATiempo = completadas.filter(o => !o.isLate); 
                let complianceRate = 0;
                if (completadas.length > 0) {
                    complianceRate = (completadasATiempo.length / completadas.length) * 100;
                }
                let complianceClass = 'text-green-600';
                if (complianceRate < 90) complianceClass = 'text-yellow-600';
                if (complianceRate < 70) complianceClass = 'text-red-600';
                const completadasConTiempo = completadas.filter(o => o.receivedDate && o.completedDate);
                let avgCompletionSpeed = 0;
                if (completadasConTiempo.length > 0) {
                    const totalDays = completadasConTiempo.reduce((sum, o) => {
                        try {
                            const start = new Date(o.receivedDate + 'T00:00:00Z');
                            const end = new Date(o.completedDate);
                            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                            return sum + Math.max(0, diffDays);
                        } catch(e) { console.warn("Error parseando fecha en Velocidad:", e); return sum; }
                    }, 0);
                    avgCompletionSpeed = totalDays / completadasConTiempo.length;
                }
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                const completadasRecientes = completadas.filter(o => {
                    if (!o.completedDate) return false;
                    try { const completedDate = new Date(o.completedDate); return completedDate >= last30Days; } catch (e) { return false; }
                });
                const weeklyThroughput = (completadasRecientes.length / 4.2857).toFixed(1);
                const currentActivePieces = designerOrders.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                const piezasCompletadasRecientes = completadasRecientes.reduce((sum, o) => sum + (o.cantidad || 0) + (o.childPieces || 0), 0);
                const weeklyCapacityPieces = (piezasCompletadasRecientes / 4.2857);
                const estimatedCapacity = weeklyCapacityPieces > 0 ? weeklyCapacityPieces : (weeklyThroughput > 0 ? (weeklyThroughput * 25) : 100);
                const capacityUsed = estimatedCapacity > 0 ? (currentActivePieces / estimatedCapacity) * 100 : 0;
                let capacityClass = 'text-green-600';
                if (capacityUsed > 100) capacityClass = 'text-red-600';
                else if (capacityUsed > 80) capacityClass = 'text-yellow-600';
                const clientPieces = {};
                const stylePieces = {};
                designerOrders.forEach(o => {
                    const totalOrderPieces = (o.cantidad || 0) + (o.childPieces || 0);
                    clientPieces[o.cliente] = (clientPieces[o.cliente] || 0) + totalOrderPieces;
                    stylePieces[o.estilo] = (stylePieces[o.estilo] || 0) + totalOrderPieces;
                });
                const topClient = Object.entries(clientPieces).sort((a,b) => b[1] - a[1])[0];
                const top5Styles = Object.entries(stylePieces).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const today = new Date();
                const startOfThisWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
                startOfThisWeek.setHours(0,0,0,0);
                const startOfLastWeek = new Date(startOfThisWeek);
                startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);
                const receivedThisWeek = allDesignerOrders.filter(o => o.receivedDate && new Date(o.receivedDate + 'T00:00:00Z') >= startOfThisWeek).length;
                const receivedLastWeek = allDesignerOrders.filter(o => o.receivedDate && new Date(o.receivedDate + 'T00:00:00Z') >= startOfLastWeek && new Date(o.receivedDate + 'T00:00:00Z') < startOfThisWeek).length;
                let trendArrow = '‚Üí';
                let trendClass = 'text-gray-500';
                if (receivedThisWeek > receivedLastWeek) { trendArrow = '‚Üë'; trendClass = 'text-green-600'; }
                if (receivedThisWeek < receivedLastWeek) { trendArrow = '‚Üì'; trendClass = 'text-red-600'; }
                const safeDesignerName = escapeHTML(designerName);
                const btnBase = "font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm flex items-center gap-2";
                const btnSuccess = "bg-green-600 text-white hover:bg-green-700";
                const btnInfo = "bg-cyan-500 text-white hover:bg-cyan-600";
                const btnOutline = "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50";
                contentDiv.innerHTML = `
                    <div class="flex flex-wrap justify-between items-start gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">${safeDesignerName}</h2>
                        <div class="flex flex-wrap gap-2">
                            <button class="${btnBase} ${btnSuccess}" onclick="exportDesignerMetricsPDF('${safeDesignerName.replace(/'/g, "\\'")}')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>Exportar PDF</button>
                            <button class="${btnBase} ${btnInfo}" onclick="exportDesignerMetricsExcel('${safeDesignerName.replace(/'/g, "\\'")}')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 16.5 19.875V3.375Z" /></svg>Exportar Excel</button>
                            <button class="${btnBase} ${btnOutline}" onclick="openCompareModal('${safeDesignerName.replace(/'/g, "\\'")}')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>Comparar</button>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">M√©tricas de Rendimiento y Productividad</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Tasa de Cumplimiento (Hist√≥rico)</div><div class="text-2xl font-bold ${complianceClass}">${complianceRate.toFixed(1)}%</div><div class="text-xs text-gray-500 mt-1">${completadasATiempo.length} de ${completadas.length} completadas a tiempo</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Velocidad de Completaci√≥n (Hist√≥rico)</div><div class="text-2xl font-bold text-gray-900 flex items-baseline gap-1">${avgCompletionSpeed.toFixed(1)} <span class="text-lg font-medium text-gray-500">d√≠as</span></div><div class="text-xs text-gray-500 mt-1">Recibida ‚Üí Completada (${completadasConTiempo.length} √≥rdenes)</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Throughput Semanal</div><div class="text-2xl font-bold text-gray-900 flex items-baseline gap-1">${weeklyThroughput} <span class="text-lg font-medium text-gray-500">√≥rd/sem</span></div><div class="text-xs text-gray-500 mt-1">√öltimos 30 d√≠as (${completadasRecientes.length} completadas)</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Capacidad Utilizada</div><div class="text-2xl font-bold ${capacityClass}">${capacityUsed.toFixed(0)}%</div><div class="text-xs text-gray-500 mt-1">${currentActivePieces.toLocaleString()} pzs / ~${estimatedCapacity.toFixed(0)} cap. pzs/sem</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Pico de Carga (Activas)</div><div class="text-2xl font-bold text-gray-900 truncate" title="${topClient ? escapeHTML(topClient[0]) : '-'}">${topClient ? escapeHTML(topClient[0]) : '-'}</div><div class="text-xs text-gray-500 mt-1">${topClient ? topClient[1].toLocaleString() : '0'} piezas activas</div></div>
                        <div class="bg-white rounded-lg shadow-lg p-5 border border-gray-200"><div class="text-sm font-medium text-gray-500 mb-1">Tendencia Semanal (Recibidas)</div><div class="text-2xl font-bold text-gray-900 flex items-center gap-2">${receivedThisWeek} <span class="text-2xl font-bold ${trendClass}">${trendArrow}</span></div><div class="text-xs text-gray-500 mt-1">${receivedLastWeek} la semana pasada</div></div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Top 5 Estilos (Carga Activa)</h3>
                    <div class="report-list max-h-52 overflow-y-auto mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                        ${top5Styles.length > 0 ? top5Styles.map(([style, pieces]) => `<div class="report-item flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0 text-sm"><span class="text-gray-700">${escapeHTML(style)}</span><strong class="font-medium text-gray-900">${pieces.toLocaleString()} pzs</strong></div>`).join('') : '<p class="text-gray-500 text-center py-8">No hay carga activa para mostrar.</p>'}
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Visualizaci√≥n de Carga Activa (Solo P_Art)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="chart-container h-72 bg-white rounded-lg shadow-lg p-4 border border-gray-200"><canvas id="designerDoughnutChartCanvas"></canvas></div>
                        <div class="chart-container h-72 bg-white rounded-lg shadow-lg p-4 border border-gray-200"><canvas id="designerBarChartCanvas"></canvas></div>
                        <div class="chart-container md:col-span-2 h-72 bg-white rounded-lg shadow-lg p-4 border border-gray-200"><canvas id="designerActivityChartCanvas"></canvas></div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">√ìrdenes Asignadas (P_Art)</h3>
                    <div class="designer-filter-section grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                        <div class="filter-item md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Buscar (Cliente, C√≥digo, Estilo):</label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></div>
                                <input type="text" id="designerSearchInput" class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="filter-item">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Orden:</label>
                            <select id="designerStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">Todos</option>
                                ${CUSTOM_STATUS_OPTIONS.map(s => `<option value="${escapeHTML(s)}">${escapeHTML(s)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                            <select id="designerClienteFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">Todos</option>
                                ${[...new Set(allDesignerOrders.map(o => o.cliente))].sort().map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('')}
                            </select>
                        </div>
                        <button class="font-medium py-2 px-4 rounded-lg text-sm transition-colors shadow-sm bg-white text-red-600 border border-red-300 hover:bg-red-50 flex items-center justify-center gap-2 h-10 mt-auto" id="designerClearFiltersBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                            Limpiar
                        </button>
                    </div>
                    <div id="designerOrdersTableContainer"></div>
                `;
                renderDesignerOrdersTable(designerName); 
                initDesignerCharts(designerOrders, allDesignerOrders); 
                document.getElementById('designerSearchInput').addEventListener('input', debounce((e) => {
                    currentDesignerTableFilter.search = e.target.value;
                    renderDesignerOrdersTable(designerName);
                }, 300));
                document.getElementById('designerStatusFilter').addEventListener('change', (e) => {
                    currentDesignerTableFilter.estado = e.target.value;
                    renderDesignerOrdersTable(designerName);
                });
                document.getElementById('designerClienteFilter').addEventListener('change', (e) => {
                    currentDesignerTableFilter.cliente = e.target.value;
                    renderDesignerOrdersTable(designerName);
                });
                document.getElementById('designerClearFiltersBtn').addEventListener('click', () => {
                    currentDesignerTableFilter = { search: '', cliente: '', estado: '', fechaDesde: '', fechaHasta: '' };
                    document.getElementById('designerSearchInput').value = '';
                    document.getElementById('designerStatusFilter').value = '';
                    document.getElementById('designerClienteFilter').value = '';
                    renderDesignerOrdersTable(designerName);
                });
            } catch (error) {
                console.error("Error generando m√©tricas:", error);
                showCustomAlert(`Error al generar m√©tricas: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function renderDesignerOrdersTable(designerName) {
            const container = document.getElementById('designerOrdersTableContainer');
            if (!container) return;
            const isUnassigned = designerName === 'Sin asignar';
            let designerOrders = allOrders.filter(o => {
                return (isUnassigned ? (o.designer === '' || !o.designer) : (o.designer === designerName)) && o.departamento === 'P_Art';
            });
            const { search, cliente, estado } = currentDesignerTableFilter;
            designerOrders = applySearchFilter(designerOrders, search, ['cliente', 'codigoContrato', 'estilo']);
            designerOrders = applyMultipleFilters(designerOrders, { cliente: cliente, customStatus: estado });
            const filterSummary = document.createElement('div');
            filterSummary.className = "p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4 text-sm text-gray-600";
            filterSummary.innerHTML = `Mostrando <strong class="text-blue-600 font-semibold">${designerOrders.length}</strong> ${designerOrders.length === 1 ? 'orden' : '√≥rdenes'} ${(search || cliente || estado) ? ' (filtradas)' : ''}`;
            container.innerHTML = '';
            container.appendChild(filterSummary);
            let tableHTML = `
                <div class="table-container rounded-lg border border-gray-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Despacho</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estilo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado Orden</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Piezas</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            if (designerOrders.length === 0) {
                tableHTML += '<tr><td colspan="7" class="text-center text-gray-500 py-12">No hay √≥rdenes que coincidan con los filtros.</td></tr>';
            } else {
                designerOrders.sort((a,b) => (a.fechaDespacho || 0) - (b.fechaDespacho || 0));
                for (const order of designerOrders) {
                    const totalOrderPieces = (order.cantidad || 0) + (order.childPieces || 0);
                    tableHTML += `
                        <tr class="cursor-pointer ${order.isVeryLate?'very-late':order.isLate?'late':order.isAboutToExpire?'expiring':''}" onclick="openAssignModal('${order.orderId}')">
                            <td class="px-4 py-3 whitespace-nowrap">${getStatusBadge(order)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${formatDate(order.fechaDespacho)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 font-medium">${escapeHTML(order.cliente)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                ${escapeHTML(order.codigoContrato)}
                                ${order.childPieces > 0 ? `<span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-medium mt-1 inline-block flex items-center gap-1 w-fit"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg></span>` : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHTML(order.estilo)}</td>
                            <td class="px-4 py-3 whitespace-nowrap">${getCustomStatusBadge(order.customStatus)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600 font-bold">${totalOrderPieces.toLocaleString()}</td>
                        </tr>
                    `;
                }
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML += tableHTML;
        }

        function initDesignerCharts(designerOrders, allDesignerOrders) {
            function getTailwindColor(name, fallback) {
                try {
                    if (name.includes('.')) {
                        const parts = name.split('.'); let color = tailwind.config.theme.colors;
                        for (const part of parts) { color = color[part]; } return color || fallback;
                    }
                    if (tailwind.config.theme.extend.colors[name]) { return tailwind.config.theme.extend.colors[name] || fallback; }
                    if (tailwind.config.theme.colors[name]) { return tailwind.config.theme.colors[name] || fallback; }
                    return fallback;
                } catch (e) { console.warn(`Error al leer el color de Tailwind '${name}'. Usando fallback ${fallback}.`, e); return fallback; }
            }
            const colorBandeja = getTailwindColor('chart-bandeja', '#F59E0B');
            const colorProduccion = getTailwindColor('chart-produccion', '#8B5CF6');
            const colorAuditoria = getTailwindColor('chart-auditoria', '#3B82F6');
            const colorSinEstado = getTailwindColor('chart-sin-estado', '#6B7280');
            const colorBorder = getTailwindColor('white', '#FFFFFF');
            const colorText = getTailwindColor('gray.500', '#6B7280');
            const colorTextTitle = getTailwindColor('gray.800', '#1F2937');
            const chartColors = [ colorBandeja, colorProduccion, colorAuditoria, colorSinEstado ];
            const chartLabels = ['Bandeja', 'Producci√≥n', 'Auditor√≠a', 'Sin estado'];
            const statusCounts = { 'Bandeja': 0, 'Producci√≥n': 0, 'Auditor√≠a': 0, 'Sin estado': 0 };
            designerOrders.forEach(o => { statusCounts[o.customStatus || 'Sin estado']++; });
            const doughnutData = {
                labels: chartLabels,
                datasets: [{
                    label: '√ìrdenes Activas',
                    data: [ statusCounts['Bandeja'], statusCounts['Producci√≥n'], statusCounts['Auditor√≠a'], statusCounts['Sin estado'] ],
                    backgroundColor: chartColors,
                    borderColor: colorBorder,
                    borderWidth: 2
                }]
            };
            const doughnutCtx = document.getElementById('designerDoughnutChartCanvas')?.getContext('2d');
            if (doughnutCtx) {
                designerDoughnutChart = new Chart(doughnutCtx, {
                    type: 'doughnut', data: doughnutData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 10, family: 'Inter' }, color: colorText } },
                            title: { display: true, text: 'Distribuci√≥n de √ìrdenes Activas', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle },
                            tooltip: { callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw || 0; const total = context.chart.getDatasetMeta(0).total; if (total === 0) return `${label}: 0 (0%)`; const percentage = ((value / total) * 100).toFixed(1); return `${label}: ${value} (${percentage}%)`; } } }
                        }
                    }
                });
            }
            const piecesCounts = { 'Bandeja': 0, 'Producci√≥n': 0, 'Auditor√≠a': 0, 'Sin estado': 0 };
            designerOrders.forEach(o => {
                const totalPieces = (o.cantidad || 0) + (o.childPieces || 0);
                piecesCounts[o.customStatus || 'Sin estado'] += totalPieces;
            });
            const barData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Piezas Activas (Padre + Hijas)',
                    data: [ piecesCounts['Bandeja'], piecesCounts['Producci√≥n'], piecesCounts['Auditor√≠a'], piecesCounts['Sin estado'] ],
                    backgroundColor: chartColors,
                    borderColor: colorBorder,
                    borderWidth: 1
                }]
            };
            const barCtx = document.getElementById('designerBarChartCanvas')?.getContext('2d');
            if(barCtx) {
                designerBarChart = new Chart(barCtx, {
                    type: 'bar', data: barData,
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Carga de Piezas Activas', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle }
                        },
                        scales: {
                            x: { beginAtZero: true, title: { display: true, text: 'Cantidad de Piezas', font: { size: 10, family: 'Inter' }, color: colorText }, ticks: { color: colorText, font: { family: 'Inter' } } },
                            y: { ticks: { font: { size: 10, family: 'Inter' }, color: colorText } }
                        }
                    }
                });
            }
            const weeklyActivity = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - (i * 7) - today.getDay() + 1);
                weekStart.setHours(0, 0, 0, 0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                const weekLabel = `Sem ${weekStart.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}`;
                const completedInWeek = allDesignerOrders.filter(o => {
                    if (!o.completedDate) return false;
                    try { const completedDate = new Date(o.completedDate); return completedDate >= weekStart && completedDate <= weekEnd; } catch(e) { return false; }
                }).length;
                weeklyActivity[weekLabel] = completedInWeek;
            }
            const activityCtx = document.getElementById('designerActivityChartCanvas')?.getContext('2d');
            if (activityCtx) {
                designerActivityChart = new Chart(activityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(weeklyActivity),
                        datasets: [{
                            label: '√ìrdenes Completadas',
                            data: Object.values(weeklyActivity),
                            backgroundColor: Object.values(weeklyActivity).map(val => {
                                if (val === 0) return getTailwindColor('gray.300', '#D1D5DB');
                                if (val < 3) return getTailwindColor('yellow.500', '#F59E0B');
                                if (val < 6) return getTailwindColor('blue.500', '#3B82F6');
                                return getTailwindColor('green.500', '#22C55E');
                            }),
                            borderColor: getTailwindColor('gray.300', '#D1D5DB'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Actividad Semanal (√ìrdenes Completadas, √ölt. 8 Semanas)', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle }
                        },
                        scales: {
                            x: { beginAtZero: true, ticks: { stepSize: 1, color: colorText, font: { family: 'Inter' } }, title: { display: true, text: '√ìrdenes Completadas', font: { size: 10, family: 'Inter' }, color: colorText } },
                            y: { ticks: { color: colorText, font: { family: 'Inter' } } }
                        }
                    }
                });
            }
        }
        
        // --- L√≥gica de Comparaci√≥n (Original, pero lee de 'allOrders' fusionado) ---
        function openCompareModal(designerName1) {
            currentCompareDesigner1 = designerName1;
            document.getElementById('compareDesigner1Name').textContent = designerName1;
            const select = document.getElementById('compareDesignerSelect');
            select.innerHTML = '<option value="">Selecciona uno...</option>';
            const designersToCompare = designerList.filter(d => d !== designerName1);
            designersToCompare.forEach(name => {
                const safeName = escapeHTML(name);
                select.innerHTML += `<option value="${safeName}">${safeName}</option>`;
            });
            document.getElementById('selectCompareModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        function closeCompareModals() {
            document.getElementById('selectCompareModal').classList.remove('active');
            document.getElementById('compareModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            if (compareChart) {
                compareChart.destroy();
                compareChart = null;
            }
            currentCompareDesigner1 = '';
        }
        function startComparison() {
            const designerName2 = document.getElementById('compareDesignerSelect').value;
            if (!designerName2) {
                showCustomAlert('Por favor, selecciona un dise√±ador para comparar.', 'error');
                return;
            }
            if (!currentCompareDesigner1) {
                showCustomAlert('Error: Dise√±ador 1 no encontrado.', 'error');
                closeCompareModals();
                return;
            }
            generateCompareReport(currentCompareDesigner1, designerName2);
        }
        function generateCompareReport(name1, name2) {
            try {
                const pArtOrders = allOrders.filter(o => o.departamento === 'P_Art');
                const orders1 = pArtOrders.filter(o => o.designer === name1);
                const orders2 = pArtOrders.filter(o => o.designer === name2);
                const allOrders1 = allOrders.filter(o => o.designer === name1);
                const allOrders2 = allOrders.filter(o => o.designer === name2);
                const stats1 = calculateStats(orders1);
                const t1_completadas = allOrders1.filter(o => o.customStatus === 'Completada');
                const t1_aTiempo = t1_completadas.filter(o => !o.isLate).length;
                const t1_tasa = t1_completadas.length > 0 ? (t1_aTiempo / t1_completadas.length) * 100 : 0;
                const t1_bandeja = orders1.filter(o => o.customStatus === 'Bandeja').length;
                const t1_produccion = orders1.filter(o => o.customStatus === 'Producci√≥n').length;
                const stats2 = calculateStats(orders2);
                const t2_completadas = allOrders2.filter(o => o.customStatus === 'Completada');
                const t2_aTiempo = t2_completadas.filter(o => !o.isLate).length;
                const t2_tasa = t2_completadas.length > 0 ? (t2_aTiempo / t2_completadas.length) * 100 : 0;
                const t2_bandeja = orders2.filter(o => o.customStatus === 'Bandeja').length;
                const t2_produccion = orders2.filter(o => o.customStatus === 'Producci√≥n').length;
                const tableContainer = document.getElementById('compareTableContainer');
                tableContainer.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">M√©trica</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-blue-600">${escapeHTML(name1)}</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-yellow-600">${escapeHTML(name2)}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">Total √ìrdenes (P_Art)</td><td class="value-a px-6 py-4 text-sm">${stats1.total}</td><td class="value-b px-6 py-4 text-sm">${stats2.total}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">Total Piezas (P_Art)</td><td class="value-a px-6 py-4 text-sm">${stats1.totalPieces.toLocaleString()}</td><td class="value-b px-6 py-4 text-sm">${stats2.totalPieces.toLocaleString()}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">√ìrdenes Atrasadas</td><td class="value-a px-6 py-4 text-sm">${stats1.late}</td><td class="value-b px-6 py-4 text-sm">${stats2.late}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">√ìrdenes por Vencer</td><td class="value-a px-6 py-4 text-sm">${stats1.aboutToExpire}</td><td class="value-b px-6 py-4 text-sm">${stats2.aboutToExpire}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">En Bandeja</td><td class="value-a px-6 py-4 text-sm">${t1_bandeja}</td><td class="value-b px-6 py-4 text-sm">${t2_bandeja}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">En Producci√≥n</td><td class="value-a px-6 py-4 text-sm">${t1_produccion}</td><td class="value-b px-6 py-4 text-sm">${t2_produccion}</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-medium text-gray-900">Tasa Cumplimiento (Hist.)</td><td class="value-a px-6 py-4 text-sm">${t1_tasa.toFixed(1)}%</td><td class="value-b px-6 py-4 text-sm">${t2_tasa.toFixed(1)}%</td></tr>
                        </tbody>
                    </table>
                `;
                if (compareChart) { compareChart.destroy(); }
                const safeColor = (name, fallback) => {
                    try {
                        if (name.includes('.')) { const parts = name.split('.'); let color = tailwind.config.theme.colors; for (const part of parts) { color = color[part]; } return color || fallback; }
                        return tailwind.config.theme.colors[name] || fallback;
                    } catch(e) { return fallback; }
                };
                const colorText = safeColor('gray.500', '#6B7280');
                const colorTextTitle = safeColor('gray.800', '#1F2937');
                const compareCtx = document.getElementById('compareChartCanvas').getContext('2d');
                compareChart = new Chart(compareCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Total Piezas', 'Atrasadas', 'En Bandeja', 'En Producci√≥n'],
                        datasets: [
                            { label: name1, data: [stats1.totalPieces, stats1.late, t1_bandeja, t1_produccion], backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 },
                            { label: name2, data: [stats2.totalPieces, stats2.late, t2_bandeja, t2_produccion], backgroundColor: 'rgba(245, 158, 11, 0.7)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { family: 'Inter' }, color: colorText } },
                            title: { display: true, text: 'Comparativa de Carga Activa (P_Art)', font: { size: 12, family: 'Inter', weight: '600' }, color: colorTextTitle }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: colorText, font: { family: 'Inter' } } },
                            x: { ticks: { color: colorText, font: { family: 'Inter' } } }
                        }
                    }
                });
                document.getElementById('selectCompareModal').classList.remove('active');
                document.getElementById('compareModal').classList.add('active');
                document.body.classList.add('modal-open');
            } catch (error) {
                console.error("Error generando comparaci√≥n:", error);
                showCustomAlert(`Error al comparar: ${error.message}`, 'error');
                closeCompareModals();
            }
        }
    </script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Arte v5.2 (Lite)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="estilos.css">
    <style>
        /* Estilos extra para asegurar el dise√±o */
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">

    <div id="loginSection" class="max-w-md mx-auto my-20 bg-white rounded-lg shadow-xl p-8 text-center">
        <svg class="w-16 h-16 mx-auto text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.333-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Panel de Control - Arte v5.2</h1>
        <p class="text-gray-600 mb-8">Por favor, inicia sesi√≥n con tu cuenta de Google.</p>
        <button id="loginButton" class="w-full inline-flex justify-center items-center gap-3 bg-blue-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-sm cursor-pointer">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
            Iniciar Sesi√≥n con Google
        </button>
    </div>

    <div id="uploadSection" class="max-w-3xl mx-auto my-12 bg-white rounded-lg shadow-xl p-8 text-center" style="display: none;">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Paso 2: Cargar Archivo Excel</h1>
        <p class="text-gray-600 mb-8">Sube tu archivo Excel "Working Process All" para sincronizar.</p>
        
        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 cursor-pointer bg-gray-50 hover:bg-gray-100 hover:border-blue-500 transition-colors">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Arrastra tu archivo aqu√≠</h3>
            <p class="text-sm text-gray-500 mb-4">o</p>
            <label for="fileInput">
                <span class="mt-4 inline-block bg-indigo-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm cursor-pointer">Seleccionar Archivo</span>
            </label>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>
        <div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6 text-left">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">‚ú® v5.2 (Lite)</h4>
            <ul class="text-sm text-gray-600 list-disc list-inside space-y-2">
                <li>‚òÅÔ∏è Base de Datos en la Nube (Firebase).</li>
                <li>‚ö° Sincronizaci√≥n en tiempo real.</li>
                <li>‚úÖ Versi√≥n optimizada.</li>
            </ul>
        </div>
    </div>

    <div id="dashboard" class="container mx-auto px-4 py-8" style="display: none;">
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Panel de Control - Arte v5.2</h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span id="fileName"></span>
                    <span id="dbStatus" class="ml-3 font-medium text-gray-500">Conectando...</span>
                    <span class="ml-3">Hola, <span id="userName" class="font-bold text-gray-900">Usuario</span></span>
                    <button id="logoutButton" class="ml-4 text-xs font-medium text-red-600 hover:underline cursor-pointer">(Cerrar Sesi√≥n)</button>
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button class="font-medium py-2 px-4 rounded-lg text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center gap-2" onclick="openDesignerManager()">
                    Gestionar Dise√±adores
                </button>
                <button class="font-medium py-2 px-4 rounded-lg text-sm bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-2 shadow-sm" onclick="exportToPDF()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Exportar PDF
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <div class="text-gray-500 text-sm font-medium uppercase">Total Pedidos</div>
                <div class="text-3xl font-bold text-gray-900 mt-2" id="kpiTotal">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <div class="text-gray-500 text-sm font-medium uppercase">Completados</div>
                <div class="text-3xl font-bold text-gray-900 mt-2" id="kpiCompleted">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                <div class="text-gray-500 text-sm font-medium uppercase">En Proceso</div>
                <div class="text-3xl font-bold text-gray-900 mt-2" id="kpiPending">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
                <div class="text-gray-500 text-sm font-medium uppercase">Pendientes / Retrasados</div>
                <div class="text-3xl font-bold text-gray-900 mt-2" id="kpiDelayed">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Estatutos de Pedidos</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Carga por Dise√±ador</h3>
                <div class="chart-container">
                    <canvas id="designerChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Detalle de Pedidos</h3>
                <span class="text-xs text-gray-500">Mostrando primeros 50 registros</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="dataTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dise√±ador</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">
                                Carga un archivo Excel para visualizar los datos aqu√≠.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="designerModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 50;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white animate-fade-in-down">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Gestionar Dise√±adores</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Agrega o edita la lista de dise√±adores activos.</p>
                    <textarea class="w-full border border-gray-300 rounded p-2 mt-2 h-24 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ej: Juan Perez, Maria Lopez..."></textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModal" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN DE FIREBASE ---
        // Si no tienes las claves ahora, la app funcionar√° en modo "Demo" (Frontend puro).
        // Cuando tengas tu proyecto Firebase, pega las claves aqu√≠.
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "TU_APP_ID"
        };

        let auth, db;
        let isFirebaseActive = false;

        // Intentar inicializar Firebase
        try {
            if (firebaseConfig.apiKey !== "TU_API_KEY_AQUI") {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseActive = true;
                console.log("‚úÖ Firebase inicializado correctamente.");
            } else {
                console.log("‚ö†Ô∏è Modo Demo: Firebase no configurado (clave por defecto detectada).");
            }
        } catch (e) {
            console.error("Error iniciando Firebase:", e);
        }

        // --- 2. VARIABLES GLOBALES ---
        let globalData = [];
        let charts = {}; // Almacena las instancias de los gr√°ficos

        // --- 3. REFERENCIAS DOM ---
        const loginSection = document.getElementById('loginSection');
        const uploadSection = document.getElementById('uploadSection');
        const dashboard = document.getElementById('dashboard');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        // --- 4. MANEJO DE SESI√ìN (LOGIN) ---
        document.getElementById('loginButton').addEventListener('click', () => {
            if (isFirebaseActive) {
                // Login Real con Google
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then(result => handleLoginSuccess(result.user))
                    .catch(error => alert("Error Login: " + error.message));
            } else {
                // Login Simulado (Demo)
                handleLoginSuccess({ displayName: 'Administrador (Demo)' });
            }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            if (isFirebaseActive) firebase.auth().signOut();
            window.location.reload();
        });

        function handleLoginSuccess(user) {
            document.getElementById('userName').textContent = user.displayName || "Usuario";
            
            // Transici√≥n de pantallas
            loginSection.style.display = 'none';
            uploadSection.style.display = 'block';
            
            // Actualizar indicador de estado
            const statusElem = document.getElementById('dbStatus');
            if(isFirebaseActive) {
                statusElem.textContent = "üü¢ Conectado a Nube";
                statusElem.classList.replace('text-gray-500', 'text-green-600');
            } else {
                statusElem.textContent = "üü† Modo Local";
                statusElem.classList.replace('text-gray-500', 'text-orange-500');
            }
        }

        // --- 5. L√ìGICA DE ARRASTRAR Y SOLTAR (DRAG & DROP) ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if(files.length) handleFileUpload(files[0]);
        });

        // Evento Input Tradicional
        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length) handleFileUpload(e.target.files[0]);
        });

        // --- 6. PROCESAMIENTO DE EXCEL ---
        function handleFileUpload(file) {
            document.getElementById('fileName').textContent = `üìÇ Archivo: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Leemos la primera hoja del Excel
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertimos a JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Procesamos los datos para el dashboard
                processData(jsonData);
                
                // Cambiamos la vista al Dashboard
                uploadSection.style.display = 'none';
                dashboard.style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 7. AN√ÅLISIS DE DATOS Y RENDERIZADO ---
        function processData(data) {
            globalData = data;
            
            // Contadores Iniciales
            let total = data.length;
            let completed = 0;
            let pending = 0;
            let delayed = 0;
            
            // Almacenes para gr√°ficos
            const statusCounts = {};
            const designerCounts = {};

            data.forEach(row => {
                // NOTA: Intentamos buscar nombres de columnas en ingl√©s Y espa√±ol
                // para que el c√≥digo sea robusto.
                const statusRaw = row['Status'] || row['Estado'] || row['STATUS'] || 'Desconocido';
                const designerRaw = row['Designer'] || row['Dise√±ador'] || row['DESIGNER'] || 'Sin Asignar';
                
                const status = String(statusRaw).trim();
                const designer = String(designerRaw).trim();

                // L√≥gica de conteo de KPIs (Puedes personalizar las palabras clave)
                const statusLower = status.toLowerCase();
                if(statusLower.includes('listo') || statusLower.includes('entregado') || statusLower.includes('done')) {
                    completed++;
                } else if (statusLower.includes('proceso') || statusLower.includes('working') || statusLower.includes('pendiente')) {
                    pending++;
                } else {
                    delayed++; // Asumimos el resto como pendientes o problemas
                }

                // Agrupaci√≥n para Gr√°ficos
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                // Filtramos dise√±adores vac√≠os
                if(designer && designer !== 'undefined') {
                    designerCounts[designer] = (designerCounts[designer] || 0) + 1;
                }
            });

            // Actualizar n√∫meros en pantalla (Animaci√≥n simple cambiando texto)
            document.getElementById('kpiTotal').textContent = total;
            document.getElementById('kpiCompleted').textContent = completed;
            document.getElementById('kpiPending').textContent = pending;
            document.getElementById('kpiDelayed').textContent = delayed;

            // Renderizar componentes visuales
            renderCharts(statusCounts, designerCounts);
            renderTable(data);
        }

        // --- 8. CONFIGURACI√ìN DE GR√ÅFICOS (CHART.JS) ---
        function renderCharts(statusData, designerData) {
            // Destruir gr√°ficos previos para evitar bugs al cargar nuevo archivo
            if(charts.status) charts.status.destroy();
            if(charts.designer) charts.designer.destroy();

            // 1. Gr√°fico de Dona (Estados)
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 2. Gr√°fico de Barras (Dise√±adores)
            const ctxDesigner = document.getElementById('designerChart').getContext('2d');
            charts.designer = new Chart(ctxDesigner, {
                type: 'bar',
                data: {
                    labels: Object.keys(designerData),
                    datasets: [{
                        label: 'Pedidos Asignados',
                        data: Object.values(designerData),
                        backgroundColor: '#6366F1',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- 9. RENDERIZADO DE TABLA ---
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Renderizamos solo los primeros 50 para mantener el navegador r√°pido
            const displayData = data.slice(0, 50);

            displayData.forEach(row => {
                const id = row['ID'] || row['Order'] || row['Orden'] || '#';
                const client = row['Client'] || row['Cliente'] || '-';
                const desc = row['Description'] || row['Descripci√≥n'] || row['Item'] || '-';
                const designer = row['Designer'] || row['Dise√±ador'] || 'N/A';
                const status = row['Status'] || row['Estado'] || '-';
                
                // Manejo de fecha de Excel (n√∫mero serial) o string normal
                let dateStr = row['Date'] || row['Fecha'] || '-';
                if(typeof dateStr === 'number') {
                    // Conversi√≥n b√°sica de fecha Excel si es necesario
                    const date = new Date((dateStr - (25567 + 2))*86400*1000); 
                    dateStr = date.toLocaleDateString();
                }

                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50', 'transition-colors');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs" title="${desc}">${desc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                            ${designer}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${getStatusBadge(status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Helper para colores de estado en la tabla
        function getStatusBadge(status) {
            const s = String(status).toLowerCase();
            let colorClass = 'bg-gray-100 text-gray-800'; // Default
            
            if(s.includes('listo') || s.includes('done')) colorClass = 'bg-green-100 text-green-800';
            else if(s.includes('pendiente') || s.includes('process')) colorClass = 'bg-yellow-100 text-yellow-800';
            else if(s.includes('error') || s.includes('retraso')) colorClass = 'bg-red-100 text-red-800';
            
            return `<span class="px-2 py-1 rounded-md text-xs font-medium ${colorClass}">${status}</span>`;
        }

        // --- 10. MODALES Y EXPORTACI√ìN ---
        function openDesignerManager() {
            document.getElementById('designerModal').classList.remove('hidden');
        }

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('designerModal').classList.add('hidden');
        });

        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modal = document.getElementById('designerModal');
            if (event.target == modal) {
                modal.classList.add('hidden');
            }
        }

        function exportToPDF() {
            if(globalData.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text("Reporte de Estado - Arte v5.2", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleString()}`, 14, 22);

            const headers = [['ID', 'Cliente', 'Descripci√≥n', 'Dise√±ador', 'Estado']];
            
            const tableData = globalData.map(row => [
                String(row['ID'] || row['Order'] || ''),
                String(row['Client'] || row['Cliente'] || ''),
                String(row['Description'] || row['Descripci√≥n'] || '').substring(0, 20) + '...', // Cortar texto largo
                String(row['Designer'] || row['Dise√±ador'] || ''),
                String(row['Status'] || row['Estado'] || '')
            ]);

            doc.autoTable({
                head: headers,
                body: tableData,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 8 }
            });

            doc.save('Reporte_Arte_v5.2.pdf');
        }
    </script>
</body>
</html>